
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>amneziawg-тонкая-настройка-заказные-маршруты</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>alk2ntc(Alk2ntc)</td><td><p>Надеюсь, сообществу хорошо известно средство, позволяющее получать доступ к недоступным сайтам. Это вариант Amnezia VPN, скрещенный с WireGuard. Работает, используя обфускацию.<br>
Чтобы попробовать, требуется загрузить клиент, я использую Windows, например, с <a href="https://github.com/amnezia-vpn/amneziawg-windows-client/releases/tag/1.0.0" rel="noopener nofollow ugc">github</a> и сгенерировать конфиг-файл.<br>
Тут наиболее простой путь это страница <a href="https://warp.llimonix.pw/" rel="noopener nofollow ugc">Генерация конфигурации WARP</a><br>
После сохранения файла я заинтересовался, откуда там берется адрес Endpoint и можно ли использовать другой.<br>
Выяснилось, что есть множество инструментов для проверки подходящих комбинаций адрес:порт.<br>
В частности, прекрасное средство, позволяющее подобрать оптимальный (наиболее быстрый) Endpoint для клиента, можно взять <a href="https://github.com/peanut996/CloudflareWarpSpeedTest" rel="noopener nofollow ugc">здесь</a><br>
Нашлась масса адресов с минимальными задержками, и все они работают в AmneziaWG, достаточно только поменять адрес и порт в конфиге. Пробуйте.<br>
Вторая вещь, сразу вызвавшая вопросы, это маршруты. По умолчанию, в туннель уходит всё (0.0.0.0/0) плюс собственные CF DNSы делают невозможной работу в корпоративной доменной сети.<br>
С маршрутами все оказалось не так страшно, даже с учетом довольно ограниченных возможностей конфига WG, где можно создавать только AllowedIPs.<br>
Здесь нашлась такая страница <a href="https://github.com/llimonix/warp-allowedips-list" rel="noopener nofollow ugc">llimonix/warp-allowedips-list: Список IP адресов для WARP конфигов</a>, где можно скопировать и добавить в заказной конфиг диапазон ip-адресов для доступа к конкретным ресурсам.<br>
Можно использовать <a href="https://www.procustodibus.com/blog/2021/03/wireguard-allowedips-calculator/" rel="noopener nofollow ugc">онлайн генератор</a> AllowedIPs, позволяющий исключить определенные маршруты из AllowedIPs<br>
В целом, вполне годная оказалась связка. Я проверял помимо Windows еще и на iOS, там все точно также, AmneziaWG пока в AppStore присутствует.<br>
Единственный недостаток - под Windows AmneziaWG требует для запуска программы права администратора, там на лету создается туннельный сетевой адаптер, по которому и направляется трафик. Я поискал и обнаружил, что бывает вариант <a href="https://github.com/DrEm-s/wireguard-windows-portable" rel="noopener nofollow ugc">portable Wireguard</a>. Вот бы такое же сделать для AmneziaWG</p></td><td>2024-12-27T12:17:36.836Z</td></tr><tr><td>alk2ntc(Alk2ntc)</td><td><p>Обнаружилось интересное продолжение темы.<br>
AmneziaWG умеет работать не только с серверами CloudFlare, но и с Proton VPN.<br>
Да, Proton VPN использует WireGuard, а этот протокол блокируется DPI и ничего не работает.<br>
Но не совсем. Тот же трюк с параметрами обфускации в конфиге позволяет преодолеть блокировку.<br>
Достаточно, зайдя в свой аккаунт на <a href="http://proton.me" rel="noopener nofollow ugc">proton.me</a> (например, используя zapret или AmneziWG через CF) перейти в раздел Proton VPN и выбрать слева самый нижний пункт меню WireGuard.<br>
Справа появится экран, где можно ввести название конфига, выбрать, для какого устройства он создается, а далее прокручивать экран вниз для выбора страны и конкретного сервера для подключения. В бесплатном тарифе доступны сервера в Японии, Нидерландах и США. Предлагается наименее загруженный, но можно выбрать любой из списка и нажать справа клавишу Create. Будет загружен conf-файл на компьютер. Его нужно слегка исправить, добавить в секцию Interface строчки с параметрами обфускации, например, такими:<br>
S1 = 0<br>
S2 = 0<br>
Jc = 120<br>
Jmin = 23<br>
Jmax = 911<br>
H1 = 1<br>
H2 = 2<br>
H3 = 3<br>
H4 = 4<br>
Сохраняем файл. Подгружаем его в клиент AmneziaWG и подключаем. Через несколько секунд получаем туннель в ту страну, сервер которой выбрали. Убеждаемся в этом, зайдя на сайт <a href="http://ip.me" rel="noopener nofollow ugc">ip.me</a> или аналогичный.<br>
Вышеописанные вариации с разделением туннелей здесь точно также доступны.</p></td><td>2025-01-13T14:10:03.644Z</td></tr><tr><td>azat_b</td><td><p>Проверил на роутере - да, работает.</p></td><td>2025-01-13T17:35:17.444Z</td></tr><tr><td>Radiquum(Kentai Radiquum)</td><td><p>С протоном правда тоже работает, спасибо.<br>
Получается в теории это тогда должно работать в принципе с любым конфигом wireguard, даже если он создан через тот же wg-easy.</p></td><td>2025-01-25T14:48:27.749Z</td></tr><tr><td>alk2ntc(Alk2ntc)</td><td><p>У меня с Протоном работать переставало, после тщательных поисков и находок <a href="https://github.com/amnezia-vpn/amneziawg-linux-kernel-module#configuration" rel="noopener nofollow ugc">параметров обфускации</a> выяснилось, что заработало с несколько модифицированными параметрами. На РТ Москва Протон начал работать при Jc=5, Jmin=50, Jmax=1000.<br>
Для чистоты эксперимента стоит проверить, имеется ли в списке текущих протоновских серверов тот, для которого вы создавали конфиг, они там исчезают и появляются.</p></td><td>2025-01-25T15:16:10.028Z</td></tr><tr><td>azat_b</td><td><p>Правильно понимаю, что параметры S1, S2, H1, H2, H3, H4 надо оставить 0, 0, 1, 2, 3, 4 соответственно?<br>
Я пробовал менять эти значения и подключения не устанавливались.</p></td><td>2025-01-26T12:36:33.343Z</td></tr><tr><td>alk2ntc(Alk2ntc)</td><td><p><a href="https://habr.com/ru/companies/amnezia/articles/807539/" rel="noopener nofollow ugc">Инструкции</a> от создателей AmneziaWG говорят, что их надо оставить такими, хотя документ на гитхабе (см. ссылку выше) рассказывает о том, какими они могут быть и какими не могут.<br>
Еще обратите внимание, что бесплатный аккаунт на Протоне ограничен одним подключением, то есть с одним и тем же аккаунтом на телефоне и на компьютере подключиться одновременно не удастся</p></td><td>2025-01-26T13:00:29.256Z</td></tr>
    </table>
      </body>
    </html>