[
    {
        "id": 36065,
        "name": "",
        "username": "bolvan",
        "avatar_template": "/letter_avatar_proxy/v4/letter/b/8e8cbc/{size}.png",
        "created_at": "2024-08-27T06:35:56.641Z",
        "cooked": "<p>Может таковые найдутся.</p>\n<p>Вопрос касается реализации логики tcp proxy в tpws.<br>\ntcp proxy означает двустороннюю переброску данных между двумя tcp соединениями (local и remote leg).<br>\nВажно корректно закрывать соединения без потери неотосланных кусков данных, когда какой-то конец инициирует закрытие.<br>\nНо закрытие может быть разным. Это может быть close через FIN, close через RST и half-close - shutdown(SHUT_WR).</p>\n<p>Есть ли способ средствами epoll (да и не только ими) отличить состояние half close от close ?<br>\nЕсли закрывают с RST, приходит EPOLLERR, тут все ясно. connection reset by peer.<br>\nhalf close возникает, когда другой конец выполнил shutdown(SHUT_WR). В этом случае от него поступает tcp пакет с FIN, что не означает полное закрытие соединения. Ему еще можно досылать остаток данных.<br>\nВ этом случае приходит EPOLLRDHUP.<br>\nНо он же и приходит, когда другой конец закрыл сокет без неотосланных данных, без RST.</p>\n<p>В первом случае еще имеет смысл ожидать от другого конца прокси каких-то данных, во втором надо скорее уже их обоих кидать, как только все неотосланное будет отправлено.<br>\nТо, что сделано сейчас, при отсутствии ответа FIN с другой стороны приводит к подвисанию обоих концов - одного в состоянии FIN_WAIT, другого в состоянии CLOSE_WAIT до истечения fin-wait timeout.<br>\nЭто не смертельно, но если бы можно было закрывать поскорее, было бы лучше.</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 7,
        "updated_at": "2024-08-27T06:37:29.943Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 14,
        "reads": 57,
        "readers_count": 56,
        "score": 81.4,
        "yours": false,
        "topic_id": 9801,
        "topic_slug": "%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "Zapret anti-DPI software staff",
        "title_is_group": false,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": true,
        "admin": false,
        "staff": true,
        "user_id": 19,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll/9801/1",
        "can_translate": false
    },
    {
        "id": 36070,
        "name": null,
        "username": "serj888",
        "avatar_template": "/letter_avatar_proxy/v4/letter/s/f475e1/{size}.png",
        "created_at": "2024-08-27T07:53:46.103Z",
        "cooked": "<p>Как вариант настроить параметры conntrack_tcp_timeout уменьшить значения<br>\nconntrack_generic_timeout=60 по умолчанию 600<br>\nconntrack_tcp_timeout_close_wait=30 по умолчанию 60<br>\nconntrack_tcp_timeout_established=180 по умолчанию 7440<br>\nconntrack_tcp_timeout_fin_wait=30 по умолчанию 120<br>\nconntrack_tcp_timeout_syn_recv=30 по умолчанию 60<br>\nconntrack_tcp_timeout_syn_sent=60 по умолчанию 120<br>\nconntrack_tcp_timeout_time_wait=30 по умолчанию 120<br>\nconntrack_udp_timeout_stream=60 по умолчанию 120</p>\n<p>меньше ставить значение я не пробовал, но думаю некоторые можно ещё уменьшить<br>\nэто глобальные настройки для всех соединений, настраиваются через nftables или iptables<br>\nСамых 2 жестких параметра conntrack_generic_timeout и conntrack_tcp_timeout_established они жрут ресурсы и удерживают неактивное соединение</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 7,
        "updated_at": "2024-08-27T08:15:01.049Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 54,
        "readers_count": 53,
        "score": 20.8,
        "yours": false,
        "topic_id": 9801,
        "topic_slug": "%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll",
        "display_username": null,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 3,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 3388,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll/9801/2",
        "can_translate": false
    },
    {
        "id": 36091,
        "name": "",
        "username": "bolvan",
        "avatar_template": "/letter_avatar_proxy/v4/letter/b/8e8cbc/{size}.png",
        "created_at": "2024-08-27T09:50:09.856Z",
        "cooked": "<p>Вопрос был несколько о другом.</p>\n<p>Эти sysctl относятся к netfilter и conntrack, не к системе<br>\nconntrack есть следилка за соединениями, позволяющая применять stateful действия к проходящему, исходящему и входящему трафику<br>\nЭти значения таймаутов не должны относиться к tcpip реализации системы.<br>\nСистема вполне может работать, если выгрузить nf_conntrack, и логика tcp states, прописанная в rfc, от этого никуда не уйдет. Иначе tcpip вообще не будет работать.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 7,
        "updated_at": "2024-08-27T09:52:01.064Z",
        "reply_count": 0,
        "reply_to_post_number": 2,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 48,
        "readers_count": 47,
        "score": 9.6,
        "yours": false,
        "topic_id": 9801,
        "topic_slug": "%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "Zapret anti-DPI software staff",
        "title_is_group": false,
        "reply_to_user": {
            "username": "serj888",
            "name": null,
            "avatar_template": "/letter_avatar_proxy/v4/letter/s/f475e1/{size}.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": true,
        "admin": false,
        "staff": true,
        "user_id": 19,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll/9801/3",
        "can_translate": false
    },
    {
        "id": 36092,
        "name": "",
        "username": "amonakov",
        "avatar_template": "/user_avatar/ntc.party/amonakov/{size}/931_2.png",
        "created_at": "2024-08-27T09:53:31.604Z",
        "cooked": "<p>Я не настоящий знаток сокетов, но в первую очередь проверил бы, не решает ли <a href=\"https://manpages.debian.org/bookworm/manpages/tcp.7.en.html#TCP_USER_TIMEOUT\" rel=\"noopener nofollow ugc\">TCP_USER_TIMEOUT</a> эту задачу.</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 7,
        "updated_at": "2024-08-27T09:53:31.604Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 46,
        "readers_count": 45,
        "score": 14.2,
        "yours": false,
        "topic_id": 9801,
        "topic_slug": "%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
            {
                "url": "https://manpages.debian.org/bookworm/manpages/tcp.7.en.html#TCP_USER_TIMEOUT",
                "internal": false,
                "reflection": false,
                "title": "tcp(7) — manpages — Debian bookworm — Debian Manpages",
                "clicks": 5
            }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 805,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll/9801/4",
        "can_translate": false
    },
    {
        "id": 36159,
        "name": "",
        "username": "bolvan",
        "avatar_template": "/letter_avatar_proxy/v4/letter/b/8e8cbc/{size}.png",
        "created_at": "2024-08-27T15:36:34.025Z",
        "cooked": "<p>Хотя это и не решает задачу напрямую, но достаточно полезная штука в том числе и для смягчения этой проблемы.<br>\nЖаль, только на linux и macos работает.<br>\nРеализовал.</p>",
        "post_number": 5,
        "post_type": 1,
        "posts_count": 7,
        "updated_at": "2024-08-27T15:36:34.025Z",
        "reply_count": 1,
        "reply_to_post_number": 4,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 35,
        "readers_count": 34,
        "score": 12.0,
        "yours": false,
        "topic_id": 9801,
        "topic_slug": "%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "Zapret anti-DPI software staff",
        "title_is_group": false,
        "reply_to_user": {
            "username": "amonakov",
            "name": "",
            "avatar_template": "/user_avatar/ntc.party/amonakov/{size}/931_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": true,
        "admin": false,
        "staff": true,
        "user_id": 19,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll/9801/5",
        "can_translate": false
    },
    {
        "id": 36294,
        "name": "",
        "username": "amonakov",
        "avatar_template": "/user_avatar/ntc.party/amonakov/{size}/931_2.png",
        "created_at": "2024-08-28T09:49:08.898Z",
        "cooked": "<p>Перечитал начальный пост. На сокете, на который уже сделали shutdown(SHUT_WR), но в котором ещё есть непрочитанные вами данные, epoll должен вернуть EPOLLIN | EPOLLRDHUP, а не голый EPOLLRDHUP. Неужели это не так?</p>",
        "post_number": 6,
        "post_type": 1,
        "posts_count": 7,
        "updated_at": "2024-08-28T09:49:08.898Z",
        "reply_count": 1,
        "reply_to_post_number": 5,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 24,
        "readers_count": 23,
        "score": 9.8,
        "yours": false,
        "topic_id": 9801,
        "topic_slug": "%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
            "username": "bolvan",
            "name": "",
            "avatar_template": "/letter_avatar_proxy/v4/letter/b/8e8cbc/{size}.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 805,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll/9801/6",
        "can_translate": false
    },
    {
        "id": 36327,
        "name": "",
        "username": "bolvan",
        "avatar_template": "/letter_avatar_proxy/v4/letter/b/8e8cbc/{size}.png",
        "created_at": "2024-08-28T11:19:10.062Z",
        "cooked": "<p>Проблема не в этом. На том конце, которому делают SHUT_WR, как раз все как ожидается.<br>\nПроблема на конце, где мне делают SHUT_WR. Я получают оттуда EPOLLRDHUP. Мне тут без разницы есть ли EPOLLIN, так как всегда при этом происходит полная вычитка сокета до  recv&lt;=0.<br>\nЯ не могу на этом конце отличить сделали мне SHUT_WR или закрыли сокет через close().<br>\nВ первом случае мне еще есть смысл ожидать, когда мне будет что передать этому концу. Во втором случае надо сразу закрывать его сокет и как можно быстрее заканчивать с другим концом, тк ждать смысла нет. Если тот конец висит, то ждать можно до FIN_WAIT timeout.<br>\nИ получается у меня пара  FIN_WAIT_1 + CLOSE_WAIT.</p>\n<p>В нормальной ситуации я делаю второму концу SHUT_WR, и если у него ничего нет , - он мне быстренько шлет ACK на мой FIN, на что я получаю EPOLLHUP, и все хорошо.<br>\nНо он может повиснуть.  3-way handshake проходит, дальше мертво. Ситуация cdn, когда backend мертв</p>",
        "post_number": 7,
        "post_type": 1,
        "posts_count": 7,
        "updated_at": "2024-08-28T11:23:18.322Z",
        "reply_count": 0,
        "reply_to_post_number": 6,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 21,
        "readers_count": 20,
        "score": 4.2,
        "yours": false,
        "topic_id": 9801,
        "topic_slug": "%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "Zapret anti-DPI software staff",
        "title_is_group": false,
        "reply_to_user": {
            "username": "amonakov",
            "name": "",
            "avatar_template": "/user_avatar/ntc.party/amonakov/{size}/931_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": true,
        "admin": false,
        "staff": true,
        "user_id": 19,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%B7%D0%BD%D0%B0%D1%82%D0%BE%D0%BA%D0%B0%D0%BC-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8-epoll/9801/7",
        "can_translate": false
    }
]