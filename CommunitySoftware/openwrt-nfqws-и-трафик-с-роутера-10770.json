[
    {
        "id": 45702,
        "name": "",
        "username": "spv82",
        "avatar_template": "/user_avatar/ntc.party/spv82/{size}/1834_2.png",
        "created_at": "2024-09-26T10:06:37.650Z",
        "cooked": "<p>Здравствуйте. Прошу помочь разобраться. Роутер MI-R3G на OpenWrt 21.02 (iptables). Настроил nfqws только для Wireguard - из локальной сети все работает, соединение проходит и в статистике iptables NFQUEUE есть изменения. Но если с самого роутера запустить wg-клиент или просто <code>netcat -vuz 162.159.193.8 4500</code>, то соединения нет и в статистике iptables тоже не добавляется. Гугл подсказал на похожую тему <a href=\"https://github.com/bol-van/zapret/discussions/262\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">NFQUEUE doesn't work for routed traffic inside logical bridge (br-lan) on OpenWrt with nftables · bol-van/zapret · Discussion #262 · GitHub</a>, но там речь про nftables. Хотя тоже попробовал установить этот kmod br_netfilter и включить в sysctl, но после этого ничего не изменилось. В чем может быть причина?</p>\n<p><code>nfqws --debug=@/tmp/zapret-wg.txt --qnum=220 --user=daemon --dpi-desync-fwmark=0x40000000 --dpi-desync=fake --dpi-desync-repeats=6</code></p>\n<pre><code class=\"lang-auto\"># iptables-save | grep NFQUEUE\n-A POSTROUTING -o wan -p udp -m multiport --dports 2408,4500,1018,1074 -m mark ! --mark 0x40000000/0x40000000 -m connbytes --connbytes 1:1 --connbytes-mode packets --connbytes-dir original -m set ! --match-set nozapret dst -j NFQUEUE --queue-num 220 --queue-bypass\n</code></pre>\n<pre><code class=\"lang-auto\"># cat /tmp/zapret-wg.txt \ninitializing conntrack with timeouts tcp=60:300:60 udp=60\nopening library handle\nunbinding existing nf_queue handler for AF_INET (if any)\nbinding nfnetlink_queue as nf_queue handler for AF_INET\nbinding this socket to queue '220'\nsetting copy_packet mode\ninitializing raw sockets bind-fix4=0 bind-fix6=0\nset_socket_buffers fd=5 rcvbuf=2048 sndbuf=32768\nfd=5 SO_RCVBUF=4096\nfd=5 SO_SNDBUF=65536\nset_socket_buffers fd=6 rcvbuf=2048 sndbuf=32768\nfd=6 SO_RCVBUF=4096\nfd=6 SO_SNDBUF=65536\n</code></pre>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2024-09-26T12:37:24.001Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 876,
        "reads": 95,
        "readers_count": 94,
        "score": 4334.0,
        "yours": false,
        "topic_id": 10770,
        "topic_slug": "openwrt-nfqws-%D0%B8-%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA-%D1%81-%D1%80%D0%BE%D1%83%D1%82%D0%B5%D1%80%D0%B0",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
            {
                "url": "https://github.com/bol-van/zapret/discussions/262",
                "internal": false,
                "reflection": false,
                "title": "NFQUEUE doesn't work for routed traffic inside logical bridge (br-lan) on OpenWrt with nftables · bol-van/zapret · Discussion #262 · GitHub",
                "clicks": 8
            }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1517,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/openwrt-nfqws-%D0%B8-%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA-%D1%81-%D1%80%D0%BE%D1%83%D1%82%D0%B5%D1%80%D0%B0/10770/1",
        "can_translate": false
    },
    {
        "id": 46251,
        "name": "",
        "username": "spv82",
        "avatar_template": "/user_avatar/ntc.party/spv82/{size}/1834_2.png",
        "created_at": "2024-09-27T15:22:35.751Z",
        "cooked": "<p>Заметил еще такую особенность. Похоже, в conntrack вообще не попадают UDP-запросы отправленные с роутера.  К примеру, “netcat -vuz 8.8.8.8 53” - в “conntrack -E -p udp -d 8.8.8.8 --dport 53” - ничего.  Если сделать запрос с хоста из LAN, то все ок. Пол дня гуглил на эту тему, так ничего и не нашел похожего.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2024-09-27T15:22:35.751Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 72,
        "readers_count": 71,
        "score": 24.4,
        "yours": false,
        "topic_id": 10770,
        "topic_slug": "openwrt-nfqws-%D0%B8-%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA-%D1%81-%D1%80%D0%BE%D1%83%D1%82%D0%B5%D1%80%D0%B0",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1517,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/openwrt-nfqws-%D0%B8-%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA-%D1%81-%D1%80%D0%BE%D1%83%D1%82%D0%B5%D1%80%D0%B0/10770/2",
        "can_translate": false
    },
    {
        "id": 46433,
        "name": "",
        "username": "spv82",
        "avatar_template": "/user_avatar/ntc.party/spv82/{size}/1834_2.png",
        "created_at": "2024-09-28T06:06:48.027Z",
        "cooked": "<p>После пересоздания wg-интерфейса проблема решилась.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2024-09-28T06:06:48.027Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 58,
        "readers_count": 57,
        "score": 31.6,
        "yours": false,
        "topic_id": 10770,
        "topic_slug": "openwrt-nfqws-%D0%B8-%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA-%D1%81-%D1%80%D0%BE%D1%83%D1%82%D0%B5%D1%80%D0%B0",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1517,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/openwrt-nfqws-%D0%B8-%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA-%D1%81-%D1%80%D0%BE%D1%83%D1%82%D0%B5%D1%80%D0%B0/10770/3",
        "can_translate": false
    }
]