
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>ошибка-connect-to-self-на-openwrt-14302</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>Vermin</td><td><p>Товарищи, я себе уже весь мозг сломал, прошу помочь советом.</p>
<p>ByeDPI не дает устанавливать соединения через себя, в браузере</p>
<blockquote>
<p>Secure Connection Failed An error occurred during a connection to . PR_CONNECT_RESET_ERROR</p>
</blockquote>
<p>в консоль же при этом пишет <strong>connect to self, ignore</strong>.<br>
Но с чего бы он подключается к себе - ума не приложу…</p>
<p>Локально на Win byedpi работает нормально. Но конечная цель сделать ресурсы общедоступными на всей сети, для этого задействована малина с OpenWRT 23.05.</p>
<p>В качестве прокси выступает Byedpi в режиме transparent proxy (на него трафик заводится через ruantiblock, но тестировал и напрямую).<br>
Запущен сейчас с параметрами <code>./ciadpi-armv7l -E -i 192.168.11.5 --debug 2 --tlsrec -5+se --fake -5 --ttl 5 --tls-sni www.google.com</code>, где 192.168.11.5 - IP малины. Порт 1080 открыт и доступен.</p>
<p>На просторах гитхаба нашел собранный под OpenWRT ipk, но история с ним аналогичная.</p>
<p>С чем может быть связана ошибка, в каком направлении смотреть?</p></td><td>2025-01-03T00:35:39.408Z</td></tr><tr><td>BBS</td><td><p>Где установлен ruantiblock и как он настроен? Как настроен iptables/nftables? И при чём здесь порт 1080, если (цитирую) в режиме прозрачного прокси, SOCKS работать не будет?</p></td><td>2025-01-03T01:26:33.985Z</td></tr><tr><td>bolvan</td><td><p>Скорее всего не настроена правильно схема предотвращения зацикливания.<br>
byedpi сам генерит трафик, и если его опять перехватить и опять направить на byedpi, получится loop.<br>
Обычно это предотвращается через запуск под специальным юзером и исключением юзера из редиректа. Либо отказ от редиректа трафика, исходящего с самой системы</p>
<p>Может быть еще и ошибка в выборе socks/transparent режима.<br>
Транспарент прокси некоторые привыкли толковать в понятиях squid.<br>
Когда на него можно DNATнуть откуда угодно, и он срабатывает.<br>
Здесь это не так. squid анализирует трафик для выяснения адреса назначения.<br>
tproxy работает через метаданные ОС. Если их нет, то будет connect to self</p>
<p>Короче, надо технически разбирать как устроена вся схема, а если используется стороннее решение, то еще и выяснить что  оно делает и как реализует заявленную функцию</p></td><td>2025-01-03T07:01:23.136Z</td></tr><tr><td>Vermin</td><td><p>Насчет транспарента - возможно в этом дело, протестирую. Со стороны ruantiblock у меня было настроено перенаправление через redirect, а не tproxy.</p>
<p>Если не поможет, то надо будет смотреть на отключение редиректа</p></td><td>2025-01-03T10:30:11.555Z</td></tr><tr><td>Vermin</td><td><p>ruantiblock установлен на этом же узле, на малине. Насчет порта - нет никакой разницы какой порт использовать, если нет конфликта. SOCKS я у себя не использую. Можно поменять на 1101, к примеру, и, вероятно, я это позже сделаю, но что это изменит сейчас?<br>
iptables не задействован, в nft никакого криминала. Попробую сейчас переключить в режим tproxy перенаправление трафика, как предложил bolvan, если не поможет, то направлю настройки nft.</p></td><td>2025-01-03T10:34:45.069Z</td></tr><tr><td>Vermin</td><td><p>Вот что интересно… В режиме перенаправления tproxy на ruantiblock не заработало, вернул обратно на redirect. По предложению BBS поменял порт на 1101, думаю с чем черт не шутит. И все, похоже заработало! По крайней мере несколько девайсов сейчас перенастроил на использование малины в качествe шлюза и у них доступ к ресурсам появился.</p>
<p>Выходит, что</p>
<ol>
<li>Надо использовать кастомный порт</li>
<li>в режиме transparent proxy byedpi работает через redirect</li>
</ol>
<p>Проведу сегодня дополнительные тесты</p></td><td>2025-01-03T11:13:16.197Z</td></tr><tr><td>bolvan</td><td><p>Между tproxy и redirect/dnat технически разница небольшая.<br>
В первом случае адрес получается через getsockname, во втором через ioctl SO_ORIGINAL_DST и IP6T_SO_ORIGINAL_DST.<br>
В обоих случаях используются метаданные ОС, что делает невозможным перенаправление с другой системы или другого нетворк неймспейса (контейнера).</p></td><td>2025-01-03T11:49:00.501Z</td></tr><tr><td>BBS</td><td><p>Похоже, ruantiblock создаёт разный набор правил nft для разных режимов t_proxy_type. Интересно, какие именно правила он создаёт. Жаль что эта штука не умеет одновременно использовать больше одного проксика (как xray), мне бы такой маршрутизатор пригодился.<br>
То, что при смене порта всё заработало - это намёк на то, что порт 1080 уже кем-то занят. netstat -tulpn<br>
И последнее, почему вы не используете zapret вместо связки ByeDPI+ruantiblock?</p></td><td>2025-01-03T11:50:36.967Z</td></tr><tr><td>Vermin</td><td><p>Netstat смотрел конечно, как без него . И у меня на 1080 ничего не висит <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20">  Ну как бы то ни было, заработало и хорошо)</p>
<p>Умеет, но в ограниченном виде. Один прокси будет основным с возможностью подключения обновляемого списка доменов, еще до 5 проксей можно задействовать по статично заданным спискам (либо для конкретных IP клиентских, например).</p>
<p>Почему не zapret… До этого я предполагал его подключить. Стратегии подобрал, запустил с nfqws - и оно не заработало. Повозился сколько смог, так и не смог добиться работы. Изучение доступной документации не помогло, дебаг оказался весьма проблематичным, решил рассмотреть альтернативу.<br>
Но также чем интересно было настроить byedpi с ruantiblock - возможность 3 режимов работы:</p>
<ol>
<li>обычный трафик идет без каких-либо изменений</li>
<li>трафик к заблокированным ресурсам идет через byedpi</li>
<li>дополнительно можно явно указать что заворачивать на byedpi или VPN</li>
</ol>
<p>Ну и это все управляется через luci, что плюс.</p></td><td>2025-01-03T16:17:04.782Z</td></tr><tr><td>BBS</td><td><p>Спасибо, появился повод потестить эту штуку. Жаль что оно не умеет работать с zapret, но я чего-нибудь придумаю.</p></td><td>2025-01-03T16:58:26.188Z</td></tr>
    </table>
      </body>
    </html>