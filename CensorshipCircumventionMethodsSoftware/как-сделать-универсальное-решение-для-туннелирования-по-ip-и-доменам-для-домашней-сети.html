
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>как-сделать-универсальное-решение-для-туннелирования-по-ip-и-доменам-для-домашней-сети</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>pr0act1v3</td><td><p>У меня настроена такая система: на мобильных устройствах VPN до дома, дома роутер принимает BGP-маршруты с VPS (на VPS их формирует из общедоступных списков специально отдельный скрипт) и заворачивает часть трафика в VPN. Также дома свои DNS, которые шлют запросы через TLS (DoT).<br>
Первая проблема возникает с Cloudflare и другими CDN, в которой на одних и тех же адресах могут быть как заблокированные в России или заблокировавшиеся от России, так и российские сайты, которые не любят VPN. Также я замечаю, что некоторые (неправильно настроенные) серверы за Cloudflare, например <a href="http://lostfilm.tv" rel="noopener nofollow ugc">lostfilm.tv</a> вообще не открываются при частичной маршрутизации, ситуацию спасает только полное туннелирование всего трафика.<br>
Вторая проблема - надежность использования решения на наиболее распространенных протоколах VPN в перспективе.</p>
<p>Промежуточный вариант - использовать наряду с маршрутами к заблокированным IP список заблокированных доменов без их резолвинга в адреса. Но я не нашел никакого более удобного варианта кроме как использовать плагины типа Switchy Omega. Но они не для всех браузеров, и уж точно не для айфонов.</p>
<p>Я представляю себе решение примерно следующим образом: на домашнем сервере стоит нечто (sing-box, xray, GOST ?), принимающее одновременно и списки IP-адресов, и списки доменов. Роутер отправляет весь исходящий трафик на этот сервер, где принимается решение:</p>
<ol>
<li>если TCP (а может можно и UDP?) на 443 порт и в сторону списка доменов, в туннель;</li>
<li>если иное и в сторону списка адресов, в туннель;</li>
<li>в противном случае - напрямую.<br>
Для отработки первого случая, как я понимаю, во всех браузерах один раз нужно будет прописать настройки прокси, работающего на домашнем сервере.</li>
</ol>
<p>Вопросы:</p>
<ol>
<li>какое приложение использовать в качестве комбайна, чтобы и оба варианта списков мог переваривать мог, и имел входящий proxy, например Socks5?</li>
<li>как разделить трафик домашнего сервера на трафик самого сервера и входящий-исходящий при наличии одного физического интерфейса? mpls? несколько ip-адресов? как это лучше сделать?</li>
<li>как сообщать роутеру, какие пакеты куда слать? на ум приходит mpls, ну или в зависимости от того, с какого ip от сервера приходят пакеты.</li>
</ol>
<p>Перечитал все известные статьи комрада MiraclePtr с Хабра, но не нашел какого-то более менее универсального варианта. Предложенные варианты клиентов типа nekoray или shadowrocket достаточно гибкие с точки зрения настроек, но это именно клиенты, которые должны ставиться на клиентских устройствах. Я же пытаюсь реализовать так, чтобы с одной стороны был сервер, а с другой - клиент. Видел подобное в китайских прокси (inbounds, outbounds), но так и не смог найти, как это все правильно использовать вместе. Тот же xray в качестве inbounds принимает отдельные протоколы, весь трафик туда направить не получится. А может и не нужно?<br>
Укажите, пожалуйста, направление <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p></td><td>2024-02-28T13:25:35.949Z</td></tr><tr><td>borouhin(Alexander Borouhin)</td><td><p>По списку на все вопросы не отвечу, но скажу, как у меня сделано (или планируется сделать). У меня очень похожая система - во всех домах/офисах роутеры, в России сервер для VPN. И плюс отдельный сервер, который по заданным критериям (IP, подсеть, домен, AS) формирует списки, через какую выходную точку (сервер / роутер) маршрутизировать пакеты.  Этот последний сервер по BGP раздаёт получившиеся списки префиксов для каждой выходной точки в виде отдельного BGP community роутерам и VPN-серверу.</p>
<p>Так вот, что порекомендую из своего опыта по Вашим вопросам:</p>
<ol>
<li>
<p>Во-первых, DNS-сервер должен быть свой, использоваться всеми клиентами в локальной сети и VPN, и именно с использованием этого DNS-сервера должны ресолвится домены для списков маршрутизации (и обновляться периодически). Это спасёт хотя бы от ситуации “сервер для целей маршрутизации выдал IP для одного региона, а клиент у себя получил IP для другого, и маршрут к нему построился неправильно”. Но не спасает от рандомно меняющихся IP, которыми многие CDN и иже с ними грешат. Тут пока что добавляю в списки целыми AS.</p>
</li>
<li>
<p>Во-вторых, отделить и по-разному маршрутизировать трафик клиентов и собственный трафик сервера элементарно, но вот готовую инструкцию тут не напишу, отправлю читать маны <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"> Ключевые слова - ip rule, iptables CONNMARK (ну или что там у nftables аналогичное, к стыду своему на них не переполз до сих пор)</p>
</li>
<li>
<p>В-третьих, чтобы полностью решить проблему с рандомными ответами некоторых DNS, а заодно и проблему с ресолвингом по маске домена (*.example.com) вижу один способ - на своём DNS-сервере включить логирование всех запросов (unbound позволяет) и фоном парсить эти логи на предмет соответствия включённым в наши критерии маршрутизации доменам/маскам, при совпадении - обновлять списки префиксов. Но тут надо писать что-то не совсем примитивное (без асинхронности никак), так что до сих пор руки не дошли.</p>
</li>
<li>
<p>В-четвёртых, прокси (VLESS и иже с ними) на текущий момент только добавляют лишней головной боли, особенно если нужен не только доступ к заблокированному, но и доступ к своей сети извне. Amnezia-WG работает, очень шустро, пока не блокируется, но имеет шансы. WG внутри Cloak работает, не так шустро, но приемлемо, шансы блокировки не выше, чем у VLESS со товарищи. Так что между серверами/роутерами я настроил оба этих варианта и OSPF, который перекинет маршрут с амнезии на клоак при отпадании первой автоматически. А для клиентов VPN-сервера - OpenConnect.</p>
</li>
</ol></td><td>2024-02-28T18:30:31.377Z</td></tr><tr><td>pr0act1v3</td><td><p>Спасибо за советы!</p>
<ol>
<li>У меня уже все готово, за исключением того, что DNS для дома и мобильных устройств, а VPS ресолвит всё сам. Попробую проверить, станет ли лучше, если VPS начнет обращаться к домашним DNS.</li>
<li>Уже использую connection mark, но не думал, что можно в таком ключе! Но если речь об опросе DNS, возможно лучше приглядеться к другим вариантам (см. дальше).</li>
<li>Похоже на то, что было описано в статье <a href="https://habr.com/ru/articles/467547/" class="inline-onebox" rel="noopener nofollow ugc">Обход блокировок РКН с помощью DNSTap и BGP / Хабр</a>. Вероятно под это дело можно взять отдельное готовое приложение для сбора логов с DNS, и тогда запариваться с асинхронностью лишний раз не придется. Ещё автор предлагает манипулировать маршрутами, полученными на основании анализа DNS, с помощью BGP с небольшим TTL.</li>
<li>Тоже настроил для входящих домой как резервные варианты, в том числе OpenConnect. Про наводку Wireguard + Cloak для исходящих также спасибо, буду думать.</li>
</ol></td><td>2024-02-28T21:14:05.801Z</td></tr><tr><td>borouhin(Alexander Borouhin)</td><td><p>Хм… за наводку на DNSTap (точнее, dnstap-bgp) спасибо, оно, по ходу, делает бóльшую часть того, что я собирался писать сам.</p>
<p>Про WG через Cloak - для понимания тяжести проблемы, на трансграничном канале, который выдаёт около 800 Мбит/с без всяких туннелей, WG и Amnezia-WG выжимают около 600 Мбит/с <em>(Амнезия почти не снижает скорость, но несколько больше нагружает CPU, чем обычный WG, который на уровне ядра)</em>, - WG через Cloak выдаёт около 250 Мбит/с. Не знаю, можно ли эту пропорцию экстраполировать на более и менее широкие каналы, но для грубой оценки, думаю, можно взять, а там смотрите, насколько для Вас это критично. VLESS должен дать большую скорость, но если надо обеспечить полноценную связность сетей по обе стороны туннеля - это так себе решается через VLESS.</p></td><td>2024-02-28T21:48:10.756Z</td></tr><tr><td>pr0act1v3</td><td><p>Я думаю, что лучше настроить больше и всего сразу и выбирать лучше из того, что работает, чем потом в спешке что-то прикручивать, когда РКН запустит в пульт гаечным ключом, как это было с “блокировкой” Телеграма.</p>
<p>И всё-таки возвращаясь к моему вопросу: а что если попробовать сделать прям собственный DPI с маркировкой пакетов? Понятно, что железо при этом потребуется производительнее, но и поставить старый компьютер под такое дело - не проблема. Я нахожу и опенсорсные решения, только не совсем представляю (нет опыта работы с DPI), насколько их можно использовать не для блокировки трафика (как IDS/IPS), а именно для маркировки с последующей маршрутизацией.</p></td><td>2024-02-29T17:31:37.353Z</td></tr><tr><td>borouhin(Alexander Borouhin)</td><td><p>Не понимаю, чем Вам MARK/CONNMARK не такой “DPI” (ну точнее тут нет DPI, но маркировка пакетов это и есть в чистом виде)? Вы именно что добавляете к каждому пакету (а для CONNMARK - и к последующим пакетам того же соединения) дополнительное поле, по которому потом можно или в следующих цепочках обрабатывать, или в другую таблицу маршрутизации отправлять.</p>
<p>P.S. А, понял, Вы хотите в Layer 7 залезть для классификации пакетов, так? Ну тогда возьмите какой-нибудь <a href="https://github.com/ntop/nDPI" rel="noopener nofollow ugc">nDPI</a> и лезьте <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"><br>
P.P.S. Однако, со времён, когда я в эту сторону смотрел, многое изменилось <img src="https://ntc.party/images/emoji/twitter/thinking.png?v=12" title=":thinking:" class="emoji" alt=":thinking:" loading="lazy" width="20" height="20"> Раньше можно было собрать <a href="https://github.com/betolj/ndpi-netfilter/" rel="noopener nofollow ugc">ndpi-netfilter</a> и прямо в iptables использовать возможности этой библиотеки, а сейчас этот проект мёртвый, авторы ndpi предлагают использовать свой продукт nprobe за денежку… в общем, надо разбираться.</p></td><td>2024-02-29T17:59:47.084Z</td></tr><tr><td>ValdikSS</td><td><p>Есть четыре принципиальных подхода к решению задачи:</p>
<ol>
<li>
<p>То, что у вас или у <a class="mention" href="/u/borouhin">@borouhin</a> сейчас, в каком-либо виде, сводящееся к маршрутизации по IP-адресам. Пре-резолв заблокированных доменов, динамическое добавление маршрутов через <code>dnsmasq ipset</code>/dnstap — не принципиально.</p>
</li>
<li>
<p>Анализ доменов на уровне DNS и переадресация заблокированных в какие-то другие IP-адреса (как в <a href="https://antizapret.prostovpn.org:8443/tech.html#vpn">VPN АнтиЗапрета</a>).<br>
Реализовано в</p>
<ul>
<li><a href="https://bitbucket.org/anticensority/antizapret-vpn-container/src/master/mkosi/mkosi.extra/root/dnsmap/proxy.py">АнтиЗапрете</a></li>
<li><a href="https://github.com/stek29/myazvpn" class="inline-onebox">GitHub - stek29/myazvpn: my (re)implementation of antizapret like vpn</a></li>
</ul>
</li>
<li>
<p>Выборочное или полное перенаправление TCP/UDP-трафика на локальный прокси с поддержкой «<a href="https://www.v2fly.org/v5/config/inbound.html#sniffingobject">сниффига</a>» (анализа HTTP/TLS/QUIC-пакетов и вычленения домена) и правил маршрутизации: v2fly/xray/sing-box сотоварищи.<br>
Вам не нужен Socks5 в качестве inbound, используйте то, что понимает iptables redirect. В v2fly это называется <a href="https://www.v2fly.org/en_US/config/protocols/dokodemo.html">dokodemo-door</a>.</p>
</li>
<li>
<p>«Сниффинг» домена на уровне netfilter и перенаправление трафика на уровне маршрутизации метками или как-либо еще («свой DPI»). Если распарсить пакет и определить домен достаточно просто:</p>
<ul>
<li><a href="https://github.com/Lochnair/xt_tls" class="inline-onebox">GitHub - Lochnair/xt_tls: Filter TLS traffic with IPtables</a></li>
<li><a href="https://github.com/gibbon4ik/xt_tlslist" class="inline-onebox">GitHub - gibbon4ik/xt_tlslist: xt_tlslist is an extension for netfilter/IPtables that allows you to filter traffic based on TLS hostnames</a></li>
</ul>
<p>то перенаправление по другому маршруту/интерфейсу потребует <a href="https://habr.com/ru/news/667096/comments/#comment_24367298">переустановки соединения</a>, каких-либо готовых инструментов для этого я не знаю.</p>
</li>
</ol>
<p>Первый подход чреват оверинжинирингом всего и вся, но не решает проблем, с которыми вы же и столкнулись. То, что вы здесь описываете с bgp-dnstap сродни выкидывания мусора в иллюминатор с МКС.<br>
Второй требует использования только DNS сервера, и с другими работать не будет. Если какое-либо приложение внутри себя использует сторонний DNS/DoH, либо же просто устанавливает соединение по фиксированному адресу, то DNS этого не поймает.<br>
Третий способ легко и гибко конфигурируется, но также легко отбирает у вас <em>все</em> возможности по маршрутизации на сетевом уровне. Не знаю, как в аналогах, но в v2fly <a href="https://github.com/v2fly/v2ray-core/issues/2665">сломан mark на freedom outbound</a>, остаются, разве что, разные source ip-адреса в качестве возможной метки.<br>
Четвертый способ самый прикольный (и позволит делать и другие вещи, как например, прозрачное перенаправление bittorrent-трафика через другой канал), но нет реализаций, и сделать её правильно может быть не так тривиально, как кажется.</p></td><td>2024-02-29T21:21:12.696Z</td></tr><tr><td>borouhin(Alexander Borouhin)</td><td><p>Мне кажется, если всё-таки решать более общую задачу, кроме первого способа ничего и не остаётся.</p>
<p>Когда у нас один список заблокированных доменов, который для всех клиентов надо маршрутизировать через один сервер, - могут быть варианты. А когда, как у меня сейчас, семь списков, четыре выходных точки, и в каждом сегменте сети свои настройки, какой список через какую точку маршрутизировать… (простейший пример - для зарубежного сегмента список GeoIP-RU перенаправляем через российский сервер, а для российского игнорируем его, а для списка РКН наоборот). При этом списки могут формироваться как из готовых перечней IP/подстей/AS/GeoIP/доменов/масок, так и динамически (пример - турецкие блокировки, единого реестра, который можно скачать, нет, но есть сервис, который позволяет проверить, заблокирован ли IP/домен).</p>
<p>В общем, как только задачка становится чуть более широкой, а в нынешних непростых условиях она неизбежно становится <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"> - вариант 1 это не оверинжиниринг, а суровая необходимость. Вообще в идеале хотелось бы сделать максимально модульную систему, к которой любая новая страна добавляется путём заведения в оной VPSки и изменения конфига.</p></td><td>2024-02-29T23:28:55.723Z</td></tr><tr><td>pr0act1v3</td><td><p><a class="mention" href="/u/valdikss">@ValdikSS</a>, спасибо большое за подробный ликбез. К четвертому подходу я слабо представляю как подступиться (сохранять весь трафик и посылать повторные запросы от нового адреса с DPI-сервера, а потом переписывать ответные пакеты с помощью dynamic NAT для RELATED и ESTABLISHED?).<br>
Да, подход с dnstap и мне кажется чрезчур наивным, поэтому я склоняюсь к третьему варианту из перечисленных. И мне кажется, что такой вариант позволяет</p>
<aside class="quote no-group" data-username="borouhin" data-post="8" data-topic="7312">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/borouhin/48/3734_2.png" class="avatar"> borouhin:</div>
<blockquote>
<p>сделать максимально модульную систему, к которой любая новая страна добавляется путём заведения в оной VPSки и изменения конфига</p>
</blockquote>
</aside>
<p>А ещё</p>
<aside class="quote no-group" data-username="borouhin" data-post="8" data-topic="7312">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/borouhin/48/3734_2.png" class="avatar"> borouhin:</div>
<blockquote>
<p>семь списков, четыре выходных точки, и в каждом сегменте сети свои настройки, какой список через какую точку маршрутизировать…</p>
</blockquote>
</aside>
<p>очень хорошо сочетается с конфигом китайских прокси типа xray, vray и тд., в которых можно и прописывать AS, и GeoIP, и подцеплять списки IP и доменов. Вы наверное просто не видели это в деле. Я как раз загорелся идеей этого поста, поковыряв конфиг XTLS в nekoray и поняв, насколько он гибкий. Здесь прямо напрашивается сделать клиент еще и сервером.<br>
Да, минус такого подхода в том, что двухстороннюю связность таким образом не настроишь, но это же proxy, а не VPN, и цель тут не в настройке свзяности и проброске сетей.</p>
<p>Быстрый гуглеж не дал найти сломанные mark в issues аналогов v2ray, но учитывая что они все в той или иной степени форки, очень даже вероятно проблема есть у многих или у всех. Однако свойство “sendThrough” в конфиге приведенного примера (а также например xray <a href="https://xtls.github.io/config/outbound.html#outboundobject" class="inline-onebox" rel="noopener nofollow ugc">出站代理 | Project X</a>) позволяет направлять трафик на разные IP-адреса. <a class="mention" href="/u/valdikss">@ValdikSS</a>, разве этого недостаточно, чтобы передать информацию для роутера, куда это слать дальше, или я не учитываю что-то еще?</p></td><td>2024-03-01T15:28:29.044Z</td></tr><tr><td>borouhin(Alexander Borouhin)</td><td><aside class="quote no-group" data-username="pr0act1v3" data-post="9" data-topic="7312">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/p/8dc957/48.png" class="avatar"> pr0act1v3:</div>
<blockquote>
<p>но это же proxy, а не VPN, и цель тут не в настройке свзяности и проброске сетей.</p>
</blockquote>
</aside>
<p>Увы, мне совершенно не нужен прокси, который не VPN, и очень нужна связность сетей на каждой плодащке, так что изыскания в этом направлении не могу комментировать <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p></td><td>2024-03-01T15:30:41.807Z</td></tr><tr><td>Jamakasi(Jamakasi)</td><td><p><a class="mention" href="/u/valdikss">@ValdikSS</a> у меня сейчас есть в разработке еще один вариант. Точнее он уже успешно работает но пока выкатываеть его стыдно, за несколько лет путем проб и ошибок вывел себе идеальную систему под все свои задачи.<br>
Общая суть следующая.<br>
1 Раскидываются ULA префиксы на свои сети.<br>
2 Маршрутизация этих префиксов между домашними роутерами\vps\vds.<br>
3 В нужных локация поднимается nat64, к примеру tayga. Скажем в США, Европе и РФ.<br>
4 Дальше мой говнософт в виде мидлваров к coredns.<br>
4.1 первый мидлвар снифает входящие запросы, сверяет с бд, если есть то отправляет на следующий dns, если нет то просто резольвит.<br>
4.2 особый мидлвар который делает dns64. Отходя от стандартов мапирует v4 в v6 как обычно, но необычно что выпиливает все не dns64 ответы в виде оригинальных v4 и v6 адресов, ломает dnssec<br>
Для пункты 4.1 есть restapi по управлению бд на лету, она к слову inmem, могут синхронизироваться между инстансами. Можно более одной бд вести.</p>
<p>На выходе:<br>
1 никаких трюков с маркировкой в фаирволе или гигансткими таблицами маршрутизации с bgp\ospf<br>
2 набивка бд только нужными доменами с возможностью заворотов в нужную локацию. Скажем нетфликс надо через америкосию, ибей через европу, а госуслуги через рф.<br>
3 rest по синхронной набивке бд.<br>
4 очень компактно по ресурсам на серверах, по сути tayga для nat64 и coredns.<br>
5 Довольно геморно для разворачивания и это не вариант в установил и запустил.</p>
<p>Когда чуть облагорожу исходники и допишу хоть какие то readme то вкину на гитхаб всё и где нибудь тут.</p></td><td>2024-04-02T08:32:12.367Z</td></tr>
    </table>
      </body>
    </html>