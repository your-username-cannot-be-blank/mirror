
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>настройка-vpn-для-всей-домашней-сети</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>DanilaL</td><td><p>Всем доброго дня суток.</p>
<p>В связи с блокировками, я начал интересоваться всякими способами обхода блокировок/замедлений.<br>
На данный момент имеется vps с настроенным <a href="https://habr.com/ru/articles/731608/" rel="noopener nofollow ugc">xray+reality</a>. Настроил клиенты в виде NekoBox и streisand (ios).<br>
Пришла мысль о том, что скорее всего, можно каким-то образом настроить этот клиент где-то в начале моей домашней сети. Таким образом, все устройства, которые будут подключены к ней по LAN или wifi не будут нуждаться в vpn клиентах.</p>
<p>Но для реализации мне не хватает знаний. Подскажите, какие есть возможные способы воплощения в жизнь моей идеи?<br>
В точки зрения железа, мне кажется, будет работать следующая схема:<br>
ethernet от провайдера → WAN порт nanopi r4s (тут, например, стоит клиент xray) → r4s LAN идет в switch.</p>
<p>Также видел идеи, что можно купить минипк, так как на нем можно поставить стандартный linux и настраивать все, что захочешь.</p></td><td>2024-08-10T14:54:18.324Z</td></tr><tr><td>0ka(0ka)</td><td><p>что у вас сейчас-то есть? не обязательно покупать мини пк с двумя ethernet портами, достаточно LAN. тут тема рядом на форуме уже есть где люди писали как сделали у себя</p></td><td>2024-08-10T15:06:10.931Z</td></tr><tr><td>Dhohbr</td><td><aside class="quote quote-modified" data-post="26" data-topic="8804">
  <div class="title">
    <div class="quote-controls"></div>
    <img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/a698b9/48.png" class="avatar">
    <a href="https://ntc.party/t/raspberry-pi-xray-%D0%BC%D0%B5%D0%B6%D0%B4%D1%83-%D1%80%D0%BE%D1%83%D1%82%D0%B5%D1%80%D0%BE%D0%BC-%D0%B8-%D1%82%D0%B5%D0%BB%D0%B5%D0%B2%D0%B8%D0%B7%D0%BE%D1%80%D0%BE%D0%BC/8804/26">Raspberry Pi + xray между роутером и телевизором</a> 
  </div>
  <blockquote>
    <a class="mention" href="/u/masteryoba">@MasterYoba</a> а, значит я просто одно лишнее правило добавлял. Попробую как вы сказали, спасибо. 

Это кстати пробовал, но заметных изменений не дало. Возможно, потому что ethtool -k eth0 выдаёт generic-segmentation-offload: off [requested on], принудительно включить не удалось. 

Вообще любопытно. Если правильно понял, inbound типа redirect слушает на 100 порту, на который мы переводим запросы с ТВ. Спасибо, попробую так сделать.
  </blockquote>
</aside>
<aside class="quote" data-post="23" data-topic="5603">
  <div class="title">
    <div class="quote-controls"></div>
    <img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/0/d78d45/48.png" class="avatar">
    <a href="https://ntc.party/t/%D0%BA%D0%B0%D0%BA%D0%BE%D0%B9-%D1%81%D1%83%D1%89%D0%B5%D1%81%D1%82%D0%B2%D1%83%D0%B5%D1%82-%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%B8-%D1%83%D0%BD%D0%B8%D0%B2%D0%B5%D1%80%D1%81%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9-%D0%B4%D0%BB%D1%8F-%D1%80%D0%B0%D0%B7%D0%BD%D1%8B%D1%85-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2-%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1-%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BA-vpn-%D0%B2-%D1%83%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D1%8F%D1%85-%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/5603/23">Какой существует простой и универсальный (для разных устройств) способ подключения к VPN в условиях блокировки</a> <a class="badge-category__wrapper " href="/c/censorship-circumvention-software/11"><span data-category-id="11" style="--category-badge-color: #92278F; --category-badge-text-color: #FFFFFF;" data-drop-close="true" class="badge-category " title="Discussions of censorship circumvention software of different kinds, for all operation systems and devices"><span class="badge-category__name">Censorship circumvention methods &amp; software</span></span></a>
  </div>
  <blockquote>
    мой кастомный конфиг sing-box не создает tun адаптер, не активирует системный впн, а только открывает порт. вы точно его пробовали?
  </blockquote>
</aside>
</td><td>2024-08-10T15:14:15.009Z</td></tr><tr><td>0ka(0ka)</td><td><p>это к чему? типа предлагаете wireguard через reality?</p></td><td>2024-08-10T15:15:32.800Z</td></tr><tr><td>Dhohbr</td><td><p>Это ТС почитать. Там обсуждали разные варианты с отдельной железкой, может что-то понравится.</p></td><td>2024-08-10T15:18:31.587Z</td></tr><tr><td>DanilaL</td><td><p>В данный момент ничего нет, кроме роутера и vps.</p>
<p>Я в данный момент просто пытаюсь понять, что мне больше всего подойдет и как будет легче всего реализовать.<br>
Я правильно понимаю, что наивно мне было полагать, что установка машины на линунке с двумя ethernet портами, куда я установлю nekobox для связи с vps, будет работать как я хотел?</p></td><td>2024-08-10T18:59:31.795Z</td></tr><tr><td>0ka(0ka)</td><td><aside class="quote no-group" data-username="DanilaL" data-post="6" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/d/8491ac/48.png" class="avatar"> DanilaL:</div>
<blockquote>
<p>установка машины на линунке с двумя ethernet портами, куда я установлю nekobox для связи с vps, будет работать как я хотел</p>
</blockquote>
</aside>
<p>будет, это легко сделать, только не через nekobox, а sing-box</p>
<p>в роутере нет поддержки vpn?</p></td><td>2024-08-10T19:02:09.866Z</td></tr><tr><td>DanilaL</td><td><p>Нет, это старенький archer c5 v4, на который даже openwrt встал еле-еле, на который к тому же не встают нужные для zapret или openvpn/wireguard kmod-* зависимости.<br>
Поэтому я как раз пытаюсь понять, что мне лучше приобрести в моей ситуации: хороший роутер (например, tuf ax4200) или какую-то линукс машину.</p></td><td>2024-08-10T19:34:18.187Z</td></tr><tr><td>BBS</td><td><p>Присмотритесь к Orange Pi R1 Plus LTS. 2 гигабитных порта, USB, 1GB RAM, поддержка OpenWRT, Ubuntu, Debian. К нему же не сложно найти готовый корпус.</p></td><td>2024-08-10T21:50:57.500Z</td></tr><tr><td>DanilaL</td><td><aside class="quote no-group" data-username="BBS" data-post="9" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/b/e47774/48.png" class="avatar"> BBS:</div>
<blockquote>
<p>Orange Pi R1 Plus LTS</p>
</blockquote>
</aside>
<p>В чем его принципиальная разница с nanopi r4s?</p>
<p>Вот, соответственно, мы вернулись к началу топика, где я пытался понять схему подключения всего этого дела.<br>
Я набросал схему следующего вида, и как я понял из сообщений выше, она будет работать</p>
<aside class="quote no-group" data-username="0ka" data-post="7" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/0/d78d45/48.png" class="avatar"> 0ka:</div>
<blockquote>
<p>будет, это легко сделать, только не через nekobox, а sing-box</p>
</blockquote>
</aside>
<p><div class="lightbox-wrapper"><a class="lightbox" href="настройка-vpn-для-всей-домашней-сети/e821606016465c8e5b5635b775f39448bfcad7a6.jpeg" data-download-href="https://ntc.party/uploads/default/e821606016465c8e5b5635b775f39448bfcad7a6" title="home_network"><img src="настройка-vpn-для-всей-домашней-сети/e821606016465c8e5b5635b775f39448bfcad7a6_2_381x374.jpeg" alt="home_network" data-base62-sha1="x7whtB20VLV2sCnIYrBnSeQDbhk" width="381" height="374" srcset="настройка-vpn-для-всей-домашней-сети/e821606016465c8e5b5635b775f39448bfcad7a6_2_381x374.jpeg, настройка-vpn-для-всей-домашней-сети/e821606016465c8e5b5635b775f39448bfcad7a6.jpeg 1.5x, настройка-vpn-для-всей-домашней-сети/e821606016465c8e5b5635b775f39448bfcad7a6.jpeg 2x" data-dominant-color="FAFAFA"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">home_network</span><span class="informations">541×531 19.7 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>Мне важно убедится, что представленная выше схема будет работать, ибо от этого будет зависеть, какое доп. устройство мне нужно купить.</p></td><td>2024-08-11T08:42:24.284Z</td></tr><tr><td>Dhohbr</td><td><aside class="quote no-group" data-username="DanilaL" data-post="11" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/d/8491ac/48.png" class="avatar"> DanilaL:</div>
<blockquote>
<p>Мне важно убедится, что представленная выше схема будет работать, ибо от этого будет зависеть, какое доп. устройство мне нужно купить.</p>
</blockquote>
</aside>
<p>Разверните схему на виртуалке, и протестируйте.</p></td><td>2024-08-11T08:58:42.639Z</td></tr><tr><td>0ka(0ka)</td><td><p>именно по вашей схеме я не делал, у меня мини пк с 1 LAN, на нём amneziaWG, прописываю его как шлюз на устройствах. AmneziaWG можно заменить на sing-box, или маршрутизировать на awg либо прямо через dnsmasq ipset (наверное самый легкий для проца способ)</p></td><td>2024-08-11T09:40:54.458Z</td></tr><tr><td>sakontwist</td><td><p>У меня схема такая: минипк с 2-мя портами, на нем запущен xray core, который цепляется к нескольким ru-vps по ss, wg и vless через балансировку. Весь трафик с локальной сети на 80,443 заворачивается на xray через dokodemo. Уже на vps также через xray core делается вся маршрутизация куда надо.</p></td><td>2024-08-11T13:19:44.219Z</td></tr><tr><td>DanilaL</td><td><aside class="quote no-group" data-username="sakontwist" data-post="14" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/s/c77e96/48.png" class="avatar"> sakontwist:</div>
<blockquote>
<p>минипк с 2-мя портами, на нем запущен xray core, который цепляется к нескольким ru-vps по ss, wg и vless через балансировку</p>
</blockquote>
</aside>
<p>Не подскажите, для каких целей вы здесь используете ru-vps?</p></td><td>2024-08-11T15:21:50.556Z</td></tr><tr><td>spellozz(Spellozz)</td><td><p>Взять роутер, прошить под openwrt, настроить там туннель wg или sing box для xray, сделать маршрутизацию по доменам из списка или добавить свои.<br>
По роутерам брать то, что шьется и с норм производительностью. Типа xiaomi ax3000t, ax 3200, можно взять уже готовый прошитый производителем routerich ax3000. Для подробностей посмотреть <a href="https://youtu.be/Otv-kMzGOSU" rel="noopener nofollow ugc">https://youtu.be/Otv-kMzGOSU</a></p>
<p>В данный момент у меня приобретён роутер ax3200, прошит и настроен туннель для всех устройств в сети. Клиенты и телик ничего не настраивают</p></td><td>2024-08-11T15:48:53.064Z</td></tr><tr><td>sakontwist</td><td><p>Чтобы обращаться на ru-адреса напрямую.</p></td><td>2024-08-11T18:27:23.161Z</td></tr><tr><td>DanilaL</td><td><p>В процессе поиска информации наткнулся на такие ОС, как opnsense и pfsense. А после этого открыл для себя систему виртуализации Proxmox.<br>
Изначально планировал, если я буду покупать минипк, использовать его ресурсы не только для реализации роутера. Proxmox в этом сильно поможет.<br>
Сколько бы я не искал, не смог найти рабочий клиент VLESS под opn/pf-sense.<br>
Но существуют клиенты для OpenWRT и закрадывается мысль о том, чтобы заменить *-sense ОС на OpenWRT.<br>
Кто-то делал похожим образом?</p></td><td>2024-08-13T07:59:38.737Z</td></tr><tr><td>0ka(0ka)</td><td><aside class="quote no-group" data-username="DanilaL" data-post="18" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/d/8491ac/48.png" class="avatar"> DanilaL:</div>
<blockquote>
<p>закрадывается мысль о том, чтобы заменить *-sense ОС на OpenWRT.</p>
</blockquote>
</aside>
<p>На этом форуме ни у кого еще не видел *sense os</p></td><td>2024-08-13T09:23:54.183Z</td></tr><tr><td>bolvan</td><td><p>pfsense это freebsd<br>
к нему подключаются его репы. можно из них проставляться. если даже там чего-то нет, можно собрать на freebsd</p></td><td>2024-08-13T10:14:45.643Z</td></tr><tr><td>Texsis</td><td><p>Если запускаете на proxmox, то лучше наверное для этих целей поднять виртуалку с openwrt и на ней все сделать. Либо просто виртуальную машину на Ubuntu  допустим.</p></td><td>2024-08-13T10:41:23.746Z</td></tr><tr><td>DanilaL</td><td><p>А можете подсказать, как сделать подробную маршрутизацию? А именно Домашний роутер → ru-vps → eu-vps только для заблокированных ресурсов.<br>
Я предполагаю, что на ru-vps стоит что-то наподобие sing box, который все это делает маршрутизирует. Не могу понять, как мне трафик вернуть обратно. Возможно, вопрос глупый, но пока что я не слишком силен в сетях.</p>
<p>Пообщавшись со знакомыми выяснил, что не у всех есть роутеры с нормальной поддержкой openwrt или ресурсов роутера недостаточно. Но что у первых, что у вторых хватает ресурсов на WG/OPN.<br>
Предполагаю, что можно соорудить wg туннель от роутера до ru-vps, который уже возьмет на себя всю ношу маршрутизации (в целом точно также, как вы и описали).</p></td><td>2024-08-13T19:00:32.703Z</td></tr><tr><td>codeninja</td><td><p>У меня работает так:</p>
<p>Домашний роутер с openwrt. На нем поднят stunnel до vps. На vps обычный прокси без пароля доступный только на localhost (tinyproxy). Таким образом через туннель порт прокси оказывается открыт у меня в домашней сети. На всех устройствах я вношу в настройках, чтобы они подключались через прокси. Таким образом получается vpn без напряга даже на старых устройствах и утюгах.</p>
<p>Бонус: делаю PAC файл, который указывает какие сайты я хочу, чтобы шли через прокси.</p>
<p>Касательно вопроса ОП-а, xray можно поднять где-то в локальной сети или на роутере и также использовать его как прокси с других устройств.</p></td><td>2024-08-13T19:28:07.691Z</td></tr><tr><td>sakontwist</td><td><p>У меня есть специфика - домашний роутер это мини-пк. Поэтому схема реализуется просто. На всех узлах стоит x-ray core. Дома он забирает указанный трафик и гонит на ru-vps как клиент. На ru-vps он же разделяет запросы на условно ru - not-ru, но можно например делить по регионам, если есть vps в разных странах. Он же режет трекеры и прочий мусор. Дальше отдает либо сразу в директ, либо как клиент на удаленные vps.</p>
<p>Соответственно мобильные клиенты сразу по схеме road warrior цепляются на ru-vps.</p>
<p>Насчёт WG - да, можно поднять его до ru-vps и отправлять трафик туда по этому туннелю. Без проблем и это даже быстрее, только и запасной протокол лучше иметь на случай отвала WG.</p>
<p>Никакой трафик “обратно” возвращать не надо. Туда уходят запросы, обратно - ответы. Это не VPN в полном смысле этого слова, хотя сквозь x-ray я пускал и OpenVPN и WG успешно, но накладные расходы всё-таки ощутимы. Тут лучше тогда Cloak</p></td><td>2024-08-13T19:34:13.054Z</td></tr><tr><td>Xunlei</td><td><aside class="quote no-group" data-username="DanilaL" data-post="22" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/d/8491ac/48.png" class="avatar"> DanilaL:</div>
<blockquote>
<p>как мне трафик вернуть обратно</p>
</blockquote>
</aside>
<p>Через NAT.</p>
<p>Если на ru-vps настроены два тунеля входящий <em>tun_ingress</em> и исходящий <em>tun_egress</em> то можно настроить NAT примерно так:</p>
<details>
<summary>
</summary>
<ol>
<li>Добавить в <code>/etc/iproute2/rt_tables</code> именованную таблицу, например <code>128 transit</code>.</li>
<li>Добавить входящий интерфейс в неё <code>ip rule add iif tun_ingress table transit</code></li>
<li>Добавить шлюз <code>ip route add default via адрес_шлюза_из_tun_egress table transit</code></li>
<li>В брандмауэре создать зону для входящего трафика <code>firewall-cmd --permanent --new-zone="ingress_zone"</code></li>
<li>Добавить к ней входящий интерфейс <code>firewall-cmd --permanent --zone="ingress_zone" --add-interface=tun_ingress</code></li>
<li>Создать зону для исходящего трафика <code>firewall-cmd --permanent --new-zone="egress_zone"</code></li>
<li>Добавить к ней исходящий интерфейс <code>firewall-cmd --permanent --zone="egress_zone" --add-interface=tun_egress</code></li>
<li>Включить SNAT в исходящей зоне <code>firewall-cmd --permanent --zone="egress_zone" --add-masquerade</code></li>
<li>Создать политику транзита <code>firewall-cmd --permanent --new-policy="in_to_e"</code></li>
<li>Разрешить по умолчанию <code>firewall-cmd --permanent --policy="in_to_e" --set-target=ACCEPT</code></li>
<li>Добавить входящую зону <code>firewall-cmd --permanent --policy="in_to_e" --add-ingress-zone="ingress_zone"</code></li>
<li>Добавить исходящую зону <code>firewall-cmd --permanent --policy="in_to_e" --add-egress-zone="egress_zone"</code></li>
<li>Применить настройки брандмауэра <code>firewall-cmd --reload</code></li>
<li>???</li>
<li>PROFIT</li>
</ol>
</details></td><td>2024-08-13T19:52:43.254Z</td></tr><tr><td>sakontwist</td><td><p>Я все-таки предпочитаю для маршрутизации использовать xray, т.к. это позволяет роутить по доменам и geosite (например geosite:google и т.п.). Обычный роутинг по адресам не дает такой гибкости.<br>
Если уже есть зарубежный vps с xray, то наверное самое простое - весь трафки отдавать в wireguard до этого vps, кроме русских ip, в которые выходить напрямую через провайдера. Получить список ru-ip можно, например, с помощью <a href="https://github.com/furriest/radb-tools" class="inline-onebox">GitHub - furriest/radb-tools: RADB tools</a>, главное чтобы роутер это переварил. Ну а на vps просто натить весь трафик с wg в сторону интернет.</p>
<p>Если же вы хотите сделать более секурную схему, то тогда такой вариант - берется русский vps, до которого кидается WG. Весь трафик заворачивается в WG (default gateway). Как завернуть default и не сломать себе интернет - примеры есть на сайте wireguard.<br>
Далее на ru-vps подхватываете трафик из туннеля wireguard в xray. Например вот так:</p>
<pre><code class="lang-auto">table ip xray {
	chain prerouting {
		type filter hook prerouting priority filter; policy accept;
		ip daddr 127.0.0.0/8 counter return
		ip daddr 224.0.0.0/4 counter return
		ip daddr 240.0.0.0/4 counter return
		ip daddr 255.255.255.255 counter return
		iifname "wg0" ip daddr { &lt;здесь DST-сети и адреса, которые не надо заворачивать в xray&gt; } counter return comment "ip no tproxy"
		ip saddr { &lt;здесь SRC-сети и адреса, которые не надо заворачивать в xray &gt; } counter return
		iifname "wg0" meta l4proto { tcp, udp } th dport { 80, 443 } counter meta mark set 0x00000001 tproxy to 127.0.0.1:12345 accept comment "capture to tproxy"
	}
}
</code></pre>
<p>Соответственно весь трафик на 80 и 443 попадает на порт 12345, где слушает xray:</p>
<pre><code class="lang-auto">  "inbounds": [
    {
      "tag": "in-tproxy",
      "listen":"127.0.0.1","port": 12345,
      "protocol": "dokodemo-door",
      "settings": {
        "followRedirect": true,
        "network":"tcp,udp"
      },
      "streamSettings": {
        "sockopt": {
          "tproxy": "tproxy"
        }
      },
      "sniffing": {
        "enabled": true,
        "destOverride": ["http", "tls", "quic", "fakedns"],
        "routeOnly": true
      }
    },
...
</code></pre>
<p>Затем уже внутри роутинга xray крутите куда угодно по странам, доменам, адресам, протоколам - часть напрямую, часть в бан, часть на зарубежные vps (причем любым способом связи - vless/wg/shadowsocks)</p>
<p>Ну либо есть еще один хитрый способ выделять нужный трафик и отправлять его в xray - fakeDNS. Когда xray работает как DNS-сервер, он может отдавать вместо реальных ip указанный вами диапазон:</p>
<pre><code class="lang-auto">	"dns": {
    	"servers": [
    		{
        		"address": "127.0.0.1","skipFallback": false   # -- это выход на локальный dns-ресолвер (unbound/dnscrypt)
    		},
			{
				"address": "fakedns",
				"domains": [
                	"geosite:instagram",
                	"geosite:microsoft",
                	"geosite:facebook",
                	"geosite:dell",
                	"geosite:twitter",
                	"full:play.google.com",
                	"full:yt3.ggpht.com",
                	"domain:proton.me",
                	"domain:sagernet.org"
		]
	},
	"fakedns": {
    	"ipPool": "192.168.192.0/22",
    	"poolSize": 1022
    }
</code></pre>
<p>Дальше нужно только подхватить все пакеты на этот пул и отправить куда вам надо для обхода - wireguard / tproxy / socks… Но подхватить этот трафик должен тот xray, который выдал fake-адреса, потому что он выполняет обратную подмену на реальные ip.</p></td><td>2024-08-14T08:11:00.634Z</td></tr><tr><td>Obema(Obema)</td><td><p>У меня как раз настроена схема с мини-пк. На минипк установлен proxmox, а также вставлена сетевуха на 4 порта по 2,5 Гбит. На proxmox настроена виртуалка с openwrt и туда проброшена сетевуха. Что касается роутинга, то настроить схему - заблокированные ресурсы через европейский vds, а остальные через ru vds очень просто - ставите sing box на openwrt и далее создаете два outbound (один для русского vds, а второй для европейского)и далее в роутинге прописываете какие домены идут в ru outbound, а какие в eu outbound</p></td><td>2024-08-16T06:19:02.196Z</td></tr><tr><td>s.v.d(00svd00)</td><td><p>У меня уже достаточно давно живёт такая схема. Есть апельсинка (Orange PI zero 3, сменила Raspberry pi 2B на этом посту), на которой крутятся всевозможные роутеры в скрытосети и прочие радости(i2p, tor, yggdrasil, opera proxy, dpitunnel) и собственно инсталляция xray, которая на входе имеет Wireguard интерфейс, а выходом смотрит либо в дикий интернет(туда заворачивается траффик на ру домены и торренты), либо через VLESS на импортный VPS. В качестве роутера некротик, где заворот траффика в local-wireguard(идущий в xray) осуществялется либо по ручками добавленным адрес листам, либо правилом по tls-host, которым в эти же листы адреса добавляются временно на 48 часов(актуально для сервисов с диким количеством хостов, типа как раз ютьюба). При этом всей домашней сети сам некротик прописан как DNS сервер, так что такой заворот работат в т.ч. и для хостов за CDN (т.к. получается что компы в ЛВС резолвят адрес хоста в тот же IP, что и в адрес листах самого некротика ибо подхватывают их из кеша). Ну и соотв. весь траффик, идущий на эти адреса mangle-ом отправляются в отдельную таблицу маршрутизации, которая заворачивается в этот самый локальный wireguard. Задержки оно почти не добавляет, буквально +1мс пинга. На импортном VPS соотв тоже есть выходы в дикий интернет и в Cloudflare WARP(куда заворачиваются опять же все РУ адреса по гео. Очень важно не ходить с иностранного впс до ру доменов, высоки шансы блокировки)<br>
Ну и для i2p\tor заворот осуществляется через виртуальные DNS записи для всех i2p и onion хостов, а для yggdrasil я когда-то мануал постил на их вику на соотв. странице в комментах, там длинно.</p></td><td>2024-08-16T08:33:15.180Z</td></tr><tr><td>xofamim548</td><td><aside class="quote no-group quote-modified" data-username="s.v.d" data-post="28" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/s.v.d/48/6091_2.png" class="avatar"> s.v.d:</div>
<blockquote>
<p>Есть апельсинка […] выходом смотрит либо в дикий интернет(туда заворачивается траффик на ру домены и торренты)</p>
</blockquote>
</aside>
<aside class="quote no-group" data-username="s.v.d" data-post="28" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/s.v.d/48/6091_2.png" class="avatar"> s.v.d:</div>
<blockquote>
<p>На импортном VPS соотв тоже есть выходы в дикий интернет и в Cloudflare WARP(куда заворачиваются опять же все РУ адреса по гео. Очень важно не ходить с иностранного впс до ру доменов, высоки шансы блокировки)</p>
</blockquote>
</aside>
<p>Я не совсем понял, а зачем вы в двух местах это делаете?</p></td><td>2024-08-16T09:09:19.008Z</td></tr><tr><td>s.v.d(00svd00)</td><td><p>Потому что я туда же иногда подключаюсь напрямую с телефона когда не дома.</p></td><td>2024-08-16T09:18:04.721Z</td></tr><tr><td>DanilaL</td><td><p>Спасибо, конфиги очень помогут в понимании!</p>
<p>У меня только есть пару вопросов: что именно нужно указывать в следующие строки конфигурации nftables</p>
<aside class="quote no-group" data-username="sakontwist" data-post="26" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/s/c77e96/48.png" class="avatar"> sakontwist:</div>
<blockquote>
<pre><code class="lang-auto">iifname "wg0" ip daddr { &lt;здесь DST-сети и адреса, которые не надо заворачивать в xray&gt; } counter return comment "ip no tproxy"
ip saddr { &lt;здесь SRC-сети и адреса, которые не надо заворачивать в xray &gt; } counter return
		
</code></pre>
</blockquote>
</aside>
<p>Насколько критично то, что я ничего не указывал? Можете привести какой-нибудь пример?</p>
<p>В процессе настройки я столкнулся со следующим, довольно странным поведением:</p>
<ol>
<li>Купил RU-VPS в МСК</li>
<li>Поставил wg-easy и создал туннель</li>
<li>Присоединился с телефона, в итоге доступен, например, инстаграмм. Никаких конфигов nft, никаких sing-box я не ставил. Но позже я проверил, что недоступен ntc.party, <a href="http://linkedin.com" rel="noopener nofollow ugc">linkedin.com</a>.</li>
</ol>
<p>Проверил на двух разных RU-VPS у двух разных провайдеров. Поведение идентичное. С чем оно может быть связано?</p>
<p>Но благодаря вашим примерам конфигов я смог настроить схему WG client → VPS (wg tun to port 12345, sing-box inbound 127.0.0.1:12345 → eu vps).</p>
<p>Я могу как-то 100% убедиться в том, что sing-box работает? Логи и прочее.<br>
Когда была схема подключения iOS client → eu-vps, там я отчетливо видел, что при посещении каких-либо ру сайтов, которые определяют местоположение по IP, они определяли что я в России. В то время  <a href="http://speedtest.net" rel="noopener nofollow ugc">speedtest.net</a> показывал мне локацию EU-VPS.<br>
При реализации схемы с двумя VPS (Ru + Eu) перестали работать различные сервисы, например chatGTP (<a href="http://openai.com" rel="noopener nofollow ugc">openai.com</a>). При прямом подключении к eu vps - работает отлично (openai)</p></td><td>2024-08-18T17:30:55.020Z</td></tr><tr><td>sakontwist</td><td><p>Здесь Я указываю адреса, которые не должны попадать в xray (в вашем случае в singbox). Например: телефон в домашней сети и я хочу с него подключиться к ru-черверу в МСК (просто проверить работу v2ray после правок) если не указать здесь dst-адрес сервера, то подключение пойдет через tproxy - home_inbound - wg-out - wg-in - msk_inbound, а это не нужно.</p>
<p>Насчёт логов в singbox не подскажу, но в xray (который по сути форк), есть раздел logs, который позволяет настроить логгирование dns, а также access.log, error.log и уровень событий.</p>
<p>Что и как блокирует провайдер и блокирует ли - непредсказуемо. Зависит от его масштаба и юрисдикции. И наличия Ревизора и ТСПУ, а также провайдеров на аплинке. Бывает что практически блокировок нет, только DNS местный, который и убивает ответы на запрещенку. А бывает что все прикрыто “как положено”, но рутрекер работает)</p></td><td>2024-08-18T17:36:01.170Z</td></tr><tr><td>DanilaL</td><td><p>Тогда не совсем понимаю, почему не работает openai? Почему-то пытаемся его получить из ru vps?</p></td><td>2024-08-18T17:53:04.639Z</td></tr><tr><td>sakontwist</td><td><aside class="quote no-group" data-username="DanilaL" data-post="31" data-topic="9125">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/d/8491ac/48.png" class="avatar"> DanilaL:</div>
<blockquote>
<p>127.0.0.1:12345</p>
</blockquote>
</aside>
<p>Нужно проверять, что происходит после попадания трафика в ядро singbox. Во-первых, как обрабатывается dns в этой схеме. Во-вторых, работает ли sniffing. Запросы с transparent proxy не содержат никакой информации о домене и приложение должно их получить из сессии, чтобы роутинг мог понять, в какой outbound направлять трафик.</p></td><td>2024-08-18T20:51:16.942Z</td></tr><tr><td>AJleKcAHgP68</td><td><p>У меня очень давно работает такая схема<br>
Vps сервер с протоколом VPN ↔ роутер с системой OpenWRT<br>
На роутере настроено следующее:<br>
Sing-box с протоколом vless reality в качестве интерфейса vpn<br>
Ruantiblock для умного перенаправления трафика<br>
Хороший трафик идет напрямую, заблокированный через vpn</p>
<p>Последний раз переделывал все по этому <a href="https://4pda.to/forum/index.php?showtopic=1085698&amp;view=findpost&amp;p=129238063" rel="noopener nofollow ugc">гайду с 4pda</a> но вместо shadowsocks за строкой outbounds прописывал свой протокол vless reality<br>
Конфигурацию вытащил из nekobox путем импорта в файл<br>
Копируется все начиная от открытой квадратной скобки<br>
Outbounds [<br>
До закрытия этой скобки<br>
]<br>
Все остальное расписано в гайде, гайд доступен только при использовании vpn</p>
<details>
<summary>
Спойлер</summary>
<p><div class="lightbox-wrapper"><a class="lightbox" href="настройка-vpn-для-всей-домашней-сети/78b0b2db39c84ab50366fdada8a1fbc053725870.jpeg" data-download-href="https://ntc.party/uploads/default/78b0b2db39c84ab50366fdada8a1fbc053725870" title="Screenshot_2024-08-19-00-17-12-785_bin.mt.plus.canary"><img src="настройка-vpn-для-всей-домашней-сети/78b0b2db39c84ab50366fdada8a1fbc053725870_2_225x500.jpeg" alt="Screenshot_2024-08-19-00-17-12-785_bin.mt.plus.canary" data-base62-sha1="hdFS2mmunUQaO09aFj4Jbf6jtfO" width="225" height="500" srcset="настройка-vpn-для-всей-домашней-сети/78b0b2db39c84ab50366fdada8a1fbc053725870_2_225x500.jpeg, настройка-vpn-для-всей-домашней-сети/78b0b2db39c84ab50366fdada8a1fbc053725870_2_337x750.jpeg 1.5x, настройка-vpn-для-всей-домашней-сети/78b0b2db39c84ab50366fdada8a1fbc053725870_2_450x1000.jpeg 2x" data-dominant-color="2F3539"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Screenshot_2024-08-19-00-17-12-785_bin.mt.plus.canary</span><span class="informations">1080×2400 185 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
</details>
<p>P.s данные сервера изменены, не пытайтесь подключиться - бесполезно</p>
<p>В списках пользователя добавляю такие домены</p>
<details>
<summary>
Спойлер</summary>
<pre><code class="lang-auto">
#YOUTUBE
youtube.com
google.com
www.youtube.com
m.youtube.com
s.youtube.com
ytimg.com
s.ytimg.com
i.ytimg.com
ytimg.l.google.com
youtube.l.google.com
i.google.com
googlevideo.com
youtu.be
yt.be
accounts.youtube.com
consent.youtube.com
realtimesupport.youtube.com
studio.youtube.com
i9.ytimg.com
i.ytimg.com
yt3.ggpht.com
ggpht.com
youtubekids.com
googleusercontent.com
googleapis.com
youtubei.googleapis.com
notifications-pa.googleapis.com
gstatic.com
suggestqueries.google.com
# Прочее
habr.com
hdrezka.ag
rezka.ag
ntc.party
#Темная сторона 4pda
4pda.ru
4pda.ws
4pda.to

</code></pre>
</details></td><td>2024-08-18T21:17:50.718Z</td></tr><tr><td>BrOleg5</td><td><p>Тут ещё стоит отметить, что OpenAI не любит IP адреса всяких хостеров VPS (non-residental ip). Я с этим столкнулся и решил с помощью направления трафика с прокси в европе для домена openai на Cloudflare Warp. Делал как в <a href="https://habr.com/ru/articles/770400/comments/#comment_26158094" rel="noopener nofollow ugc">этом коментарии</a>. Таким образом у меня работают ChatGPT и MS Copilot.</p></td><td>2024-08-20T09:57:35.630Z</td></tr><tr><td>pinapun</td><td><p>У меня стоит похожая задача. Хочу настроить раздачу wifi с ВПН (vless+xtls-reality), чтобы все подключившиеся клиентские устройства прозрачно через него ходили. Вопрос что для этого проще всего взять? Есть базовое понимание работы с Linux, могу что-то настроить по гайдам. Думаю взять raspberry pi, подключить его к основному роутеру кабелем и раздавать с него wifi. Но вот конкретного гайда что ставить на расбери и как это настраивать я не нашел. Я даже не знаю какой расбери для этого лучше взять, что именно на него ставить и как это настраивать. Есть какой-то гайд на эту тему?</p></td><td>2024-08-22T15:11:21.972Z</td></tr><tr><td>0ka(0ka)</td><td><p>раздавать вайфай с raspberry не обязательно, написал в лс</p></td><td>2024-08-22T15:21:23.726Z</td></tr>
    </table>
      </body>
    </html>