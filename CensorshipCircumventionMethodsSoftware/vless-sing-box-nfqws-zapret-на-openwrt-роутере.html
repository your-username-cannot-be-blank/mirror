
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>vless-sing-box-nfqws-zapret-на-openwrt-роутере</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>inside</td><td><p>Привет! Хочу в домашней сети настроить всё так, чтобы отдельные клиенты трогать никогда не приходилось, но трафик в итоге ходил оптимально на уровне роутера:</p>
<ol>
<li>Если блокировка со стороны зарубежных серверов, тогда трафик идёт через vless reality на зарубежный VPS</li>
<li>Если блокировка изнутри, тогда трафик модифицируется bol-van/zapret через nfqws</li>
<li>Иначе трафик чистый</li>
</ol>
<p>На OpenWRT-роутере установлены и настроены zapret (nfqws) и sing-box.<br>
sing-box запускает inbounds tun, а в route/rules есть правила которые часть трафика перенаправляют в outbounds/vless.</p>
<p>По отдельности оба сервиса работают. Вместе - нет: перестаёт давать результат zapret, хотя он остаётся запущенным.</p>
<p>В сетях понимаю мало, но видимо пришла пора разобраться.<br>
Прошу совету у знающих - вообще возможно ли достичь желаемого?<br>
И если да, то как это принципиально должно работать?</p>
<p>Дополнение: sing-box настраивал по этой статье <a href="https://telegra.ph/Nastrojka-sing-box-openwrt-09-28" class="inline-onebox" rel="noopener nofollow ugc">Настройка sing-box (openwrt) – Telegraph</a></p></td><td>2024-10-20T16:16:16.105Z</td></tr><tr><td>karas_bumbum</td><td><p>Привет!<br>
У тебя получилось подружить оба сервиса?</p></td><td>2024-12-02T17:10:19.114Z</td></tr><tr><td>inside</td><td><p>Прогресс нулевой и времени заниматься этим к сожалению сейчас нет. Но если что-то сделаю, обязательно напишу и здесь.</p>
<p>На всякий случай оставлю здесь релевантные темы, может кого-то наведёт на мысль.<br>
И было бы хорошо, если бы он этой мыслью поделился, потому что я пока даже не понимаю в каком направлении двигаться.</p>
<aside class="onebox githubissue" data-onebox-src="https://github.com/bol-van/zapret/issues/619#issuecomment-2432964925">
  <header class="source">

      <a href="https://github.com/bol-van/zapret/issues/619#issuecomment-2432964925" target="_blank" rel="noopener nofollow ugc">github.com/bol-van/zapret</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Issue" data-github-private-repo="false">
	  <svg width="60" height="60" class="github-icon" viewBox="0 0 14 16" aria-hidden="true"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="https://github.com/bol-van/zapret/issues/619#issuecomment-2432964925" target="_blank" rel="noopener nofollow ugc">openvpn tun0 nfqws</a>
    </h4>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2024-10-19" data-time="09:49:23" data-timezone="UTC">09:49AM - 19 Oct 24 UTC</span>
      </div>

        <div class="date">
          closed <span class="discourse-local-date" data-format="ll" data-date="2024-11-24" data-time="18:35:50" data-timezone="UTC">06:35PM - 24 Nov 24 UTC</span>
        </div>

      <div class="user">
        <a href="https://github.com/Sergey-nqwfs" target="_blank" rel="noopener nofollow ugc">
          <img alt="Sergey-nqwfs" src="vless-sing-box-nfqws-zapret-на-openwrt-роутере/06c30443a43a7c558193b5fc57f3aef8d9485756.png" class="onebox-avatar-inline" width="20" height="20" data-dominant-color="DEE4EC">
          Sergey-nqwfs
        </a>
      </div>
    </div>

    <div class="labels">
    </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">Добрый день, а как пропустить трафик через nfqws с openvpn 172.16.2.0/24 tun0, н<span class="show-more-container"><a href="" rel="noopener" class="show-more">…</a></span><span class="excerpt hidden">ужны ли какие то правила iptables? И зачем еще параметр IFACE_LAN, там нкжно указывать tun0?</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<blockquote>
<p>Вобщем openvpn тоже работает с Masquarde -eth0, больше ничего не надо.<br>
Для сокрытия openvpn я когда-то использовал stunnel в режиме точка-точка.</p>
</blockquote>
<hr>
<aside class="onebox githubissue" data-onebox-src="https://github.com/bol-van/zapret/issues/313#issuecomment-2302540370">
  <header class="source">

      <a href="https://github.com/bol-van/zapret/issues/313#issuecomment-2302540370" target="_blank" rel="noopener nofollow ugc">github.com/bol-van/zapret</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Issue" data-github-private-repo="false">
	  <svg width="60" height="60" class="github-icon" viewBox="0 0 14 16" aria-hidden="true"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="https://github.com/bol-van/zapret/issues/313#issuecomment-2302540370" target="_blank" rel="noopener nofollow ugc">Есть ли обход блокировок dpi + vpn?</a>
    </h4>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2024-08-21" data-time="16:34:34" data-timezone="UTC">04:34PM - 21 Aug 24 UTC</span>
      </div>

        <div class="date">
          closed <span class="discourse-local-date" data-format="ll" data-date="2024-08-24" data-time="18:57:07" data-timezone="UTC">06:57PM - 24 Aug 24 UTC</span>
        </div>

      <div class="user">
        <a href="https://github.com/ko22009" target="_blank" rel="noopener nofollow ugc">
          <img alt="ko22009" src="vless-sing-box-nfqws-zapret-на-openwrt-роутере/3a94c6590198c0c8e2a51dbe7c7d5ec016fc5fbe.jpeg" class="onebox-avatar-inline" width="20" height="20" data-dominant-color="46798B">
          ko22009
        </a>
      </div>
    </div>

    <div class="labels">
        <span style="display:inline-block;margin-top:2px;background-color: #B8B8B8;padding: 2px;border-radius: 4px;color: #fff;margin-left: 3px;">
          question
        </span>
    </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">Интересует дурение dpi youtube, а также возможность ручного добавление списка об<span class="show-more-container"><a href="" rel="noopener" class="show-more">…</a></span><span class="excerpt hidden">хода, чтобы ходить через vpn к ним.

И вопрос такой, есть ли способ принудительного vpn если dpi не отработал?</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<blockquote>
<p>это делается либо через policy routing на linux по IP адресам,<br>
либо через высокоуровневые прокси-решения типа xray - по доменам</p>
</blockquote>
<hr>
<aside class="onebox githubissue" data-onebox-src="https://github.com/bol-van/zapret/issues/225">
  <header class="source">

      <a href="https://github.com/bol-van/zapret/issues/225" target="_blank" rel="noopener nofollow ugc">github.com/bol-van/zapret</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Issue" data-github-private-repo="false">
	  <svg width="60" height="60" class="github-icon" viewBox="0 0 14 16" aria-hidden="true"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="https://github.com/bol-van/zapret/issues/225" target="_blank" rel="noopener nofollow ugc">Перестал работать VPN Split Tunneling</a>
    </h4>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2024-08-05" data-time="18:02:13" data-timezone="UTC">06:02PM - 05 Aug 24 UTC</span>
      </div>

        <div class="date">
          closed <span class="discourse-local-date" data-format="ll" data-date="2024-11-24" data-time="18:31:50" data-timezone="UTC">06:31PM - 24 Nov 24 UTC</span>
        </div>

      <div class="user">
        <a href="https://github.com/thenicholas" target="_blank" rel="noopener nofollow ugc">
          <img alt="thenicholas" src="vless-sing-box-nfqws-zapret-на-openwrt-роутере/c5d72e4e6f65483d2018051499248ae65fe88e90.png" class="onebox-avatar-inline" width="20" height="20" data-dominant-color="D2C9E6">
          thenicholas
        </a>
      </div>
    </div>

    <div class="labels">
    </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">Роутер с OpenWRT. У меня установлен пакет pbr, добавлен интерфейс Wireguard. Сог<span class="show-more-container"><a href="" rel="noopener" class="show-more">…</a></span><span class="excerpt hidden">ласно правилам pbr траффик на определенные в списке домены идет через интерфейс Wireguard, остальной траффик - напрямую через Wan. После установки zapret ютуб престал тормозить и открываются заблокированные сайты, но теперь весь траффик идет через Wan. Как мне сделать так, чтобы как и прежде, трафик подпадающий под правила pbr шел через интерфейс Wireguard?</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<blockquote>
<p>Роутер с OpenWRT. У меня установлен пакет pbr, добавлен интерфейс Wireguard.<br>
Согласно правилам pbr траффик на определенные в списке домены идет через<br>
интерфейс Wireguard, остальной траффик - напрямую через Wan</p>
</blockquote>
<p><a href="https://openwrt.org/docs/guide-user/network/routing/pbr" class="onebox" target="_blank" rel="noopener nofollow ugc">https://openwrt.org/docs/guide-user/network/routing/pbr</a></p></td><td>2024-12-02T21:08:39.076Z</td></tr><tr><td>lrlunin(Lunin Leonid)</td><td><p>Мне на днях должен роутер прийти, буду тоже ковыряться. Хотел сделать то же самое что и вы, может быть скорее zapret с фоллбеком на прокси. Есть ощущение, что как будто проблема должна решиться добавлением сетевого интерфейса прокладки, хотя опыта у меня тоже немного.</p></td><td>2024-12-03T09:50:27.667Z</td></tr><tr><td>AndreyRz(Andrey Rz)</td><td><p>По поводу части с vless realty, у меня установлен <a href="https://github.com/yichya/luci-app-xray" rel="noopener nofollow ugc">yichya/luci-app-xray: (Almost) full feature Xray client for OpenWrt</a>, добавлен сервер на первой вкладке, все остальное отключено, inbounds и lan host access все пустое должно быть, во вкладке dns убирается все что предзаполнено и настраиваются чисто основной и дополнительный днс, во вкладке fakedns все поля пустые, внизу создаёшь правила по сатам, либо через geosite если уже есть профиль в v2ray-geosite, либо domain как например этот форум, во вкладке outbound routing опять же все предустановленное удаляешь, Default Ports Policy bypass ставишь и указываешь порты, у меня тсп 80, 443, 853, удп 53 и 443, все остальное можно не трогать. Один прикол есть, при добавлении сервака в [vless][reality] Server Name должен быть домен сайта в одном виде, в панельке например (3)x-ui можно указать с www и без, но должно быть что-то одно,  с двумя указанными в настройке клиента работать не будет. Так же можно свой список geosite собрать по инструкции из репозитория там же. И так и не понял почему, без отключения клиента, opkg в openwrt не может нормально к своим репозиториям подключится соответственно отключать на время обновления или установки пакетов.</p></td><td>2024-12-14T10:07:07.531Z</td></tr><tr><td>drnkct</td><td><p>У меня вроде получилось сделать то, что ты хочешь. У самого Keenetic Giga-1012.</p>
<p>Установлен XKeen + nfqws zapret</p>
<p>запрет настраивал по этой инструкции: <a href="https://github.com/Anonym-tsk/nfqws-keenetic" rel="noopener nofollow ugc">GitHub - Anonym-tsk/nfqws-keenetic</a></p></td><td>2024-12-30T17:16:26.844Z</td></tr>
    </table>
      </body>
    </html>