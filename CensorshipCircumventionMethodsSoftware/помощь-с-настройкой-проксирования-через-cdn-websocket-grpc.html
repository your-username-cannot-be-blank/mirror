
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>помощь-с-настройкой-проксирования-через-cdn-websocket-grpc</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>Kisliy(Андрей)</td><td><p>Всех приветствую! <img src="https://ntc.party/images/emoji/twitter/sunglasses.png?v=12" title=":sunglasses:" class="emoji" alt=":sunglasses:" loading="lazy" width="20" height="20"><br>
Решил овладеть методом “Websocket вместе с XTLS-Reality” по этой замечательной инструкции: <a href="https://habr.com/ru/articles/761798/" rel="noopener nofollow ugc">Особенности проксирования через CDN/Websocket/gRPC для обхода блокировок</a>.</p>
<p>Увы, что-то пошло не так и при выполнении теста Nekobox в журнале пишет: <em>ошибка теста: Get “<a href="http://cp.cloudflare.com/" rel="noopener nofollow ugc">http://cp.cloudflare.com/</a>”: websocket: bad handshake: HTTP 301 301 Moved Permanently.</em></p>
<p>Поиск в интернете ничего не дал <img src="https://ntc.party/images/emoji/twitter/unamused.png?v=12" title=":unamused:" class="emoji" alt=":unamused:" loading="lazy" width="20" height="20"><br>
Подскажите пожалуйста что может вызывать такую ошибку или в какую сторону “копать”?</p></td><td>2024-05-08T22:35:48.362Z</td></tr><tr><td>0ka(0ka)</td><td><p>xtls или reality не могут работать через cdn, особенности протоколов</p></td><td>2024-05-08T22:40:38.356Z</td></tr><tr><td>ilyaigpetrov(ilyaigpetrov)</td><td><aside class="quote no-group" data-username="Kisliy" data-post="1" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>301 Moved Permanently.</p>
</blockquote>
</aside>
<p>Фраза переводится как “301 Перемещено перманентно/постоянно”.<br>
Возможно, стоит откопать новый адрес, на который происходит перенаправление, и заменить им старый.</p></td><td>2024-05-08T22:45:15.707Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="ilyaigpetrov" data-post="3" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/i/5fc32e/48.png" class="avatar"> ilyaigpetrov:</div>
<blockquote>
<p>Фраза переводится как “301 Перемещено перманентно/постоянно”.<br>
Возможно, стоит откопать новый адрес, на который происходит перенаправление, и заменить им старый.</p>
</blockquote>
</aside>
<p>Зачем менять адрес, если на прямую, минуя CDN, всё исправно работает?</p>
<aside class="quote no-group" data-username="0ka" data-post="2" data-topic="7828" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/0/d78d45/48.png" class="avatar"> 0ka:</div>
<blockquote>
<p>xtls или reality не могут работать через cdn, особенности протоколов</p>
</blockquote>
</aside>
<p>В статье это указано, если не читали, автор подключается к серверу без xtls или reality.</p></td><td>2024-05-08T22:58:42.626Z</td></tr><tr><td>ilyaigpetrov(ilyaigpetrov)</td><td><aside class="quote no-group" data-username="Kisliy" data-post="4" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>Зачем менять адрес, если на прямую, минуя CDN, всё исправно работает?</p>
</blockquote>
</aside>
<p>Так и напрямую может происходить перенаправление, которого вы не успеваете заметить.<br>
Сравните изначальный адрес с конечным.</p>
<p>Я далёк от темы вопроса, не знаю, какой именно адрес перенаправляется --, может, это не тот, что вы ожидаете.</p></td><td>2024-05-08T23:05:43.080Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="ilyaigpetrov" data-post="5" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/i/5fc32e/48.png" class="avatar"> ilyaigpetrov:</div>
<blockquote>
<p>Так и напрямую может происходить перенаправление, которого вы не успеваете заметить.<br>
Сравните изначальный адрес с конечным.</p>
<p>Я далёк от темы вопроса, не знаю какой именно адрес перенаправляется --, может, это не тот, что вы ожидаете.</p>
</blockquote>
</aside>
<p>Конечно, я ожидал, что сразу будет всё работать <img src="https://ntc.party/images/emoji/twitter/slightly_smiling_face.png?v=12" title=":slightly_smiling_face:" class="emoji" alt=":slightly_smiling_face:" loading="lazy" width="20" height="20"><br>
Выходные адреса я не сравню, так как не работает интернет, пока не исправлю “websocket: bad handshake…”.<br>
Т. е. вы ещё не настраивали таким методом, попробуйте, пригодится как-нибудь.</p>
<aside class="quote no-group quote-modified" data-username="0ka" data-post="2" data-topic="7828" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/0/d78d45/48.png" class="avatar"> 0ka:</div>
<blockquote>
<p> </p>
</blockquote>
</aside>
<p>А вы настраивали таким способом, который описан в статье?</p></td><td>2024-05-09T07:49:39.363Z</td></tr><tr><td>Xunlei</td><td><p>У вас перенаправление идёт на <code>https://cp.cloudflare.com/</code>.</p></td><td>2024-05-09T11:23:00.252Z</td></tr><tr><td>0ka(0ka)</td><td><p>нет, во первых там про вебсокет, а во вторых на этом домене нет перенаправления на https.<br>
что хочет автор темы непонятно</p></td><td>2024-05-09T11:26:14.941Z</td></tr><tr><td>Uporoty(Uporoty)</td><td><p>В параметрах Cloudflare включено проксирование вебсокетов?</p>
<p>Если используете Nginx или Caddy, посмотрите ещё логи сервера в момент подключения. Либо попробуйте настроить вообще без веб-сервера, на Хабре пару месяцев назад статья была с этим вариантом (ее забаеил РКН, но VPN она всё ещё доступна)</p></td><td>2024-05-09T18:40:47.341Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="Uporoty" data-post="9" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>В параметрах Cloudflare включено проксирование вебсокетов?</p>
</blockquote>
</aside>
<p>Да, конечно, только у меня Gcore. Журнал теста в nekobox:</p>
<pre><code class="lang-auto">INFO[0000] dns: exchanged xxx.dns.com CNAME github.ddnsfree.com. 60 IN CNAME cl-gl5d09f09a.gcdn.co.
INFO[0000] dns: exchanged xxx.dns.com A cl-gl5d09f09a.gcdn.co. 60 IN A 81.28.12.12
INFO[0000] dns: exchanged xxx.dns.com CNAME github.ddnsfree.com. 60 IN CNAME cl-gl5d09f09a.gcdn.co.
INFO[0000] dns: exchanged xxx.dns.com AAAA cl-gl5d09f09a.gcdn.co. 60 IN AAAA 2a03:90c0:999c::12
[[VLESS] VLESS (SNI‑proxy over Websocket)] ошибка теста: Get "http://cp.cloudflare.com/": websocket: bad handshake: HTTP 301 301 Moved Permanently
</code></pre>
<aside class="quote no-group" data-username="Uporoty" data-post="9" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Если используете Nginx или Caddy, посмотрите ещё логи сервера в момент подключения.</p>
</blockquote>
</aside>
<p>Посмотрел, что-то не густо там:<br>
/var/log/nginx/<strong>access.log</strong> вообще пустой.<br>
/var/log/nginx/<strong>error.log</strong> видимо после перезагрузки пишет что-то:<br>
<em>2024/05/10 17:33:04 [notice] 649#649: signal 15 (SIGTERM) received from 1807, exiting</em><br>
<em>2024/05/10 17:33:04 [notice] 651#651: exiting</em><br>
<em>2024/05/10 17:33:04 [notice] 651#651: exit</em><br>
<em>2024/05/10 17:33:04 [notice] 649#649: signal 17 (SIGCHLD) received from 651</em><br>
<em>2024/05/10 17:33:04 [notice] 649#649: worker process 651 exited with code 0</em><br>
<em>2024/05/10 17:33:04 [notice] 649#649: exit</em><br>
<em>2024/05/10 17:33:32 [notice] 619#619: using the “epoll” event method</em><br>
<em>2024/05/10 17:33:32 [notice] 619#619: nginx/1.26.0</em><br>
<em>2024/05/10 17:33:32 [notice] 619#619: built by gcc 9.4.0 (Ubuntu 9.4.0-1ubuntu1~20.04.2)</em><br>
<em>2024/05/10 17:33:32 [notice] 619#619: OS: Linux 5.4.0-177-generic</em><br>
<em>2024/05/10 17:33:32 [notice] 619#619: getrlimit(RLIMIT_NOFILE): 1024:524288</em><br>
<em>2024/05/10 17:33:32 [notice] 631#631: start worker processes</em><br>
<em>2024/05/10 17:33:32 [notice] 631#631: start worker process 632</em></p>
<aside class="quote no-group" data-username="Uporoty" data-post="9" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Либо попробуйте настроить вообще без веб-сервера</p>
</blockquote>
</aside>
<p>В процессе настройки было как-то, заходил через браузер и видел Ngix страницу, думаю это ничего не даст.</p>
<aside class="quote no-group" data-username="Xunlei" data-post="7" data-topic="7828" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/8e7dd6/48.png" class="avatar"> Xunlei:</div>
<blockquote>
<p>У вас перенаправление идёт на <code>https://cp.cloudflare.com/</code>.</p>
</blockquote>
</aside>
<p>В настройках nekobox - url теста задержки прописан <a href="http://cp.cloudflare.com" rel="noopener nofollow ugc">http://cp.cloudflare.com</a>, так что всё нормально здесь.</p>
<aside class="quote no-group" data-username="0ka" data-post="8" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/0/d78d45/48.png" class="avatar"> 0ka:</div>
<blockquote>
<p>что хочет автор темы непонятно</p>
</blockquote>
</aside>
<p>После подключения клиента nekobox к серверу nginx, должна произойти переадресация на сервер x-ray, который пропустит во внешний инет. Вот содержимое файлов конфигурации nginx:<br>
/etc/nginx/<strong>nginx.conf</strong>:</p>
<pre><code class="lang-auto">user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;
   include /etc/nginx/conf.d/*.conf;
}

stream {
  map $ssl_preread_server_name $backend {
     XXXXXX.com               reality;
      www.XXXXXX.com             local;
      default                  reality;
  }

  upstream reality {
      server 127.0.0.1:8443;
  }

  upstream local {
      server 127.0.0.1:8444;
  }

  server {
      listen          443 reuseport so_keepalive=on;
      ssl_preread     on;
      proxy_pass      $backend;
  }
}
</code></pre>
<p>/etc/nginx/conf.d/<strong>default.conf</strong>:</p>
<pre><code class="lang-auto">server {
	listen 127.0.0.1:8444 so_keepalive=on;
        http2 on;

# ваш домен    
server_name www.XXXXXX.com;

    #access_log  /var/log/nginx/host.access.log  main;

    # сюда можно положить какие-нибудь странички фейкового сайта, или использовать proxy_pass чтобы переадресовать запрос на другой сервер
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    #error_page   500 502 503 504  /50x.html;
    #location = /50x.html {
    #    root   /usr/share/nginx/html;
    #}

# путь к сертификатам, самоподписанным либо от Cloudflare
	ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
	ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;

client_header_timeout 52w;
    keepalive_timeout 52w;
# замените TestChatGRPC на какую-нибудь секретную строку
	location /TestChatGRPC {
		if ($content_type !~ "application/grpc") {
			return 404;
		}
		client_max_body_size 0;
		client_body_buffer_size 512k;
		grpc_set_header X-Real-IP $remote_addr;
		client_body_timeout 52w;
		grpc_read_timeout 52w;
		grpc_pass grpc://127.0.0.1:8888;
	}

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}

# аналогично замените TestChatWS на какую-нибудь другую секретную строку
    location /TestChatWS {
		if ($http_upgrade != "websocket") {
			return 404;
		}
		proxy_pass http://127.0.0.1:8889;
		proxy_redirect off;
	    proxy_http_version 1.1;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection "upgrade";
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    proxy_read_timeout 52w;
	}
}
</code></pre></td><td>2024-05-10T17:24:23.292Z</td></tr><tr><td>Uporoty(Uporoty)</td><td><p>Смотрите какая фигня. Судя по логам веб-сервера, до него ничего не долетает. НО - секция stream по умолчанию ничего не логгирует, а я подозреваю что дело где-то там. У вас стоит условие, что запросы с определенным SNI должны обрабатываться веб-сервером, а все остальное уходить на Reality, то есть на чужой маскировочный сайт.</p>
<p>Можно проверить, сходить <code>curl -v</code> на ваш адрес и URL, куда у вас пытается подключиться Nekoray с вебсокетами и посмотреть  заголовки ответа. Если вы увидите там  домен reality вместо вашего, то истина где-то рядом.</p>
<p>Нужно проверить параметры GCore, там вроде можно чтобы он изменял SNI при проксирование запроса, проверьте что там то же самое, что у вас в Nginx в условии.<br>
Более тупой вариант (для теста, но можно и на постоянку) - сделать так, чтобы веб-сервер с вебсокетами слушал не на 127.0.0.1, а на 0.0.0.0 (задать какой-нибудь нестандартный порт повыше), а в GCore узадать этот порт в параметрах Origin (там можно так делать), чтобы он сразу шел туда напрямую, и посмотреть что получится</p></td><td>2024-05-10T18:40:08.298Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="Uporoty" data-post="11" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Можно проверить, сходить <code>curl -v</code> на ваш адрес и URL, куда у вас пытается подключиться Nekoray с вебсокетами и посмотреть заголовки ответа. Если вы увидите там домен reality вместо вашего, то истина где-то рядом.</p>
</blockquote>
</aside>
<p>На адрес сайта я зашёл, вот:</p>
<pre><code class="lang-auto"> *   Trying XX.XX.12.12:443...
* Connected to ХХХХХddns.com (XX.XX.12.12) port 443
&gt; GET / HTTP/1.1
&gt; Host: ХХХХХddns.com:443
&gt; User-Agent: curl/8.4.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 400 Bad Request
&lt; Server: nginx
&lt; Date: Sat, 11 May 2024 01:51:06 GMT
&lt; Content-Type: text/html
&lt; Content-Length: 248
&lt; Connection: close
&lt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;400 The plain HTTP request was sent to HTTPS port&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;
&lt;center&gt;The plain HTTP request was sent to HTTPS port&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
* Closing connection
</code></pre>
<p>С заходом по URL пришлось повозится, ссылка, которую выдаёт Nekobox, неполная, без нескольких параметров. Я немного по импровизировал с ней, добавил некоторые параметры, и что-то выдалось:</p>
<pre><code class="lang-auto">rdp-user@XXX:~$ vless://XXXX-XXXX-XXXX-XXXX-46e69149af25@ХХХХХddns.com:443?encryption=none&amp;type=ws&amp;path=TestChatWS &amp;ed=2048&amp;eh=Sec-Websocket-Protocol&amp;security=tls&amp;fp=chrome&amp;packetEncoding=xudpс
[87] 3100
bash: vless://XXXX-XXXX-XXXX-XXXX-46e69149af25@ХХХХХddns.com:443?encryption=none: No such file or directory
[88] 3101
[89] 3102
[90] 3103
[91] 3104
[92] 3105
[93] 3106
[84]   Done                    eh=Sec-Websocket-Protocol
[85]   Done                    security=tls
[86]   Done                    fp=chrome
[87]   Exit 127                vless://XXXX-XXXX-XXXX-XXXX-46e69149af25@ХХХХХddns.com:443?encryption=none
[88]   Done                    type=ws
[89]   Done                    path=TestChatWS
[90]   Done                    ed=2048
[91]   Done                    eh=Sec-Websocket-Protocol
</code></pre>
<p>Скриншот окна конфига в nekobox прикрепляю:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/a7f7fcad591bd02a9cef8da8b6e7bdcab33eae1e.png" data-download-href="https://ntc.party/uploads/default/a7f7fcad591bd02a9cef8da8b6e7bdcab33eae1e" title="изображение_2024-05-12_012134919"><img src="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/a7f7fcad591bd02a9cef8da8b6e7bdcab33eae1e_2_682x500.png" alt="изображение_2024-05-12_012134919" data-base62-sha1="nXV2VQ8Gunu47b4uk9Jtrgu22t0" width="682" height="500" srcset="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/a7f7fcad591bd02a9cef8da8b6e7bdcab33eae1e_2_682x500.png, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/a7f7fcad591bd02a9cef8da8b6e7bdcab33eae1e_2_1023x750.png 1.5x, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/a7f7fcad591bd02a9cef8da8b6e7bdcab33eae1e_2_1364x1000.png 2x" data-dominant-color="353434"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">изображение_2024-05-12_012134919</span><span class="informations">1415×1037 45.2 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<aside class="quote no-group" data-username="Uporoty" data-post="11" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Нужно проверить параметры GCore, там вроде можно чтобы он изменял SNI при проксирование запроса, проверьте что там то же самое, что у вас в Nginx в условии.</p>
</blockquote>
</aside>
<p><div class="lightbox-wrapper"><a class="lightbox" href="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/cf288f2bc980f2bab412d5a1bd76a91c8aa4b437.png" data-download-href="https://ntc.party/uploads/default/cf288f2bc980f2bab412d5a1bd76a91c8aa4b437" title="image"><img src="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/cf288f2bc980f2bab412d5a1bd76a91c8aa4b437_2_517x228.png" alt="image" data-base62-sha1="tyBJwgBridVmIkL7zu46p1XiXFt" width="517" height="228" srcset="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/cf288f2bc980f2bab412d5a1bd76a91c8aa4b437_2_517x228.png, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/cf288f2bc980f2bab412d5a1bd76a91c8aa4b437_2_775x342.png 1.5x, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/cf288f2bc980f2bab412d5a1bd76a91c8aa4b437_2_1034x456.png 2x" data-dominant-color="F6F7F8"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">1230×542 52.1 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>В Gcore был установлен параметр динамическое имя хоста. С учётом того что автор реализовал sni через backend, может так и оставить?</p>
<p>Также, пока ковырялся с параметрами, подправил некоторые значения в конфиге nginx и стала выходить ошибка уже с другим номером: ошибка теста: Get “<a href="http://cp.cloudflare.com/" rel="noopener nofollow ugc">http://cp.cloudflare.com/</a>”: websocket: bad handshake: HTTP 502 502 Bad Gateway.</p></td><td>2024-05-11T22:27:41.095Z</td></tr><tr><td>Uporoty(Uporoty)</td><td><aside class="quote no-group" data-username="Kisliy" data-post="12" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p><code>The plain HTTP request was sent to HTTPS port</code></p>
</blockquote>
</aside>
<p>Ну тут ошибка говорит сама за себя. Проверяйте, что у вас там в параметрах Origin на стороне gCore стоит, должен быть HTTPS, а не HTTP.</p>
<aside class="quote no-group" data-username="Kisliy" data-post="12" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>заходом по URL пришлось повозится</p>
</blockquote>
</aside>
<p>Под URL я имел в виду host + path (с https://).</p>
<aside class="quote no-group" data-username="Kisliy" data-post="12" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>Скриншот окна конфига в nekobox прикрепляю</p>
</blockquote>
</aside>
<p>Host пропишите правильный тоже.</p>
<aside class="quote no-group" data-username="Kisliy" data-post="12" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>Gcore был установлен параметр динамическое имя хоста. С учётом того что автор реализовал sni через backend, может так и оставить</p>
</blockquote>
</aside>
<p>Он должен совпадать с тем что указано в конфиге Nginx, иначе не будет работать правило stream.</p>
<aside class="quote no-group" data-username="Kisliy" data-post="12" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>подправил некоторые значения в конфиге nginx</p>
</blockquote>
</aside>
<p>Какие именно?</p></td><td>2024-05-11T22:40:29.882Z</td></tr><tr><td>xor</td><td><p>На скриншоте не видно, т.к. замазано, поэтому хочу упомянуть грабли, на которые довелось наступить мне. В той статье, на которую ты опираешься, Path указан что-то вроде /mypath, у меня так заработало, только если early data length ставить 0. Если early data хочется, то нужно уазывать, например, и early data length 2048 и в пути прописывать /mypath?ed=2048</p></td><td>2024-05-12T00:07:48.152Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="Uporoty" data-post="13" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Ну тут ошибка говорит сама за себя. Проверяйте, что у вас там в параметрах Origin на стороне gCore стоит, должен быть HTTPS, а не HTTP.</p>
</blockquote>
</aside>
<p>Извиняюсь, я не прописал https вначале сайта <img src="https://ntc.party/images/emoji/twitter/frowning.png?v=12" title=":frowning:" class="emoji" alt=":frowning:" loading="lazy" width="20" height="20"><br>
Вот правильный вариант:</p>
<pre><code class="lang-auto">C:\Windows\System32&gt; curl -v https://ХХХХХddns.com:443
*   Trying XX.XX.12.12:443...
* Connected to ХХХХХddns.com (XX.XX.12.12) port 443
* schannel: disabled automatic use of client certificate
* ALPN: curl offers http/1.1
* schannel: next InitializeSecurityContext failed: SEC_E_ILLEGAL_MESSAGE (0x80090326) - This error usually occurs when a fatal SSL/TLS alert is received (e.g. handshake failed). More detail may be available in the Windows System event log.
* Closing connection
* schannel: shutting down SSL/TLS connection with ХХХХХddns.com port 443
curl: (35) schannel: next InitializeSecurityContext failed: SEC_E_ILLEGAL_MESSAGE (0x80090326) - This error usually occurs when a fatal SSL/TLS alert is received (e.g. handshake failed). More detail may be available in the Windows System event log.
</code></pre>
<p>Протокол HTTPS всегда включён был:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7dbc1908356adcb710bc0b8b2047aa0f4b1554d0.png" data-download-href="https://ntc.party/uploads/default/7dbc1908356adcb710bc0b8b2047aa0f4b1554d0" title="image"><img src="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7dbc1908356adcb710bc0b8b2047aa0f4b1554d0_2_345x86.png" alt="image" data-base62-sha1="hWiGfthpmrxIcbNtQw0iXoLT3Z6" width="345" height="86" srcset="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7dbc1908356adcb710bc0b8b2047aa0f4b1554d0_2_345x86.png, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7dbc1908356adcb710bc0b8b2047aa0f4b1554d0_2_517x129.png 1.5x, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7dbc1908356adcb710bc0b8b2047aa0f4b1554d0_2_690x172.png 2x" data-dominant-color="F9F9F9"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">1162×292 15.6 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<aside class="quote no-group" data-username="Uporoty" data-post="13" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Под URL я имел в виду host + path (с https://).</p>
</blockquote>
</aside>
<p>Такого варианта достаточно будет: scheme://username:password@host:port/path?query#fragment   ?</p>
<aside class="quote no-group" data-username="Uporoty" data-post="13" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Host пропишите правильный тоже.</p>
</blockquote>
</aside>
<p>Кстати, у автора тоже не прописан host на скриншоте и ведь строка адрес = строке Host. Хорошо, себе пропишу.</p>
<aside class="quote no-group" data-username="Uporoty" data-post="13" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Он должен совпадать с тем что указано в конфиге Nginx, иначе не будет работать правило stream.</p>
</blockquote>
</aside>
<p>Я только за, в конфиге Nginx указан реалити сайт и мой домен, а также параметр $backend, какой из них прописать?</p>
<aside class="quote no-group" data-username="Uporoty" data-post="13" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Какие именно?</p>
</blockquote>
</aside>
<p>В stream был прописан вместо моего домена реалити сайт.<br>
В разделе server_name был прописан не мой домен а реалити сайт.</p></td><td>2024-05-12T00:13:10.763Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="14" data-topic="7828" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>На скриншоте не видно, т.к. замазано, поэтому хочу упомянуть грабли, на которые довелось наступить мне. В той статье, на которую ты опираешься, Path указан что-то вроде /mypath, у меня так заработало, только если early data length ставить 0. Если early data хочется, то нужно уазывать, например, и early data length 2048 и в пути прописывать /mypath?ed=2048</p>
</blockquote>
</aside>
<p>Я тоже обратил внимание, но странно, у автора статьи работало с 2048, хоть и времени немного прошло. Я так понимаю, что наклонная черта в начале пароля обязательна, о чём умолчали в статье. Но тогда давайте “сверим часы”, этот пароль упоминается 3 раза и конечно же в строке перед патчем стоит другая наклонная черта, которая, непонятно, влияет или нет на него:<br>
Например, мой патч будет такой: <strong>/12345</strong>   и я его подставляю в строчки кода:</p>
<p><strong>/etc/nginx/conf.d/default.conf</strong><br>
location /<strong>/12345</strong> {</p>
<p><strong>/opt/xray/config.json</strong><br>
“path”: “<strong>/12345</strong>”</p>
<p><strong>Окно конфигурации Nekobox:</strong><br>
path: <strong>/12345</strong></p>
<p>Нормально всё? <img src="https://ntc.party/images/emoji/twitter/see_no_evil.png?v=12" title=":see_no_evil:" class="emoji" alt=":see_no_evil:" loading="lazy" width="20" height="20"></p></td><td>2024-05-12T00:44:00.559Z</td></tr><tr><td>Uporoty(Uporoty)</td><td><aside class="quote no-group" data-username="Kisliy" data-post="15" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>Такого варианта достаточно будет: scheme://username:password@host:port/path?query#fragment ?</p>
</blockquote>
</aside>
<p>Да нет же, просто <a href="https://domain/path" rel="noopener nofollow ugc">https://domain/path</a>. Больше ничего, вообще ничего. Просто как обычный URL в<br>
браузере.</p>
<aside class="quote no-group" data-username="Kisliy" data-post="15" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>в конфиге Nginx указан реалити сайт и мой домен, а также параметр $backend, какой из них прописать</p>
</blockquote>
</aside>
<p>Ваш домен. То, что совпадает с ним, Nginx будет отправлять на веб-сайт с вебсокетами, все остальное - на reality-обманку. Поэтому в SNI должен обязательно быть ваш домен.</p>
<aside class="quote no-group" data-username="Kisliy" data-post="16" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>location /<strong>/12345</strong> {</p>
</blockquote>
</aside>
<p>Слеш должен быть только один</p>
<aside class="quote no-group" data-username="Kisliy" data-post="12" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>websocket: bad handshake: HTTP 502 502 Bad Gateway.</p>
</blockquote>
</aside>
<p>Так, давайте проще. Добейтесь сначала, чтобы у вас подключение к прокси через вебсокеты хотя бы заработало без GCore, а уже потом добавляйте GCore. В Nekobox в адресе сервера задайте не ваш домен, а IP-адрес сервера, а домен пусть будет в Host. Пробуйте подключиться и смотрите логи Nginx. Когда заработает так - будем разбираться с GCore (если в Nginx сертификат самоподписанный, не забудьте галочку allow insecure)</p>
<p>Но судя по тому, что у вас сейчас по вашему домену открывается гитхаб вместо сайта Nginx, проблема где-то именно с SNI. Попробуйте в Nekobox явно заполнить поле SNI вашим доменом, кстати.</p>
<p>А так, в целом, инструкция по которой вы настраиваете, реально переусложненная, и в ней слишком много вещей где что-то можно сделать не так. Варианты с IPv6 (для GCore не подойдёт) или с альтернативным портом (а вот этот очень даже подойдёт) описанные в других статьях, гораздо проще и надёжнее.</p></td><td>2024-05-12T07:41:02.057Z</td></tr><tr><td>xor</td><td><p>Ну это не совсем пароль, это URL путь, хотя в данном случае выполняет в некотором роде роль пароля тоже, т.к. не зная его на ws попасть не получится.<br>
И того, если путь будет 12345, то в:<br>
<strong>/etc/nginx/conf.d/default.conf</strong><br>
location <strong>/12345</strong> {</p>
<p><strong>/opt/xray/config.json</strong><br>
“path”: “<strong>12345</strong>”</p>
<p><strong>Окно конфигурации Nekobox:</strong><br>
Path* <strong>/12345?ed=2048</strong><br>
EarlyData Length 2048<br>
EarlyData Name Sec-Websocket-Protocol</p></td><td>2024-05-12T08:28:09.403Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="Uporoty" data-post="17" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Да нет же, просто <a href="https://domain/path" rel="noopener nofollow ugc">https://domain/path</a>. Больше ничего, вообще ничего. Просто как обычный URL в</p>
</blockquote>
</aside>
<p>Хорошо, вот:</p>
<pre><code class="lang-auto">C:\Windows\System32&gt;curl -v https://XXXXX.com/XXXXX
*   Trying XX.XX.12.12:443...
* Connected to XXXXX.com (XX.XX.12.12) port 443
* schannel: disabled automatic use of client certificate
* ALPN: curl offers http/1.1
* schannel: next InitializeSecurityContext failed: SEC_E_ILLEGAL_MESSAGE (0x80090326) - This error usually occurs when a fatal SSL/TLS alert is received (e.g. handshake failed). More detail may be available in the Windows System event log.
* Closing connection
* schannel: shutting down SSL/TLS connection with github.ddnsfree.com port 443
curl: (35) schannel: next InitializeSecurityContext failed: SEC_E_ILLEGAL_MESSAGE (0x80090326) - This error usually occurs when a fatal SSL/TLS alert is received (e.g. handshake failed). More detail may be available in the Windows System event log.
</code></pre>
<aside class="quote no-group" data-username="Uporoty" data-post="17" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Добейтесь сначала, чтобы у вас подключение к прокси через вебсокеты хотя бы заработало без GCore, а уже потом добавляйте GCore. В Nekobox в адресе сервера задайте не ваш домен, а IP-адрес сервера, а домен пусть будет в Host.</p>
</blockquote>
</aside>
<p>Ок, давай попробуем напрямки, какие ещё настройки поменять в nekobox?<br>
<div class="lightbox-wrapper"><a class="lightbox" href="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/07619cf52f3e1b090314aaf484914669d4ac24ee.png" data-download-href="https://ntc.party/uploads/default/07619cf52f3e1b090314aaf484914669d4ac24ee" title="image"><img src="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/07619cf52f3e1b090314aaf484914669d4ac24ee_2_674x500.png" alt="image" data-base62-sha1="13itBeXTQjUmjDdBnnkeHlasnzU" width="674" height="500" srcset="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/07619cf52f3e1b090314aaf484914669d4ac24ee_2_674x500.png, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/07619cf52f3e1b090314aaf484914669d4ac24ee_2_1011x750.png 1.5x, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/07619cf52f3e1b090314aaf484914669d4ac24ee_2_1348x1000.png 2x" data-dominant-color="363434"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">1380×1023 46.4 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>При таких настройках: ошибка теста: Get “<a href="http://cp.cloudflare.com/" rel="noopener nofollow ugc">http://cp.cloudflare.com/</a>”: tls: first record does not look like a TLS handshake.</p>
<aside class="quote no-group" data-username="Uporoty" data-post="17" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>А так, в целом, инструкция по которой вы настраиваете, реально переусложненная, и в ней слишком много вещей где что-то можно сделать не так.</p>
</blockquote>
</aside>
<p>По сути, добавить в конфиги Nginx несколько строчек <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>
<aside class="quote no-group" data-username="xor" data-post="18" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/xor/48/5000_2.png" class="avatar"> xor:</div>
<blockquote>
<p>И того, если путь будет 12345, то в:</p>
</blockquote>
</aside>
<p>Отказался в пароле от слэша, сделал как у вас в примере, спасибо.</p></td><td>2024-05-12T18:43:46.365Z</td></tr><tr><td>xor</td><td><p>Интересно было бы все же удостовериться что проксируется что надо и куда надо.<br>
Предлагаю добавить логирование в секцию стрима</p>
<pre><code class="lang-auto">log_format custom_stream_log 'proxy: $status $protocol remote_addr $remote_addr, sent_to $upstream_addr';
  server {
      listen          443 reuseport so_keepalive=on;
      access_log      syslog:server=unix:/dev/log custom_stream_log;
      proxy_pass      $backend;
  }
</code></pre>
<p>И посмотреть, что запрос улетел на слушателя сайта<br>
Логи будут в системном журнале.</p></td><td>2024-05-12T19:17:22.394Z</td></tr><tr><td>Kisliy(Андрей)</td><td><p>Просто в секцию стрима не прописать, что-то хочет от меня:<br>
<em>nginx: [emerg] duplicate listen options for 0.0.0.0:443 in /etc/nginx/nginx.conf:57</em><br>
<em>nginx: configuration file /etc/nginx/nginx.conf test failed</em></p></td><td>2024-05-12T20:14:10.851Z</td></tr><tr><td>xor</td><td><p>Наверное мне стоило расписать подробнее.<br>
Добавляешь в секцию стрима</p>
<pre><code class="lang-auto">log_format custom_stream_log 'proxy: $status $protocol remote_addr $remote_addr, sent_to $upstream_addr';
</code></pre>
<p>А ниже есть подсекция server, где происходит проксирование на бэкенды, туда нужно добавить строку</p>
<pre><code class="lang-auto">access_log      syslog:server=unix:/dev/log custom_stream_log;
</code></pre>
<p>дабы логи писались.<br>
т.е. не добавляем еще один server, а добавляем логирование в имеющийся.</p></td><td>2024-05-12T20:23:10.713Z</td></tr><tr><td>Kisliy(Андрей)</td><td><p>Сделал, ругается на логи:<br>
<em>nginx: [emerg] unknown log format “custom_stream_log” in /etc/nginx/nginx.conf:53</em><br>
<em>nginx: configuration file /etc/nginx/nginx.conf test failed</em></p></td><td>2024-05-12T20:50:05.215Z</td></tr><tr><td>xor</td><td><p>А можно на nginx.conf взглянуть?</p></td><td>2024-05-12T21:15:29.411Z</td></tr><tr><td>Kisliy(Андрей)</td><td><p>Естественно:</p>
<pre><code class="lang-auto">user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}

stream {
  map $ssl_preread_server_name $backend {
      XXXXX.com               reality;
      XXXXX.XXXXX.com             local;
      default                  reality;
  }

  upstream reality {
      server 127.0.0.1:8443;
  }

  upstream local {
      server 127.0.0.1:8444;
  }

  server {
      listen          443 reuseport so_keepalive=on;
      ssl_preread     on;
      proxy_pass      $backend;
      access_log      syslog:server=unix:/dev/log custom_stream_log;
  }

log_format custom_stream_log 'proxy: $status $protocol remote_addr $remote_addr, sent_to $upstream_addr';

  }
}
</code></pre></td><td>2024-05-12T21:27:28.616Z</td></tr><tr><td>xor</td><td><p>Нужно сначала объявить лог.<br>
т.е. нужно строку</p>
<pre><code class="lang-auto">log_format custom_stream_log ...
</code></pre>
<p>поместить перед</p>
<pre><code class="lang-auto">  server {
      listen          443 reuseport so_keepalive=on;
</code></pre></td><td>2024-05-12T21:44:40.903Z</td></tr><tr><td>Kisliy(Андрей)</td><td><p>del</p></td><td>2024-05-12T22:41:38.777Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="26" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>Нужно сначала объявить лог.</p>
</blockquote>
</aside>
<p>Да, теперь стало писаться в access.log:</p>
<pre><code class="lang-auto">127.0.0.1 - - [13/May/2024:01:23:27 +0300] "\x16\x03\x01\x018\x01\x00\x014\x03\x03\x89\xEF\x9A\xD1\xC8\x8C6\x11\xFB\xE6(s!\x8D=\x90y\x07\x15q\xF1\x04\xE3\xED\xFB\xF1(\xC1{K\x80@ jY\x89\x03\xE3\xFE,\x13\x0C\x1Ek9\x86\xF1\xD9\x85~\xB7\xB0" 400 157 "-" "-" "-"
127.0.0.1 - - [13/May/2024:01:23:40 +0300] "\x16\x03\x01\x018\x01\x00\x014\x03\x03&amp;\xE1\x84\xDFHOhR\xE5H\xB1(\xE7e\xFF\xD0\x8D\xD7\xFE'J\x22\x19\x7FHd\xFA\xEB\xE9[~* \xE5fW%\x04h\x8D" 400 157 "-" "-" "-"
127.0.0.1 - - [13/May/2024:01:24:13 +0300] "\x16\x03\x01\x018\x01\x00\x014\x03\x03D\x8Du\x83\x10\x19\xCB\xCF\x16\xF1z\x1D\x10b\xB2q\x1D\x95\x93Ap\xF0 \x0E$&lt;\x131\x99\x87\xA7m \xAF-T +\xEBS\xEF\x872\xD6\xE8\x8C\xA3\x91\xBAn\xF08\xC6\x1AB\xBC\x0C@\xD4M\x94\xC3\xB3j\xED\x00&gt;\x13\x02\x13\x03\x13\x01\xC0,\xC00\x00\x9F\xCC\xA9\xCC\xA8\xCC\xAA\xC0+\xC0/\x00\x9E\xC0$\xC0(\x00k\xC0#\xC0'\x00g\xC0" 400 157 "-" "-" "-"
127.0.0.1 - - [13/May/2024:01:24:32 +0300] "\x16\x03\x01\x02\x00\x01\x00\x01\xFC\x03\x03M\xF4;(u\x1C\x96\xF2|C\x08M\xC4\xCA\x14\x8B\x03F\xDBT\x98\x10\xB9\x03y\x85U\xC0\xAE\x90&lt;o De\xCB\x06\x9DZ\xF3\x91\xC86Z\xFAt\xBA8*\x04\xEFI_\x83\xF1\x01\xBC\xDF1\xFB\xE9\x96j\x85(\x00 \xEA\xEA\x13\x01\x13\x02\x13\x03\xC0+\xC0/\xC0,\xC00\xCC\xA9\xCC\xA8\xC0\x13\xC0\x14\x00\x9C\x00\x9D\x00/\x005\x01\x00\x01\x93jj\x00\x00\xFF\x01\x00\x01\x00\x00\x10\x00\x0B\x00\x09\x08http/1.1\x00\x17\x00\x00\x00+\x00\x07\x06**\x03\x04\x03\x03\x00\x05\x00\x05\x01\x00\x00\x00\x00\x00" 400 157 "-" "-" "-"
</code></pre></td><td>2024-05-12T22:43:04.089Z</td></tr><tr><td>xor</td><td><p>Логов самой прокси не видно, они должны начинаться с “proxy:”.<br>
Можно, например, в терминале набрать journalctl -u nginx -f<br>
И просто в браузере открыть свой сайт <a href="http://XXXXX.XXXXX.com" rel="noopener nofollow ugc">XXXXX.XXXXX.com</a>, потыкать Ctrl+f5 (обновить с чисткой кэша), и смотреть, появятся ли записи типа:<br>
proxy: 200 5653 TCP remote_addr 123.123.123.123, sent_to 127.0.0.1:8444<br>
Таким образом убедившись, что запросы со своего внешнего адреса remote_addr улетают на слушателя nginx 127.0.0.1:8444, который, в свою очередь, может при знании нужного URL апгрейднуть соединение до ws и послать его в xray.</p></td><td>2024-05-12T23:27:44.320Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="29" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>Таким образом убедившись, что запросы со своего внешнего адреса remote_addr улетают на слушателя nginx 127.0.0.1:8444, который, в свою очередь, может при знании нужного URL апгрейднуть соединение до ws и послать его в xray.</p>
</blockquote>
</aside>
<p>Первая строчка подключение по реалити, вторая - через CDN, третья - напрямую.</p>
<pre><code class="lang-auto">May 13 02:43:15 nginx: proxy: 200 TCP remote_addr XX.XX.109.166, sent_to 127.0.0.1:8443
May 13 02:43:26 nginx: proxy: 200 TCP remote_addr XX.XXX.113.11, sent_to 127.0.0.1:8444
May 13 02:44:02 nginx: proxy: 200 TCP remote_addr XX.XX.109.166, sent_to 127.0.0.1:8444
</code></pre></td><td>2024-05-12T23:50:30.289Z</td></tr><tr><td>xor</td><td><p>Ну пока все выглядит хорошо. В конфиге nginx, приведенном выше, тоже проблем не вижу.<br>
Опять же, для верности, можно посмотреть, есть ли обмен с xray, хоть какой-то.</p>
<pre><code class="lang-auto">sudo tcpdump -i lo port 8889
</code></pre>
<p>И, если обмен есть, то смотреть логи xray, если обмена нет, то смотреть в nginx</p></td><td>2024-05-13T09:17:37.936Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="31" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>И, если обмен есть, то смотреть логи xray, если обмена нет, то смотреть в nginx</p>
</blockquote>
</aside>
<p>Обмена никакого нет, когда я присоединяюсь на прямую или через CDN. Может в этом файле что-то не так, других-то я и не изменял /etc/nginx/conf.d/<strong>default.conf</strong></p>
<pre><code class="lang-auto">server {
	listen 127.0.0.1:8444 so_keepalive=on;
        http2 on;


# ваш домен    
server_name XXX.XXX.com;

    #access_log  /var/log/nginx/host.access.log  main;

    # сюда можно положить какие-нибудь странички фейкового сайта, или использовать proxy_pass чтобы переадресовать запрос на другой сервер
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    #error_page   500 502 503 504  /50x.html;
    #location = /50x.html {
    #    root   /usr/share/nginx/html;
    #}

# путь к сертификатам, самоподписанным либо от Cloudflare
	ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
	ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;

client_header_timeout 52w;
    keepalive_timeout 52w;
# замените TestChatGRPC на какую-нибудь секретную строку
	location /XXXXX {
		if ($content_type !~ "application/grpc") {
			return 404;
		}
		client_max_body_size 0;
		client_body_buffer_size 512k;
		grpc_set_header X-Real-IP $remote_addr;
		client_body_timeout 52w;
		grpc_read_timeout 52w;
		grpc_pass grpc://127.0.0.1:8888;
	}






    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}

# аналогично замените TestChatWS на какую-нибудь другую секретную строку
    location /XXXXX {
		if ($http_upgrade != "websocket") {
			return 404;
		}
		proxy_pass http://127.0.0.1:8889;
		proxy_redirect off;
	    proxy_http_version 1.1;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection "upgrade";
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    proxy_read_timeout 52w;
	}
}
</code></pre></td><td>2024-05-13T10:28:57.085Z</td></tr><tr><td>xor</td><td><p>Ну каких-то особых проблем я не вижу.<br>
Но, во-первых, советую добавить ssl в заголовок, он вроде нужен, если идет работа с сертификатами.<br>
У меня, например, так:</p>
<pre><code class="lang-auto">server {
        listen 127.0.0.1:8444 ssl http2 so_keepalive=on;
</code></pre>
<p>Во-вторых, интересно было бы посмотреть, что там nginx выдает при попытке соединения.<br>
Предположим, что ws URL - 12345.</p>
<pre><code class="lang-auto">    location /12345 {
		if ($http_upgrade != "websocket") {
			return 404;
		}
               ...
</code></pre>
<p>Тогда ищем в журнале</p>
<pre><code class="lang-auto">journalctl -u nginx -r
</code></pre>
<p>Что-то вроде</p>
<pre><code class="lang-auto">nginx: 101 4076 "GET /12345 HTTP/1.1" "-" "Go-http-client/1.1"
</code></pre>
<p>Не обязательно именно такую строку, т.к. у меня формат логов изменен. Но обращать внимание на путь /12345 и статус. 101 - изменение протокола, т.к. http меняется на ws</p></td><td>2024-05-13T11:17:54.994Z</td></tr><tr><td>soulja(Serano)</td><td><aside class="quote no-group" data-username="Kisliy" data-post="32" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p><code>listen 127.0.0.1:8444</code></p>
</blockquote>
</aside>
<p>DEL</p></td><td>2024-05-13T11:23:03.535Z</td></tr><tr><td>soulja(Serano)</td><td><p>Немного чище конфиг</p>
<pre><code class="lang-auto">server {
	listen 127.0.0.1:8444 ssl so_keepalive=on;
    http2 on;

	server_name XXX.XXX.com;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    #error_page  404              /404.html;


# путь к сертификатам, самоподписанным либо от Cloudflare
	ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
	ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;

	location /XXXXX {
		if ($content_type !~ "application/grpc") {
			return 404;
		}
		client_max_body_size 0;
		client_body_buffer_size 512k;
		grpc_set_header X-Real-IP $remote_addr;
		client_body_timeout 52w;
		grpc_read_timeout 52w;
		grpc_pass grpc://127.0.0.1:8888;
	}

    location /XXXXX {
		if ($http_upgrade != "websocket") {
			return 404;
		}
		proxy_pass http://127.0.0.1:8889;
	    proxy_redirect off;
	    proxy_http_version 1.1;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection "upgrade";
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    proxy_read_timeout 52w;
	}
</code></pre></td><td>2024-05-13T11:29:57.625Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="33" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>Но, во-первых, советую добавить ssl в заголовок, он вроде нужен, если идет работа с сертификатами.</p>
</blockquote>
</aside>
<p>Кстати, у автора статьи он тоже отсутствует в конфиге. Я добавил ssl в заголовок, получаю следующее сообщение:<br>
<code>ошибка теста: Get "http://cp.cloudflare.com/": x509: certificate signed by unknown authority</code></p>
<p>Если разрешить небезопасное соединение TLS в nekobox:<br>
<code>ошибка теста: Get "http://cp.cloudflare.com/": context deadline exceeded</code></p></td><td>2024-05-13T17:18:31.187Z</td></tr><tr><td>xor</td><td><p>Получал ли ты сертификат для <a href="http://XXX.XXX.com" rel="noopener nofollow ugc">XXX.XXX.com</a>? Сертификат от того же let’s encrypt, насколько я помню, распространяется только на домены и поддомены, которые явно указаны при запросе.</p>
<p>Ну и логи nginx бы посмотреть. В зависимости от настроек они падают либо в системный журнал, либо в /var/log/nginx</p></td><td>2024-05-13T21:07:19.236Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="37" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>Получал ли ты сертификат для <a href="http://XXX.XXX.com" rel="noopener nofollow ugc">XXX.XXX.com</a>? Сертификат от того же let’s encrypt, насколько я помню, распространяется только на домены и поддомены, которые явно указаны при запросе.</p>
</blockquote>
</aside>
<p>Мне let’s encrypt выписал Gcore, но кнопки скачать его нет.</p>
<aside class="quote no-group" data-username="xor" data-post="37" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>Ну и логи nginx бы посмотреть. В зависимости от настроек они падают либо в системный журнал, либо в /var/log/nginx</p>
</blockquote>
</aside>
<p>Появилась такая запись при подключении с небезопасным TLS:<br>
/var/log/nginx/<strong>access.log</strong><br>
<code>127.0.0.1 - - [14/May/2024:00:43:45 +0300] "GET /XXXXX HTTP/1.1" 101 4 "-" "Go-http-client/1.1" "-"</code></p>
<p>Кстати, в журнале проскакивает какая то строчка, если что:<br>
<code> systemd[1]: nginx.service: Can't open PID file /run/nginx.pid (yet?) after start: Operation not permitted</code></p></td><td>2024-05-13T21:51:33.903Z</td></tr><tr><td>xor</td><td><blockquote>
<p>Мне let’s encrypt выписал Gcore, но кнопки скачать его нет.</p>
</blockquote>
<p>А это что за сертификаты тогда?</p>
<pre><code class="lang-auto">/etc/nginx/conf.d/default.conf

ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
</code></pre>
<p>Самоподписанные?</p>
<p>У меня нет опыта работы с сертификатами, выданными cdn провайдерами. Но как вариант, попробуй настраивать всё на тот домен, который указал при настройке GCore. Если вводил не <a href="http://XXX.XXX.com" rel="noopener nofollow ugc">XXX.XXX.com</a>, а <a href="http://XXX.com" rel="noopener nofollow ugc">XXX.com</a>, то его и нужно прописать и в настройках nginx - server_name <a href="http://XXX.com" rel="noopener nofollow ugc">XXX.com</a>;<br>
и в настройках Nekoray тоже</p>
<blockquote>
<p>127.0.0.1 - - [14/May/2024:00:43:45 +0300] “GET /XXXXX HTTP/1.1” 101 4 “-” “Go-http-client/1.1” “-”</p>
</blockquote>
<p>Это хороший знак, осталось разобраться с сертификатами</p></td><td>2024-05-13T22:23:22.277Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="39" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/xor/48/5000_2.png" class="avatar"> xor:</div>
<blockquote>
<p>Самоподписанные?</p>
</blockquote>
</aside>
<p>Да, на <a href="http://XXX.XXX.com" rel="noopener nofollow ugc">XXX.XXX.com</a>. Уже прописан у меня и в server_name и в nekobox.</p>
<aside class="quote no-group" data-username="xor" data-post="39" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/xor/48/5000_2.png" class="avatar"> xor:</div>
<blockquote>
<p>Это хороший знак, осталось разобраться с сертификатами</p>
</blockquote>
</aside>
<p>Из статьи:<br>
<em>Также нам понадобится TLS‑сертификат, если у вас его еще нет. Как я уже говорил, при работе через CDN хватит самоподписанного сертификата (все равно его не будет видно снаружи, он используется только для связи между фронтендом CDN и вашим сервером), либо «внутреннего» сертификата от Cloudflare.</em></p>
<p>Выходит, эти сертификаты для сервера и CDN, а про прямое подключение ничего не говорится. В nekobox есть такое окошко, может туда чего прописать? Просто скопировать ключ из самоподписного сертификата завершается множественными ошибками.<br>
<div class="lightbox-wrapper"><a class="lightbox" href="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7b516028b9afc70f34140cc7cbb5dcc3b05a9fec.png" data-download-href="https://ntc.party/uploads/default/7b516028b9afc70f34140cc7cbb5dcc3b05a9fec" title="image"><img src="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7b516028b9afc70f34140cc7cbb5dcc3b05a9fec_2_344x250.png" alt="image" data-base62-sha1="hAV4Fzg5sScKpOBHtnbxH5Qih5y" width="344" height="250" srcset="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7b516028b9afc70f34140cc7cbb5dcc3b05a9fec_2_344x250.png, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7b516028b9afc70f34140cc7cbb5dcc3b05a9fec_2_516x375.png 1.5x, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/7b516028b9afc70f34140cc7cbb5dcc3b05a9fec_2_688x500.png 2x" data-dominant-color="2B3034"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">850×616 18.2 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p></td><td>2024-05-13T23:00:05.450Z</td></tr><tr><td>xor</td><td><pre><code class="lang-auto">Выходит, эти сертификаты для сервера и CDN, а про прямое подключение ничего не говорится.
</code></pre>
<p>Смотря что используется для прямого. Если маскировка под какой-то другой сайт (security reality), то там вообще ни свой домен ни вебсервер не участвуют, за исключением случая маскировки под собственный домен (steal from yourself). Если просто vision (security tls), то нужны сертификаты let’s encrypt.</p>
<p>Глядя на это</p>
<pre><code class="lang-auto">127.0.0.1 - - [14/May/2024:00:43:45 +0300] “GET /XXXXX HTTP/1.1” 101 4 “-” “Go-http-client/1.1” “-”
</code></pre>
<p>то возможно и зря с сертификатами мучаемся, нужно смотреть логи xray</p>
<blockquote>
<p>В nekobox есть такое окошко, может туда чего прописать? Просто скопировать ключ из самоподписного сертификата завершается множественными ошибками.</p>
</blockquote>
<p>Не знаю, если честно, для какого случая там это окошко. Может и правда для самоподписанных сертификатов</p></td><td>2024-05-13T23:30:36.966Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="41" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>то возможно и зря с сертификатами мучаемся, нужно смотреть логи xray</p>
</blockquote>
</aside>
<p>Вот, достал:</p>
<pre><code class="lang-auto">May 14 03:04:34 xray[639]: 2024/05/14 03:04:34 127.0.0.1:0 rejected  proxy/vless/encoding: failed to read request version &gt; websocket: close 1000 (normal)
May 14 03:04:34 xray[639]: 2024/05/14 03:04:34 [Info] [3941384672] proxy/vless/inbound: firstLen = 0
May 14 03:04:34 xray[639]: 2024/05/14 03:04:34 [Info] [3941384672] app/proxyman/inbound: connection ends &gt; proxy/vless/inbound: invalid request from 127.0.0.1:0 &gt; proxy/vless/encoding: failed to read request version &gt; websocket: close 1000 (normal)
</code></pre></td><td>2024-05-14T00:58:21.116Z</td></tr><tr><td>xor</td><td><p>Судя по логам, у меня тоже когда-то такая ошибка была, но какие настройки конкретно ее вызывают, уже никак не узнать.</p>
<p>Могу посоветовать лишь проверить еще раз внимательно все настройки, как nginx, так и xray клиента и сервера.</p>
<p>Указывал ли CNAME, как было сказано в статье? Может быть где-то на сайте GCore можно увидеть, прошел ли через ее cdn трафик?</p></td><td>2024-05-14T02:04:29.036Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="xor" data-post="43" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>Указывал ли CNAME, как было сказано в статье? Может быть где-то на сайте GCore можно увидеть, прошел ли через ее cdn трафик?</p>
</blockquote>
</aside>
<p>Мы же сначала решили на прямую подключиться, без Gcore.</p>
<aside class="quote no-group" data-username="xor" data-post="43" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/x/b4bc9f/48.png" class="avatar"> xor:</div>
<blockquote>
<p>Судя по логам, у меня тоже когда-то такая ошибка была, но какие настройки конкретно ее вызывают, уже никак не узнать.</p>
</blockquote>
</aside>
<p>В двух словах, о чём ошибка то?</p></td><td>2024-05-14T11:44:24.929Z</td></tr><tr><td>xor</td><td><pre><code class="lang-auto">Мы же сначала решили на прямую подключиться, без Gcore.
</code></pre>
<p>А, ну да <img src="https://ntc.party/images/emoji/twitter/slightly_smiling_face.png?v=12" title=":slightly_smiling_face:" class="emoji" alt=":slightly_smiling_face:" loading="lazy" width="20" height="20"></p>
<pre><code class="lang-auto">В двух словах, о чём ошибка то?
</code></pre>
<p>Я тут могу сделать только грубое предположение, что при firstLen = 0, данных, как таковых, не долетает до xray, что странно.<br>
nginx мы проверили, скрин nekoray тоже был.<br>
На всякий случай неплохо было бы взглянуть на конфиг xray, хотя я сомневаюсь, что в нем дело.<br>
Эксперимента ради можешь попробовать соединиться с клиента голого xray, чтобы точно никакие косяки настроек neko не были проблемой. Вот пример конфига:</p>
<pre><code class="lang-auto">{
  "log": {
    "loglevel": "info"
  },
  "dns": {
    "servers": [
      "https://1.1.1.1/dns-query"
    ],
    "queryStrategy": "UseIPv4"
  },
  "routing":
  {
    "domainStrategy": "IPIfNonMatch",
    "domainMatcher": "hybrid",
    "rules": [
      {
        "type": "field",
        "protocol": ["bittorrent"],
        "outboundTag": "direct"
      },
      {
        "type": "field",
        "domain": ["geosite:category-ads-all"],
        "outboundTag": "block"
      },
      {
        "type": "field",
        "domain": [
          "geosite:category-gov-ru",
          "domain:ru",
          "domain:by",
          "domain:su",
          "domain:xn--p1ai", // рф
          "domain:xn--80aswg", // сайт
          "domain:xn--c1avg", // онлайн
          "domain:xn--80asehdb", // москва
          "domain:xn--90ais" // бел
        ],
        "outboundTag": "direct"
      },
      {
        "type": "field",
        "ip": [
          "geoip:ru",
          "geoip:private",
          "geoip:by"
        ],
        "outboundTag": "direct"
      }
    ]
  },
  "inbounds": [
    {
      "listen": "127.0.0.1",
      "port": 2080,
      "protocol": "socks",
      "settings": {
        "udp": true
      },
      "sniffing": {
        "enabled": true,
        "destOverride": [
          "http",
          "tls"
        ]
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "vless",
      "settings": {
        "vnext": [
          {
            "address": "адрес",
            "port": 443,
            "users": [
              {
                "id": "ид",
                "encryption": "none"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "ws",
        "security": "tls",
        "wsSettings": {
          "path": "/путь?ed=2048"
        },
        "tlsSettings": {
          "allowInsecure": false,
          "serverName": "домен",
          "fingerprint": "firefox"
        }
      },
      "tag": "proxy"
    },
    {
      "protocol": "freedom",
      "tag": "direct"
    },
    {
      "protocol": "blackhole",
      "tag": "block"
    }
  ]
}
</code></pre>
<p>соответственно, в конфие нужно сделать четыре замены - адрес, путь и домен и ид, они там подписаны по-русски.<br>
Пусть тебя не смущает роутинг, он чисто для проверки работоспособностине помешает.<br>
Запускать xray -c conf_name.json<br>
Также, как и neko, откроет socks прокси на порту 2080.</p></td><td>2024-05-15T06:51:47.197Z</td></tr><tr><td>Kisliy(Андрей)</td><td><p>Получилось настроить, так что всем спасибо за поддержку и общий вклад в развитие свободного интернета! <img src="https://ntc.party/images/emoji/twitter/sun_with_face.png?v=12" title=":sun_with_face:" class="emoji" alt=":sun_with_face:" loading="lazy" width="20" height="20"> <img src="https://ntc.party/images/emoji/twitter/earth_africa.png?v=12" title=":earth_africa:" class="emoji" alt=":earth_africa:" loading="lazy" width="20" height="20"></p>
<p>Во-первых, ошибка в той статье на хабре по которой настраивал, <strong>ssl</strong> в /etc/nginx/conf.d/default.conf указывать обязательно, автор почему-то убрал это из финальных конфигураций:</p>
<pre><code class="lang-auto">listen 127.0.0.1:8444 ssl so_keepalive=on;
        http2 on;
</code></pre>
<p>Ну и во-вторых, с версии Xray-core v1.8.10 обновилось переключение HTTPUpgrade:</p>
<pre><code class="lang-auto">Теперь добавьте после пути HTTPUpgrade ?ed=2560, чтобы включить 0-RTT.
В дальнейшем рекомендуется заполнять 2560 вместо 2048 для WebSocket ed.
</code></pre>
<p>Подсмотрел <a href="https://github.com/chika0801/Xray-examples/blob/main/VLESS-WebSocket_or_HTTPUpgrade-TLS/WebSocket_config_client.json" rel="noopener nofollow ugc">в примерах</a> конфигурации, значения earlydata length и earlydata name не заполняются, как ни странно. Прикреплю скриншот с которым у меня всё работает:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/3326565a575ca59094abaaf1e58a476d8bbeaae9.png" data-download-href="https://ntc.party/uploads/default/3326565a575ca59094abaaf1e58a476d8bbeaae9" title="image"><img src="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/3326565a575ca59094abaaf1e58a476d8bbeaae9_2_677x500.png" alt="image" data-base62-sha1="7iuuh4O2BYG2284roUiGT5vYrdD" width="677" height="500" srcset="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/3326565a575ca59094abaaf1e58a476d8bbeaae9_2_677x500.png, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/3326565a575ca59094abaaf1e58a476d8bbeaae9_2_1015x750.png 1.5x, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/3326565a575ca59094abaaf1e58a476d8bbeaae9_2_1354x1000.png 2x" data-dominant-color="363334"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">1424×1051 48.9 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p></td><td>2024-05-15T09:38:01.912Z</td></tr><tr><td>Uporoty(Uporoty)</td><td><aside class="quote no-group" data-username="Kisliy" data-post="46" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>Во-первых, ошибка в той статье на хабре по которой настраивал, <strong>ssl</strong> в /etc/nginx/conf.d/default.conf указывать обязательно, автор почему-то убрал это из финальных конфигураций</p>
</blockquote>
</aside>
<p>Это кажется действительно факап автора, там “ssl” обязательно должно быть, да.</p>
<aside class="quote no-group" data-username="Kisliy" data-post="46" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>Ну и во-вторых, с версии Xray-core v1.8.10 обновилось переключение HTTPUpgrade</p>
</blockquote>
</aside>
<p>HTTPUpgrade и WS это чуть-чуть разные вещи. WS это настоящие вебсокеты, а у HTTPUpgrade только заголовок “Upgrade” от вебсокетов, а дальше данные шлются как есть. WS совместим со всем, а HTTPUpgrade работает быстрее, но не везде (через GCore кстати работает), и пока что поддерживается не всеми клиентами (большинство мобильных его пока не умеет).</p>
<p>А что до earlydata - это просто оптимизации (более быстрый хендшейк), отсутствие этих параметров на успешность соединения никак не влияет. Можете прописать там 2560 тоже.</p></td><td>2024-05-18T15:21:16.875Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="Uporoty" data-post="47" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>А что до earlydata - это просто оптимизации (более быстрый хендшейк), отсутствие этих параметров на успешность соединения никак не влияет. Можете прописать там 2560 тоже.</p>
</blockquote>
</aside>
<p>Я уже попробовал <img src="https://ntc.party/images/emoji/twitter/snowman.png?v=12" title=":snowman:" class="emoji" alt=":snowman:" loading="lazy" width="20" height="20"> Если прописать что-то отличное от 0 в earlydata length - работать не будет <img src="https://ntc.party/images/emoji/twitter/exclamation.png?v=12" title=":exclamation:" class="emoji" alt=":exclamation:" loading="lazy" width="20" height="20"><br>
Причём, Sec‑Websocket‑Protocol в earlydata name уже никак не влияет соединение, может работать и без него.</p></td><td>2024-05-18T17:16:52.233Z</td></tr><tr><td>Uporoty(Uporoty)</td><td><p>Ну понятно что если length стоит 0, то второй параметр уже не важен, т.к. фича отключена.<br>
А вот то что с 2560 и “Sec-Websocket-Protocol” не работает это очень странно. У меня работает.</p>
<p>Кстати, если у вас в планах пользоваться именно вебсокетами, то в Nekobox лучше переключить ядро на Xray (он станет Nekoray). Там не надо заполнять отдельно эти два поля для early data, XRay-ядро автоматически их подхватит по параметру ?ed= в урле. А во-вторых, там можно включить мультиплексирование (у sing-box’а mux не совместим с xray), что в некоторых случаях сильно ускоряет хендшейки и затрудняет детектирование со стороны</p></td><td>2024-05-18T17:32:50.026Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="Uporoty" data-post="49" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>пользоваться именно вебсокетами, то в Nekobox лучше переключить ядро на Xray (он станет Nekoray). Там не надо заполнять отдельно эти два поля для early data, XRay-ядро автоматически их подхватит по параметру ?ed= в урле. А во-вторых, там можно включить мультиплексирование (у sing-box’а mux не совместим с xray), что в некоторых случаях сильно ускоряет хендшейки и затрудняет детектирование со стороны</p>
</blockquote>
</aside>
<p>Т. е. не во всех случаях лучше использовать xray ядро? Автор тех статей показывает примеры на ядре sing-box, может из-за того что маршруты не работают иначе?</p></td><td>2024-05-18T20:43:56.687Z</td></tr><tr><td>Uporoty(Uporoty)</td><td><p>У Sing-box немного выше производительность для ShadowSocks, а ещё он поддерживает Hysteria, других особых преимуществ не вижу.</p>
<p>Насколько я помню, в то время, когда выходили эти статьи, Nekoray ещё не имел в себе XRay, а вместо него был древний V2Ray в котором не было многого нужного, отсюда и совет.</p></td><td>2024-05-18T20:51:02.811Z</td></tr><tr><td>Kisliy(Андрей)</td><td><p>Отлично, тогда конечно надо пересесть на xray ядро, да к тому же отсутствие мультиплекса раздражает долгими подключениями, спасибо за дельный совет! <img src="https://ntc.party/images/emoji/twitter/grinning.png?v=12" title=":grinning:" class="emoji" alt=":grinning:" loading="lazy" width="20" height="20"> <img src="https://ntc.party/images/emoji/twitter/+1.png?v=12" title=":+1:" class="emoji" alt=":+1:" loading="lazy" width="20" height="20"></p></td><td>2024-05-18T21:02:20.979Z</td></tr><tr><td>xor</td><td><blockquote>
<p>Я уже попробовал <img src="https://ntc.party/images/emoji/twitter/snowman.png?v=12" title=":snowman:" class="emoji" alt=":snowman:" loading="lazy" width="20" height="20"> Если прописать что-то отличное от 0 в earlydata length - работать не будет <img src="https://ntc.party/images/emoji/twitter/exclamation.png?v=12" title=":exclamation:" class="emoji" alt=":exclamation:" loading="lazy" width="20" height="20"><br>
Причём, Sec‑Websocket‑Protocol в earlydata name уже никак не влияет соединение, может работать и без него.</p>
</blockquote>
<p>Работает. Там просто неочевидный финт, что надо и ?ed=… и earlydata length и Sec‑Websocket‑Protocol.</p>
<blockquote>
<p>Т. е. не во всех случаях лучше использовать xray ядро? Автор тех статей показывает примеры на ядре sing-box, может из-за того что маршруты не работают иначе?</p>
</blockquote>
<p>Вот меня тоже смутило, чем так sing-box хорош, что автор советовал его. Кроме упоминания где-то в комментариях возможности прокидывания ssh, других преимуществ не удалось нагуглить.</p></td><td>2024-05-18T21:57:10.945Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="Uporoty" data-post="49" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>А во-вторых, там можно включить мультиплексирование (у sing-box’а mux не совместим с xray)</p>
</blockquote>
</aside>
<p>Достаточно только в клиенте включить mux, а сервер сам подхватит эту настройку?</p>
<p>Маршруты настроил, но вот правила с доменами, в которых есть ключевые слова, не фурычат и символ * не помогает, это конечно не важно, но случаем не знаете как правильно их вбивать?<br>
<div class="lightbox-wrapper"><a class="lightbox" href="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/1a434db106e84eb62696231b44d32bdc2d3c3fba.png" data-download-href="https://ntc.party/uploads/default/1a434db106e84eb62696231b44d32bdc2d3c3fba" title="image"><img src="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/1a434db106e84eb62696231b44d32bdc2d3c3fba_2_233x500.png" alt="image" data-base62-sha1="3KkBTKCDsmsmerq0Ef0CwAN4UTo" width="233" height="500" srcset="помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/1a434db106e84eb62696231b44d32bdc2d3c3fba_2_233x500.png, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/1a434db106e84eb62696231b44d32bdc2d3c3fba_2_349x750.png 1.5x, помощь-с-настройкой-проксирования-через-cdn-websocket-grpc/1a434db106e84eb62696231b44d32bdc2d3c3fba_2_466x1000.png 2x" data-dominant-color="333438"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">467×1002 21.9 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<aside class="quote no-group" data-username="xor" data-post="53" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/xor/48/5000_2.png" class="avatar"> xor:</div>
<blockquote>
<p>Вот меня тоже смутило, чем так sing-box хорош, что автор советовал его. Кроме упоминания где-то в комментариях возможности прокидывания ssh, других преимуществ не удалось нагуглить.</p>
</blockquote>
</aside>
<p>Будем надеется в следующих версиях SSH добавят.</p>
<p>В итоге я перешёл на ядро xray. Заметил небольшие недоработки: изредка комп чуть подтормаживал; окно taskkill вылетало при перезагрузке клиента; при включённом режиме tun и незапущенном сервере выход в инет блокируется, но текущие соединения не прерываются. В общем, пользоваться можно.</p></td><td>2024-05-20T03:00:00.116Z</td></tr><tr><td>Uporoty(Uporoty)</td><td><aside class="quote no-group" data-username="Kisliy" data-post="54" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/kisliy/48/1574_2.png" class="avatar"> Kisliy:</div>
<blockquote>
<p>но случаем не знаете как правильно их вбивать</p>
</blockquote>
</aside>
<p>Вот тут расписано: <a href="https://xtls.github.io/en/config/routing.html#ruleobject" rel="noopener nofollow ugc">Routing | Project X (xtls.github.io)</a>. То, что вы вписываете в окошко, клиент подсовывает в поле “domain” в конфиге</p></td><td>2024-05-20T09:00:54.634Z</td></tr><tr><td>Kisliy(Андрей)</td><td><aside class="quote no-group" data-username="Uporoty" data-post="55" data-topic="7828">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/u/ed655f/48.png" class="avatar"> Uporoty:</div>
<blockquote>
<p>Вот тут расписано: <a href="https://xtls.github.io/en/config/routing.html#ruleobject" rel="noopener nofollow ugc">Routing | Project X (xtls.github.io) </a>. То, что вы вписываете в окошко, клиент подсовывает в поле “domain” в конфиге</p>
</blockquote>
</aside>
<p>Спасибо! <img src="https://ntc.party/images/emoji/twitter/+1.png?v=12" title=":+1:" class="emoji" alt=":+1:" loading="lazy" width="20" height="20"></p></td><td>2024-05-21T05:48:18.400Z</td></tr><tr><td>SnakeWeb</td><td><p>Привет</p>
<p>Можешь написать мне?, тут предложение есть для тебя. Тг: <a href="https://t.me/snakeweb" class="inline-onebox" rel="noopener nofollow ugc">Telegram: Contact @snakeweb</a></p></td><td>2024-09-08T21:04:44.920Z</td></tr>
    </table>
      </body>
    </html>