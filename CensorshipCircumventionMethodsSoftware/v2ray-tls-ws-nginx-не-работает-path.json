[
    {
        "id": 4547,
        "name": null,
        "username": "quester",
        "avatar_template": "/user_avatar/ntc.party/quester/{size}/720_2.png",
        "created_at": "2021-12-03T10:31:50.373Z",
        "cooked": "<p>Приветствую. Пытаюсь обуздать плагин v2ray (<a href=\"https://github.com/shadowsocks/v2ray-plugin\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">GitHub - shadowsocks/v2ray-plugin: A SIP003 plugin based on v2ray</a>), возникла проблема при совмещение его с nginx, чтобы спрятать его за сайтом</p>\n<p>Работает в режиме v2ray-tls-ws<br>\nНа сервере запускаю:</p>\n<blockquote>\n<p>v2ray-plugin -server -tls -host МОЙ_ДОМЕН -cert /etc/letsencrypt/live/МОЙ_ДОМЕН/fullchain.pem -key /etc/letsencrypt/live/МОЙ_ДОМЕН/privkey.pem -localAddr АДРЕС_ВПС -localPort 443 -remotePort 22</p>\n</blockquote>\n<p>На клиенте запускаю:</p>\n<blockquote>\n<p>v2ray-plugin -tls -host МОЙ_ДОМЕН -localAddr 127.0.0.1 -localPort 8022 -remoteAddr АДРЕС_ВПС -remotePort 443</p>\n</blockquote>\n<p>Стучусь по ssh с клиента на сервер:</p>\n<blockquote>\n<p>ssh <a href=\"mailto:root@127.0.0.1\">root@127.0.0.1</a> -p 8022</p>\n</blockquote>\n<p>Все нормально, получился TLSv1.3 туннель, судя по wireshark</p>\n<p>Теперь хочу скрыть все это за сайтом.<br>\nС таким конфигом:</p>\n<blockquote>\n<p>server {<br>\nserver_name МОЙ_ДОМЕН;<br>\nroot /var/www/МОЙ_ДОМЕН;<br>\nindex index.html;<br>\nlisten [::]:443 ssl ipv6only=on; # managed by Certbot<br>\nlisten 443 ssl; # managed by Certbot<br>\nssl_certificate /etc/letsencrypt/live/МОЙ_ДОМЕН/fullchain.pem; # managed by Certbot<br>\nssl_certificate_key /etc/letsencrypt/live/МОЙ_ДОМЕН/privkey.pem; # managed by Certbot<br>\ninclude /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot<br>\nssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot<br>\nlocation /v2ray {<br>\nproxy_pass <a href=\"http://127.0.0.1:9999\" rel=\"noopener nofollow ugc\">http://127.0.0.1:9999</a>;<br>\nproxy_http_version  1.1;<br>\nproxy_set_header    Upgrade $http_upgrade;<br>\nproxy_set_header    Connection “upgrade”;<br>\nproxy_set_header    Host $http_host;<br>\nproxy_set_header    X-Real-IP $remote_addr;</p>\n<pre><code>    proxy_connect_timeout       10m;\n    proxy_send_timeout          10m;\n    proxy_read_timeout          90m;\n    send_timeout                10m;\n    }\n</code></pre>\n<p>}<br>\nserver {<br>\nif ($host = doomiddqd.xyz) {<br>\nreturn 301 https://$host$request_uri;<br>\n} # managed by Certbot</p>\n<pre><code>listen 80;\nlisten [::]:80;\nserver_name doomiddqd.xyz;\nreturn 404; # managed by Certbot\n</code></pre>\n<p>}</p>\n</blockquote>\n<p>Проверяю сайт, в браузере. Все ок https работает.</p>\n<p>Запускаю серверную часть на впс</p>\n<blockquote>\n<p>v2ray-plugin -server -tls -host МОЙ_ДОМЕН -path /v2ray -cert /etc/letsencrypt/live/МОЙ_ДОМЕН/fullchain.pem -key /etc/letsencrypt/live/МОЙ_ДОМЕН/privkey.pem -localAddr 127.0.0.1 -localPort 9999 -remotePort 22</p>\n</blockquote>\n<p>На клиенте:</p>\n<blockquote>\n<p>v2ray-plugin -tls -host МОЙ_ДОМЕН -path /v2ray -localAddr 127.0.0.1 -localPort 8022 -remoteAddr 5.2.74.240 -remotePort 443</p>\n</blockquote>\n<p>Опять пытаюсь подключится по ssh:</p>\n<blockquote>\n<p>ssh <a href=\"mailto:root@127.0.0.1\">root@127.0.0.1</a> -p 8022</p>\n</blockquote>\n<p>Безрезультатно.</p>\n<p>Послушал tcpdump lo на vps,  трафик идет на 9999 порт при попытке подключения по ssh, но похоже, что v2ray-plugin не отвечает.</p>\n<p>Пробовал v2ray-plugin всмести с ss, тоже результата не добился<br>\nконфиг ss</p>\n<p>Клиент:</p>\n<blockquote>\n<p>{<br>\n“server”:“АДРЕС_ВПС”,<br>\n“server_port”:443,<br>\n“local_port”:1080,<br>\n“password”:“ПАРОЛЬ”,<br>\n“timeout”:600,<br>\n“method”:“aes-128-gcm”,<br>\n“fast_open”: true,<br>\n“dns”:“1.1.1.1”,<br>\n“nameserver”: “1.1.1.1”,<br>\n“reuse_port”: true,<br>\n“mode”: “tcp_only”,<br>\n“plugin”:“/etc/shadowsocks-libev/v2ray-plugin”,<br>\n“plugin_opts”: “tls;host=МОЙ_ДОМЕН;path=/v2ray”<br>\n}</p>\n</blockquote>\n<p>Сервер:</p>\n<blockquote>\n<p>{<br>\n“server”:“127.0.0.1”,<br>\n“server_port”:9999,<br>\n“local_port”:1080,<br>\n“password”:“ПАРОЛЬ”,<br>\n“timeout”:600,<br>\n“method”:“aes-128-gcm”,<br>\n“fast_open”: true,<br>\n“dns”:“1.1.1.1”,<br>\n“nameserver”: “1.1.1.1”,<br>\n“reuse_port”: true,<br>\n“mode”: “tcp_only”,<br>\n“plugin”:“/etc/shadowsocks-libev/v2ray-plugin”,<br>\n“plugin_opts”: “server;tls;host=МОЙ_ДОМЕН;path=/v2ray”<br>\n}</p>\n</blockquote>\n<p><strong>UPD</strong><br>\nУдалось запустить с nginx только так убрав ключ <strong>-tls</strong> у сервера:</p>\n<p>Сервер:</p>\n<blockquote>\n<p>v2ray-plugin -server -host МОЙ_ДОМЕН -path /v2ray  -cert /etc/letsencrypt/live/МОЙ_ДОМЕН/fullchain.pem -key /etc/letsencrypt/live/МОЙ_ДОМЕН/privkey.pem -localAddr 127.0.0.1 -localPort 9999 -remotePort 22 -remoteAddr 127.0.0.1</p>\n</blockquote>\n<p>Клиент:</p>\n<blockquote>\n<p>v2ray-plugin -tls -host МОЙ_ДОМЕН -path /v2ray -localAddr 127.0.0.1 -localPort 8022 -remoteAddr IP_СЕРВЕРА -remotePort 443</p>\n</blockquote>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2021-12-03T15:52:56.845Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 774,
        "reads": 48,
        "readers_count": 47,
        "score": 3884.6,
        "yours": false,
        "topic_id": 1478,
        "topic_slug": "v2ray-tls-ws-nginx-%D0%BD%D0%B5-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82-path",
        "display_username": null,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 7,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
            {
                "url": "https://github.com/shadowsocks/v2ray-plugin",
                "internal": false,
                "reflection": false,
                "title": "GitHub - shadowsocks/v2ray-plugin: A SIP003 plugin based on v2ray",
                "clicks": 22
            },
            {
                "url": "http://127.0.0.1:9999",
                "internal": false,
                "reflection": false,
                "clicks": 0
            }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 631,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/v2ray-tls-ws-nginx-%D0%BD%D0%B5-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82-path/1478/1",
        "can_translate": false
    },
    {
        "id": 4561,
        "name": null,
        "username": "ValdikSS",
        "avatar_template": "/user_avatar/ntc.party/valdikss/{size}/2_2.png",
        "created_at": "2021-12-03T16:40:07.840Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"quester\" data-post=\"1\" data-topic=\"1478\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://ntc.party/user_avatar/ntc.party/quester/48/720_2.png\" class=\"avatar\"> quester:</div>\n<blockquote>\n<p>Удалось запустить с nginx только так убрав ключ <strong>-tls</strong> у сервера:</p>\n</blockquote>\n</aside>\n<p>В вашем конфигурационном файле nginx указан протокол HTTP у директивы proxy_pass, поэтому и используется нешифрованное соединение.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2021-12-03T16:40:07.840Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 1,
        "incoming_link_count": 19,
        "reads": 38,
        "readers_count": 37,
        "score": 102.6,
        "yours": false,
        "topic_id": 1478,
        "topic_slug": "v2ray-tls-ws-nginx-%D0%BD%D0%B5-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82-path",
        "display_username": null,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "AntiZapret staff",
        "title_is_group": false,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": true,
        "admin": true,
        "staff": true,
        "user_id": 1,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/v2ray-tls-ws-nginx-%D0%BD%D0%B5-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82-path/1478/2",
        "can_translate": false
    }
]