[
    {
        "id": 36160,
        "name": "Kenya-West",
        "username": "kenyawest",
        "avatar_template": "/user_avatar/ntc.party/kenyawest/{size}/6343_2.png",
        "created_at": "2024-08-27T15:38:01.996Z",
        "cooked": "<p>Всем привет, почему не работает fallback на caddy на X-UI (XRay, VLESS+XTLS-Vision, свой домен)?<br>\nКогда захожу на свой (суб)домен по SSL без указания портов, сиречь на 443 порт, у меня ничего не загружается, хотя настроенный X-UI должен показывать ответ от caddy.</p>\n<p>Оба в одной сети находятся:</p>\n<p><strong>caddy</strong>:</p>\n<pre data-code-wrap=\"yaml\"><code class=\"lang-yaml\">version: \"3.8\"\nservices:\n  caddy:\n    image: lucaslorentz/caddy-docker-proxy:ci-alpine\n    container_name: caddy\n    ports:\n      # портов нет! Он внутри сети работает и expose'ит что хочет только внутри, но конкретно тут 8081 и 8082\n    # ...\n    env_file:\n      - .env\n    networks:\n      - caddy-fallback\n    # ...\n\nnetworks:\n  caddy-fallback:\n    external: true\n</code></pre>\n<p><strong>X-UI</strong>:</p>\n<pre data-code-wrap=\"yaml\"><code class=\"lang-yaml\">---\nversion: \"3.8\"\n\nservices:\n  xui:\n    image: alireza7/x-ui\n    container_name: xui\n    ports:\n      - 80:80\n      - 443:443\n      - \"${XUI_DASHBOARD_PORT}:${XUI_DASHBOARD_PORT}\"\n      - \"${XUI_WG_PORT}:${XUI_WG_PORT}/udp\"\n      - \"${XUI_VLESS_PORT}:${XUI_VLESS_PORT}\"\n      - \"${XUI_SS2022_PORT}:${XUI_SS2022_PORT}\"\n      - \"${XUI_SUB_PORT}:${XUI_SUB_PORT}\"\n    env_file:\n      - .env\n    networks:\n      - caddy-fallback\n    # ...\n\nnetworks:\n  caddy-fallback:\n    external: true\n</code></pre>\n<p><strong>Конфиг <code>Caddyfile</code></strong>:</p>\n<pre data-code-wrap=\"nginx\"><code class=\"lang-nginx\"># ...\n\n:{$FALLBACK_PORT_1} {\n    import logging {$FALLBACK_PORT_1};\n    respond \"Handled by Caddy 1\" 200\n}\n\n:{$FALLBACK_PORT_2} {\n    import logging {$FALLBACK_PORT_2};\n    respond \"Handled by Caddy 2\" 200\n}\n</code></pre>\n<p><strong>Результирующий конфиг XRay</strong>:</p>\n<pre data-code-wrap=\"json\"><code class=\"lang-json\">{\n      \"listen\": null,\n      \"port\": XXXXX,\n      \"protocol\": \"vless\",\n      \"settings\": {\n        \"clients\": [\n          {\n            \"email\": \"demouser@example.tld_vless\",\n            \"flow\": \"\",\n            \"id\": \"XXXX\"\n          }\n        ],\n        \"decryption\": \"none\",\n        \"fallbacks\": [\n          {\n            \"alpn\": \"\",\n            \"dest\": \"caddy:8081\",\n            \"name\": \"\",\n            \"path\": \"\",\n            \"xver\": 1\n          },\n          {\n            \"alpn\": \"h2\",\n            \"dest\": \"caddy:8082\",\n            \"name\": \"\",\n            \"path\": \"\",\n            \"xver\": 2\n          }\n        ]\n      },\n      \"sniffing\": {\n        \"destOverride\": [\n          \"http\",\n          \"tls\",\n          \"quic\",\n          \"fakedns\"\n        ],\n        \"enabled\": true,\n        \"metadataOnly\": false,\n        \"routeOnly\": false\n      },\n      \"streamSettings\": {\n        \"network\": \"tcp\",\n        \"security\": \"tls\",\n        \"tcpSettings\": {\n          \"acceptProxyProtocol\": false,\n          \"header\": {\n            \"type\": \"none\"\n          }\n        },\n        \"tlsSettings\": {\n          \"alpn\": [\n            \"h2\",\n            \"http/1.1\"\n          ],\n          \"certificates\": [\n            {\n              \"certificateFile\": \"/etc/letsencrypt/live/&lt;DOMAIN&gt;/fullchain.pem\",\n              \"keyFile\": \"/etc/letsencrypt/live/&lt;DOMAIN&gt;/privkey.pem\",\n              \"ocspStapling\": 3600\n            }\n          ],\n          \"cipherSuites\": \"\",\n          \"maxVersion\": \"1.3\",\n          \"minVersion\": \"1.2\",\n          \"rejectUnknownSni\": true,\n          \"serverName\": \"\"\n        }\n      },\n      \"tag\": \"inbound-XXXXX\"\n    }\n</code></pre>\n<p>И он вполне себе отвечает, если пингую из-под контейнера X-UI:</p>\n<pre data-code-wrap=\"sh\"><code class=\"lang-sh\">/app # wget -qO- caddy:8081\nHandled by Caddy 1/app #\n/app # wget -qO- caddy:8082\nHandled by Caddy 2/app #\n</code></pre>\n<p>Так в чём дело? <code>alpn</code> пытался настраивать (<code>h1</code>, <code>http/1.1</code>, <code>h2</code>), <code>dest</code> тоже менял с <code>8081</code> на <code>caddy:8081</code> и т. д.</p>\n<p>Вот скриншот настроек VLESS:<br>\n<img src=\"x-uixray-vless-не-перенаправляет-трафик-на-сзади-стоящий-caddy-по-механизму-fallback/2f5617b022a35a21d761c1395dca2c0181640221.png\" alt=\"X-UI\" data-base62-sha1=\"6KKToEbafuBxEDUWNEcyR46rxq9\" width=\"518\" height=\"460\"></p>\n<p>Интересно, почему? За что мне всё это? Чем я это заслужил? Как теперь жить? Когда Дурова и Поднебесного отпустят?</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 1,
        "updated_at": "2024-08-27T19:02:50.552Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 177,
        "reads": 38,
        "readers_count": 37,
        "score": 887.6,
        "yours": false,
        "topic_id": 9811,
        "topic_slug": "x-uixray-vless-%D0%BD%D0%B5-%D0%BF%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D1%82-%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA-%D0%BD%D0%B0-%D1%81%D0%B7%D0%B0%D0%B4%D0%B8-%D1%81%D1%82%D0%BE%D1%8F%D1%89%D0%B8%D0%B9-caddy-%D0%BF%D0%BE-%D0%BC%D0%B5%D1%85%D0%B0%D0%BD%D0%B8%D0%B7%D0%BC%D1%83-fallback",
        "display_username": "Kenya-West",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 5,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 4475,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": false,
        "wiki": false,
        "post_url": "/t/x-uixray-vless-%D0%BD%D0%B5-%D0%BF%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D1%82-%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA-%D0%BD%D0%B0-%D1%81%D0%B7%D0%B0%D0%B4%D0%B8-%D1%81%D1%82%D0%BE%D1%8F%D1%89%D0%B8%D0%B9-caddy-%D0%BF%D0%BE-%D0%BC%D0%B5%D1%85%D0%B0%D0%BD%D0%B8%D0%B7%D0%BC%D1%83-fallback/9811/1",
        "can_translate": false
    }
]