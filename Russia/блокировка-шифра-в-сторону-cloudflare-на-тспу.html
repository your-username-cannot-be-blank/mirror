
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>блокировка-шифра-в-сторону-cloudflare-на-тспу</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>neikist</td><td><p>Простите, возможно не по теме немного, но подозреваю козни РКН. Есть мобильное приложение, до сегодняшней ночи работало все нормально, с ночи на разных провайдерах начались отвалы по таймауту. Причем рост ошибки с полуночи на разных версиях приложения, в т.ч. и совсем старых. На части провайдеров проблемы возникли не сразу, только к обеду. Через vpn приложение работает отлично.<br>
От того к какому ip подключиться пытается приложение не зависит ничего. Что странно - проблема и для прода и для стейдж сервера воспроизводится. Сервера за cloudflare стоят.<br>
Сама ошибка java.net.SocketTimeoutException: SSL handshake timed out<br>
at com.google.android.gms.org.conscrypt.NativeCrypto.SSL_do_handshake(Native Method)<br>
Caused by: android.system.ErrnoException: isConnected failed: EHOSTUNREACH (No route to host)<br>
at libcore.io.IoBridge.isConnected(IoBridge.java:275)</p>
<p>Сниффер показывает следующее<br>
<div class="lightbox-wrapper"><a class="lightbox" href="блокировка-шифра-в-сторону-cloudflare-на-тспу/48f06ddfda290731c961d5d791b5c2edead41ce3.png" data-download-href="https://ntc.party/uploads/default/48f06ddfda290731c961d5d791b5c2edead41ce3" title="image"><img src="блокировка-шифра-в-сторону-cloudflare-на-тспу/48f06ddfda290731c961d5d791b5c2edead41ce3_2_690x48.png" alt="image" data-base62-sha1="apfuGYxQrvaoryt4lPQGQVwPqpB" width="690" height="48" srcset="блокировка-шифра-в-сторону-cloudflare-на-тспу/48f06ddfda290731c961d5d791b5c2edead41ce3_2_690x48.png, блокировка-шифра-в-сторону-cloudflare-на-тспу/48f06ddfda290731c961d5d791b5c2edead41ce3_2_1035x72.png 1.5x, блокировка-шифра-в-сторону-cloudflare-на-тспу/48f06ddfda290731c961d5d791b5c2edead41ce3_2_1380x96.png 2x" data-dominant-color="AEB5D2"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">3578×254 90.8 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div><br>
<div class="lightbox-wrapper"><a class="lightbox" href="блокировка-шифра-в-сторону-cloudflare-на-тспу/6a6385d0d289e3c8c846d98db488f37d5f237a4b.png" data-download-href="https://ntc.party/uploads/default/6a6385d0d289e3c8c846d98db488f37d5f237a4b" title="image"><img src="блокировка-шифра-в-сторону-cloudflare-на-тспу/6a6385d0d289e3c8c846d98db488f37d5f237a4b_2_690x148.png" alt="image" data-base62-sha1="fb9PYrXR4wBnZ2o9QtLab5cGJJx" width="690" height="148" srcset="блокировка-шифра-в-сторону-cloudflare-на-тспу/6a6385d0d289e3c8c846d98db488f37d5f237a4b_2_690x148.png, блокировка-шифра-в-сторону-cloudflare-на-тспу/6a6385d0d289e3c8c846d98db488f37d5f237a4b_2_1035x222.png 1.5x, блокировка-шифра-в-сторону-cloudflare-на-тспу/6a6385d0d289e3c8c846d98db488f37d5f237a4b_2_1380x296.png 2x" data-dominant-color="7D818E"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">3014×650 249 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div><br>
Еще дополню - что в браузере при этом страничка расположенная по адресу сервера прекрасно открывается. И можно get запросы из браузера подергать - отдаются.</p></td><td>2024-03-31T14:24:07.913Z</td></tr><tr><td>anon57137390</td><td><p>Стоит создать отдельную тему.</p>
<p>Через Globalcheck блокировки не видно.<br>
Есть ответ сервера. Значит SNI не вызвал реакции. Если это был TLSv1.2 возможно блокировка по сертификату. При наличии SNI, возможно это что-то новенькое.</p></td><td>2024-03-31T15:00:33.770Z</td></tr><tr><td>neikist</td><td><p>Да вот сертификат для проверки всякого странного тоже меняли. Что интересно - отвал у части провайдеров был постепенный. Мы там два сервера используем, один для статики, другой для апи. И сначала отвалилась статика, потом апи (хост адреса у них разные), при том что http клиент одинаково сконфигурированный использовался. При этом, повторюсь, через vpn все работает отлично, и сам api.author.today отлично открывается в браузере, что прям странно. Да и в списках <a href="http://reestr.rublacklist.net" rel="noopener nofollow ugc">reestr.rublacklist.net</a> нас нет вроде.</p></td><td>2024-03-31T15:19:18.385Z</td></tr><tr><td>ValdikSS</td><td><p>Выложьте pcap</p></td><td>2024-03-31T15:41:16.511Z</td></tr><tr><td>neikist</td><td><p><a class="attachment" href="блокировка-шифра-в-сторону-cloudflare-на-тспу/zIBPxgN6sJnospgdi31Q67nnUXw.pcap">dump.pcap</a> (7 КБ)<br>
Конкретно на этом девайсе api.author.today работать начал, а вот на других девайсах по прежнему не работает. При том что это одна сеть. Но вот cm.author.today по прежнему те же признаки показывает. Выложил pcap.<br>
Хотя вру немного. Если раньше хоть какие то ответы от сервера прилетали, сейчас к сожалению перестали, соответственно выше файл уже без ответов(( Фильтр в capture options по host, он по идее и на source и на destination смотрит.<br>
<div class="lightbox-wrapper"><a class="lightbox" href="блокировка-шифра-в-сторону-cloudflare-на-тспу/06dca39b13a0dbcd67e6959c04bc70526cf1422a.png" data-download-href="https://ntc.party/uploads/default/06dca39b13a0dbcd67e6959c04bc70526cf1422a" title="image"><img src="блокировка-шифра-в-сторону-cloudflare-на-тспу/06dca39b13a0dbcd67e6959c04bc70526cf1422a_2_690x48.png" alt="image" data-base62-sha1="YHA4KPjD9kb0KiARYALp0eN7wS" width="690" height="48" srcset="блокировка-шифра-в-сторону-cloudflare-на-тспу/06dca39b13a0dbcd67e6959c04bc70526cf1422a_2_690x48.png, блокировка-шифра-в-сторону-cloudflare-на-тспу/06dca39b13a0dbcd67e6959c04bc70526cf1422a_2_1035x72.png 1.5x, блокировка-шифра-в-сторону-cloudflare-на-тспу/06dca39b13a0dbcd67e6959c04bc70526cf1422a_2_1380x96.png 2x" data-dominant-color="354D34"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">1450×102 9.48 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div><br>
<a class="attachment" href="блокировка-шифра-в-сторону-cloudflare-на-тспу/mYOQXI1zlBjrdntOEDz7TV6Vt0r.pcap">dump2.pcap</a> (3,0 КБ)<br>
Снова с api стало повторяться, и с ответом уже в этот раз. Прикрепил второй файл.</p></td><td>2024-03-31T15:59:53.922Z</td></tr><tr><td>ValdikSS</td><td><p>Блокируют <code>Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)</code>, если он стоит на 4 месте в списке ciphersuites, в сочетании еще с каким-то фактором, в сторону IP-адресов Cloudflare.<br>
Независимо от домена, похоже.</p></td><td>2024-03-31T16:59:15.200Z</td></tr><tr><td>ValdikSS</td><td><p>Репродьюсер (нужен curl с openssl)<br>
<code>curl -v https://bo0om.ru --tls-max 1.2 --ciphers ECDHE-RSA-AES128-GCM-SHA256</code></p></td><td>2024-03-31T18:01:34.831Z</td></tr><tr><td>neikist</td><td><p>Угу, действительно, спасибо! Поменял cipherSuites - блокировка пропала.</p></td><td>2024-03-31T18:27:01.549Z</td></tr><tr><td>Mixaill(Mikhail Paulyshka)</td><td><p>Да, наблюдаем недоступность хостов за Cloudflare если доступ осуществляется через CURL/libcurl с дефолтными настройками под Windows(бекенд SChannel).</p>
<p>Началось у пользователей в 27.03.2024 00:00 UTC+3 с резким скачком вверх в 31.03.2024 00:00 UTC+3</p></td><td>2024-03-31T22:10:33.541Z</td></tr><tr><td>0ka(0ka)</td><td><p>del</p></td><td>2024-04-01T06:48:35.481Z</td></tr><tr><td>0ka(0ka)</td><td><p>не только на ip cloudflare, даже на зеркалах cloudflare воспроизводится</p>
<p>upd: а точнее на тех, где используется стандартный сертификат google trust services, на домен <a href="http://www.speedtest.net">www.speedtest.net</a> у меня блока нет (там другой сертификат)</p></td><td>2024-04-01T06:53:43.269Z</td></tr><tr><td>Fixator10</td><td><p>В жертвы также можно записать: Parsec, ShareX, авторизация (по меньшей мере в Twitch) в OBS<br>
Роскомнадзор в очередной раз умудрился поблочить половину сети.</p></td><td>2024-04-01T08:20:28.000Z</td></tr><tr><td>0ka(0ka)</td><td><p>пробуй решение <a href="https://osu.ppy.sh/community/forums/posts/9489580" class="inline-onebox">Вся информация касательно бана Bancho · forum | osu!</a></p></td><td>2024-04-01T08:59:08.294Z</td></tr><tr><td>libneko</td><td><p>В тот же вагон: разбирался в чем проблема с Plex, и нашел такую закономерность:</p>
<p>Если в cloudflare принудительно отключить TLS v1.3 для своего домена, то в Firefox сайт перестает открываться <img src="https://ntc.party/images/emoji/twitter/thinking.png?v=12" title=":thinking:" class="emoji" alt=":thinking:" loading="lazy" width="20" height="20"></p>
<p>Но при этом конкретно Plex не открывается ни в Firefox, ни в Safari, ни в Chrome</p></td><td>2024-04-01T08:59:34.435Z</td></tr><tr><td>libneko</td><td><p>Это моё решение для кастомного лаунчера финалки, да <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>
<p>Увы, но сработает только в ситуациях когда используется виндовый http стек. В том случае был дотнет с принудительным даунгрейдом до TLS 1.2 перед запросом</p>
<p>Перепечатаю сюда на всякий, коль народ сюда тоже отправляют:</p>
<blockquote>
<p>Как без использования VPN временно обойти ошибку лаучнера “XIVLauncher failed to check for updates”/сломанное меню плагинов даламуда:</p>
<ol>
<li>Открыть Powershell из под админа</li>
<li><code>Disable-TlsCipherSuite -Name TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code></li>
</ol>
<p>Это отключит один из наборов шифров TLS (<a href="https://en.wikipedia.org/wiki/Cipher_suite" class="inline-onebox">Cipher suite - Wikipedia</a>), что потенциально может что-нибудь сломать (а может и не сломать). Не думаю что это может создать какие-нибудь проблемы в безопасности, так как этот набор не в списке рекомендуемых (но все еще в списке безопасных)</p>
<p>Откатить всегда можно следующей командой: <code>Enable-TlsCipherSuite -Name TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code></p>
</blockquote></td><td>2024-04-01T09:01:33.002Z</td></tr><tr><td>Fixator10</td><td><p>ShareX и OBS это помогло. Но не Parsec’у, т.к. он, скорее всего, запросы делает альтернативными путями</p></td><td>2024-04-01T09:30:58.249Z</td></tr><tr><td>Mixaill(Mikhail Paulyshka)</td><td><p>Поправка по датировке: первый случай зафиксирован в 21.03.2024 08:55 UTC+3 у провайдера Ростелеком</p></td><td>2024-04-01T10:49:39.380Z</td></tr><tr><td>libneko</td><td><p><a href="http://vrchat.com">vrchat.com</a> туда же</p>
<p>Аналогично: cloudflare, но при этом сертификат не от GTS а от LE. Тоже отключен 1.3 на стороне CF.</p></td><td>2024-04-01T11:15:24.695Z</td></tr><tr><td>Shii</td><td><p>А для <a href="http://vrchat.com" rel="noopener nofollow ugc">vrchat.com</a> есть решение помимо VPN? Пробовал отключать шифр TLS как в примере выше, но не помогло.</p></td><td>2024-04-01T11:44:31.896Z</td></tr><tr><td>neikist</td><td><p>del</p></td><td>2024-04-01T11:56:28.304Z</td></tr><tr><td>anonimnyj24(anonimnyj24)</td><td><p>Странно, что TLS Server Hello в принципе дошёл при блокировке какого-то алгоритма.</p></td><td>2024-04-01T12:08:37.639Z</td></tr><tr><td>anonimnyj24(anonimnyj24)</td><td><p>Судя по всему, блокировка возникает только если в TLS Server Hello указан запрещённый Cipher Suite</p></td><td>2024-04-01T12:18:28.594Z</td></tr><tr><td>anonimnyj24(anonimnyj24)</td><td><p><code>curl -v https://bo0om.ru --tls-max 1.3 --ciphers ECDHE-RSA-AES128-GCM-SHA256</code> - подключает<br>
<code>curl -v https://bo0om.ru --tls-max 1.2 --ciphers ECDHE-RSA-AES128-GCM-SHA256</code> - не подключает</p></td><td>2024-04-01T12:26:22.031Z</td></tr><tr><td>anon57137390</td><td><aside class="quote no-group" data-username="anonimnyj24" data-post="23" data-topic="7618">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/a/67e7ee/48.png" class="avatar"> anonimnyj24:</div>
<blockquote>
<p><code>curl -v https://bo0om.ru --tls-max 1.3 --ciphers ECDHE-RSA-AES128-GCM-SHA256</code> - подключает</p>
</blockquote>
</aside>
<p>Вы проверяли используемый в результате шифронабор через дамп или из репорта curl  в строчке: <code>SSL connection using TLSv</code>?</p>
<blockquote>
<p>There are new ciphersuites that only work in TLSv1.3. The old ciphersuites cannot be used for TLSv1.3 connections and the new ones cannot be used in TLSv1.2 and below.</p>
</blockquote>
<pre><code class="lang-auto">    TLS_AES_256_GCM_SHA384
    TLS_CHACHA20_POLY1305_SHA256
    TLS_AES_128_GCM_SHA256
    TLS_AES_128_CCM_8_SHA256
    TLS_AES_128_CCM_SHA256
</code></pre></td><td>2024-04-01T12:57:30.663Z</td></tr><tr><td>anonimnyj24(anonimnyj24)</td><td><p>А да, странно что curl в принципе не выкинул ошибку</p></td><td>2024-04-01T13:21:32.900Z</td></tr><tr><td>libneko</td><td><p>Оставил сообщение на форуме cloudflare: <a href="https://community.cloudflare.com/t/russia-blocks-tls-v1-2-requests-to-cloudflare-edges/636460">https://community.cloudflare.com/t/russia-blocks-tls-v1-2-requests-to-cloudflare-edges/636460</a></p></td><td>2024-04-01T13:53:24.607Z</td></tr><tr><td>ValdikSS</td><td><p>Причина, похоже, всё же не совсем в cipher’ах. Наиболее вероятно то, что цензурирующей системе не нравится что-то в ответе сервера, а не в запросе клиента. Я воспроизвёл проблему на своём сервере (не IP Cloudflare), проксируя запросы к Cloudflare.</p>
<p>Это объясняет, почему с TLS 1.3 нет проблем (у TLS 1.2 и 1.3 ответы прилично различаются), и почему изменение Cipher’ов исправляет проблему (ответ сервера меняется, возможно, просто сравниваются определённые байты на определённых местах). Кроме того, проблема не проявляется при подключении к <a href="http://community.cloudflare.com">community.cloudflare.com</a>, а там используется другая цепочка сертификатов.</p>
<p>Поотлаживайте, у кого есть время и желание.</p></td><td>2024-04-01T14:49:10.829Z</td></tr><tr><td>aypetrov(Alexey Petrov)</td><td><p>Вероятно проблема не в фильтрации Client Hello, а в фильтрации Server Hello. Когда в нем первым шифром идет ECDHE-RSA-AES128-GCM-SHA256 - соединение блокируется. Для TLSv1.3 шифры другие поэтому и проблема исчезает.</p>
<p>Поэтому изменение порядка шифров тоже может излечить проблему при условии что CF выбирает первый поддерживаемый из списка.</p></td><td>2024-04-01T16:00:51.747Z</td></tr><tr><td>Shii</td><td><p>Кажется, заработало. <a href="http://vrchat.com" rel="noopener nofollow ugc">vrchat.com</a> и <a href="http://app.plex.tv" rel="noopener nofollow ugc">app.plex.tv</a> начали открываться сами по себе.</p></td><td>2024-04-01T16:11:47.958Z</td></tr><tr><td>neikist</td><td><p>Ага, похоже откатили. У нас прошлые версии приложения тоже заработали.</p></td><td>2024-04-01T16:53:56.136Z</td></tr><tr><td>Mixaill(Mikhail Paulyshka)</td><td><p>Да, начали поэтапно откатывать начиная с 18:10 UTC+3</p></td><td>2024-04-01T17:20:06.402Z</td></tr><tr><td>0ka(0ka)</td><td><p>del</p></td><td>2024-04-01T21:03:10.764Z</td></tr><tr><td>anonymous132(anonymous132)</td><td><p>Это была сигнатура для Lantern. Сервера опознают по шифру, количеству сертификатов в цепочке и возможно их размеру. УЦ разные, к ним привязки нет. Результат вы видели.</p></td><td>2024-04-03T00:56:18.454Z</td></tr>
    </table>
      </body>
    </html>