
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>Angry_Agent(Angry Agent)</td><td><p><em><strong>Предыстория</strong></em></p>
<p>С сентября 2023 года, игроки массово (не по всей стране сразу) с разных регионов и с разных провайдеров стали жаловаться на невозможность зайти на любой игровой сервер в игре SCP Secret Laboratory, это происходило практически в одно и тоже время, но точно в один день, это различные волны блокировок, которые касаются не всех и не сразу, у некоторых блокировка пропадает спустя несколько дней, а у кого-то она и вовсе не пропадает:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/d1f5b7ed5f4ed038ec27f41a8e156b731d594d5d.png" data-download-href="https://ntc.party/uploads/default/d1f5b7ed5f4ed038ec27f41a8e156b731d594d5d" title="изображение"><img src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/d1f5b7ed5f4ed038ec27f41a8e156b731d594d5d_2_414x500.png" alt="изображение" data-base62-sha1="tXoeVhDZK2gKwpjZLbBl0SauGdv" width="414" height="500" srcset="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/d1f5b7ed5f4ed038ec27f41a8e156b731d594d5d_2_414x500.png, случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/d1f5b7ed5f4ed038ec27f41a8e156b731d594d5d_2_621x750.png 1.5x, случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/d1f5b7ed5f4ed038ec27f41a8e156b731d594d5d_2_828x1000.png 2x" data-dominant-color="2C2E32"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">изображение</span><span class="informations">832×1004 44.8 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/51d11bc29172129c8e43ad0ddad0908be3b1c44a.png" data-download-href="https://ntc.party/uploads/default/51d11bc29172129c8e43ad0ddad0908be3b1c44a" title="изображение"><img src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/51d11bc29172129c8e43ad0ddad0908be3b1c44a_2_645x500.png" alt="изображение" data-base62-sha1="bFMGEa9iNFh7TFgUP4WjAT4f2si" width="645" height="500" srcset="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/51d11bc29172129c8e43ad0ddad0908be3b1c44a_2_645x500.png, случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/51d11bc29172129c8e43ad0ddad0908be3b1c44a.png 1.5x, случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/51d11bc29172129c8e43ad0ddad0908be3b1c44a.png 2x" data-dominant-color="242629"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">изображение</span><span class="informations">815×631 30.1 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/311cb952bde93f503cc9f64c3520bda2510ae393.png" data-download-href="https://ntc.party/uploads/default/311cb952bde93f503cc9f64c3520bda2510ae393" title="изображение"><img src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/311cb952bde93f503cc9f64c3520bda2510ae393.png" alt="изображение" data-base62-sha1="70sW4V8prtt5P4qdrvg0GAWXBC3" width="520" height="500" data-dominant-color="2C2D2E"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">изображение</span><span class="informations">804×772 37.9 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>Видео:</p><div class="youtube-onebox lazy-video-container" data-video-id="HaqmvzQgPBs" data-video-title="ТСПУ блокирует SCP Secret Laboratory" data-video-start-time="" data-provider-name="youtube">
  <a href="https://www.youtube.com/watch?v=HaqmvzQgPBs" target="_blank" class="video-thumbnail" rel="noopener nofollow ugc">
    <img class="youtube-thumbnail" src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/2b591cf16ef5c6bc506d764f994dbd8731b51b7f.jpeg" title="ТСПУ блокирует SCP Secret Laboratory" data-dominant-color="252122" width="690" height="388">
  </a>
</div>

<p>Владельцам серверов буквально пришлось рекомендовать использовать VPN игрокам, которые не могли зайти на сервера, <strong>и это помогало</strong>, сами же разработчики игры стали советовать тоже самое.</p>
<p><em><strong>Техническая часть</strong></em></p>
<p>Игра сделана на Unity, используется сетевой движок Mirror, транспорт LiteNetLib. В игре есть список серверов, он работает по HTTPS, с этим никаких проблем нет, проблемы начинаются только непосредственно при попытке подключится на сервер по UDP, сервер успевает отправить клиенту команду на загрузку сцены <code>Assets/_Scenes/Facility.unity</code>, а далее соединение уже блокируется на ТСПУ.</p>
<p>Дампы с блокировкой соединения:<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/dfHNaFNkHGdkaWLyIcxlhaKoh6k.pcapng">packet_loss_from_client.pcapng</a> (6,3 КБ)<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/7gzD8NYhzfXEXaf9LuzVp122Ad9.pcapng">TSPU block scp secret laboratory.pcapng</a> (14,3 КБ)</p>
<p>Дамп, где соединение проходит нормально используя VPN:<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/xe4KNl7wPte1104EyzdH2pTP4up.pcapng">scp sl normal connection.pcapng</a> (552,1 КБ)</p>
<p>Сетевой движок игры может переотправлять UDP пакеты, если они не дошли до сервера, в дампах же видно большое количество переотправленных пакетов:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/63c21fac35a49ea5e035dfe07d27e9239917ca76.png" data-download-href="https://ntc.party/uploads/default/63c21fac35a49ea5e035dfe07d27e9239917ca76" title=""><img src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/63c21fac35a49ea5e035dfe07d27e9239917ca76.png" alt="" data-base62-sha1="eevb1bVjMFGqAhOPz5jqTDoWlPU" width="690" height="389" role="presentation" data-dominant-color="988E8F"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename"></span><span class="informations">1598×902 32.6 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p><em><strong>Диагностика</strong></em></p>
<p>Некоторые владельцы серверов стали почему-то считать, что это баг игры или какая-нибудь ddos атака на сервер, но это не так. Мне удалось договорится с одним игроком(у которого соответственно имеется эта проблема в виде блокировки), чтобы он у себя развернул виртуальную машину на базе VirtualBox, где уже был заготовлен OpenVPN сервер, потому что этой блокировки не было на ТСПУ в моём регионе. Далее я подключился к этому OpenVPN серверу и сделал трассировки для выявления хопа с ТСПУ:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/dfbbb07a9596ad7cc67f15e69ed7d43e44684ec3.png" data-download-href="https://ntc.party/uploads/default/dfbbb07a9596ad7cc67f15e69ed7d43e44684ec3" title="Трассировка по ICMP до заблокированного IP-адреса на ТСПУ"><img src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/dfbbb07a9596ad7cc67f15e69ed7d43e44684ec3.png" alt="Трассировка по ICMP до заблокированного IP-адреса на ТСПУ" data-base62-sha1="vVeB6KTAd081ptMpn4nkxwR26pt" width="621" height="500" data-dominant-color="EEEEEE"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Трассировка по ICMP до заблокированного IP-адреса на ТСПУ</span><span class="informations">691×556 7.97 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div><br>
<strong>(Трассировка по ICMP до заблокированного IP-адреса на ТСПУ)</strong><br>
<div class="lightbox-wrapper"><a class="lightbox" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/2a50a52666ed397d767a0744947bafa7cdaf487b.png" data-download-href="https://ntc.party/uploads/default/2a50a52666ed397d767a0744947bafa7cdaf487b" title="Трассировка по UDP до любого не заблокированного IP-адреса на ТСПУ"><img src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/2a50a52666ed397d767a0744947bafa7cdaf487b.png" alt="Трассировка по UDP до любого не заблокированного IP-адреса на ТСПУ" data-base62-sha1="62kPMdP60WwF9NCDJBQCNdI4hB1" width="690" height="322" data-dominant-color="080808"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Трассировка по UDP до любого не заблокированного IP-адреса на ТСПУ</span><span class="informations">951×444 3.89 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div><br>
<strong>(Трассировка по UDP до любого не заблокированного IP-адреса на ТСПУ)</strong></p>
<p>ТСПУ идёт после хопа 10.210.116.18, виден как при трассировке по ICMP, так виден и при трассировке по UDP, какой-либо балансировки с IP-адресами по трассировке в сети провайдера я не увидел.</p>
<p>Я решил с помощью iptables модифицировать TTL прямо в моменте соединения к серверу, и в дампах видно отсутствие ICMP TTL Exceeded пакетов от IP-адресов, которые находятся за пределами ТСПУ, пакеты не выходили за пределы сети провайдера:<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/1a3KJNRLvv0CYlFt4bdJk0sDuqO.pcap">modify_ttl.pcap</a> (6,9 КБ)<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/4kGOGxPv8EXXju8f72nn1QeoKp0.pcap">modify_ttl_1.pcap</a> (6,7 КБ)<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/sS8pgsQO8dWWFnwCJQRpurMNUTu.pcap">modify_ttl_2.pcap</a> (6,8 КБ)<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/qSvnxnBu8YBZhEFGMA5mp4UNnMp.pcap">modify_ttl_3.pcap</a> (6,6 КБ)<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/gItFN1wSMwfQH9yaEZqzwzBDra8.pcap">modify_ttl_4.pcap</a> (6,5 КБ)<br>
<a class="attachment" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/8xsfoKP4wZorWd03HtUGJsFGm7E.pcap">modify_ttl_5.pcap</a> (6,5 КБ)<br>
<strong>(При просмотре дампов обращайте внимание на поле TTL в IP заголовке)</strong></p>
<p><em><strong>Воспроизведение блокировки искусственным путём</strong></em></p>
<p>В поисках паттерна, обнаружил, что самым главным условием является то, чтобы ответ от сервера был именно путь до загружаемой сцены <code>Assets/_Scenes/Facility.unity</code> и какой-то определённый ответ от клиента(который мне не удалось выявить), однако блокировка будет срабатывать, даже если ответ от сервера будет например <code>Assets/Zfjdsjf/Sfjsdfij</code> (вероятней всего используется какое-то регулярное выражение на основе regexp).<br>
Запускаем на сервере netcat:</p>
<pre data-code-wrap="bash"><code class="lang-bash">ncat -klu 7777 -v --sh-exec "echo -n 'Assets/_Scenes/Facility.unity'"
</code></pre>
<p>Со стороны клиента отправляем 5 пакетов с определённым содержимым с помощью nping:</p>
<pre data-code-wrap="bash"><code class="lang-bash">nping --udp --data "0c0d0002000002010000000000000000200001000002755f29266a7071400fcba206000003000500070009001000039f8f00140000755f29266a7071400a7f81755f29266a707140" -c 5 -g 25591 -p 7777 X.X.X.X
</code></pre>
<p>Содержимое в <code>--data</code> был взят из дампа, пакет с таким содержимым высылает сам клиент игры.<br>
После отправки 3-4-ёх пакетов, соединение блокируется на ТСПУ:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/7a2234294933385a19773a0a0725008401087cc9.png" data-download-href="https://ntc.party/uploads/default/7a2234294933385a19773a0a0725008401087cc9" title="изображение"><img src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/7a2234294933385a19773a0a0725008401087cc9.png" alt="изображение" data-base62-sha1="hqrx1jVPdQN2ZoyzRt2eQIxtrbb" width="690" height="278" data-dominant-color="171818"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">изображение</span><span class="informations">1608×649 19.6 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p><em><strong>Решение проблемы</strong></em></p>
<p>Владельцы серверов могут легко решить проблему, установив nfqws от zapret на сервер:</p>
<ol>
<li>Скачать на сервер nfqws - <a href="https://github.com/bol-van/zapret/blob/master/binaries/x86_64/nfqws" class="inline-onebox" rel="noopener nofollow ugc">zapret/binaries/x86_64/nfqws at master · bol-van/zapret · GitHub</a></li>
<li>Запустить его из под рута в tmux следующей командой: <code>./nfqws --qnum=250 --dpi-desync-any-protocol=1 --dpi-desync-repeats=20 --dpi-desync-fwmark=0x40000000 --dpi-desync=fake --dpi-desync-fake-unknown-udp=0x0726b1a36a672ddc080d0003a19b3902009020</code><br>
<strong>Payload пришлось подбирать специфичный, сетевой движок на клиенте может крашнутся, если он получит какой-либо пакет от сервера, который не связан с игрой, стандартный payload в виде нулей в этом случае не подойдёт.</strong></li>
<li>Добавить правило iptables: <code>iptables -t mangle -A POSTROUTING -p udp -m multiport --sports 7777:7790 -m connbytes --connbytes 1:1 --connbytes-mode packets --connbytes-dir original -m mark ! --mark 0x40000000/0x40000000 -j NFQUEUE --queue-num 250 --queue-bypass</code> (диапазон портов сменить, если он у вас другой)</li>
<li>Это заставит сервер отправить 20 фейковых пакетов единоразово в сторону клиента, клиент эти пакеты проигнорирует, а затем уже будет отправлен исходный пакет от сервера, это решает проблему с ложной блокировкой игры со стороны ТСПУ.</li>
</ol>
<p>Со стороны клиента так же помогает:</p>
<pre data-code-wrap="bash"><code class="lang-bash">./nfqws --qnum=250 --dpi-desync-any-protocol=1 --dpi-desync-repeats=20 --dpi-desync-fwmark=0x40000000 --dpi-desync=fake
</code></pre>
<pre data-code-wrap="bash"><code class="lang-bash">iptables -t mangle -A POSTROUTING -p udp -m multiport --dports 7777:7790 -m connbytes --connbytes 1:1 --connbytes-mode packets --connbytes-dir original -m mark ! --mark 0x40000000/0x40000000 -j NFQUEUE --queue-num 250 --queue-bypass
</code></pre>
<p><strong>Серверу уже всё равно на стандартный payload в виде нулей, он от этого не крашается.</strong></p></td><td>2024-04-11T14:27:33.857Z</td></tr><tr><td>wigeance(Wigeance)</td><td><p>Исследование интересное, но:</p>
<aside class="quote no-group" data-username="Angry_Agent" data-post="1" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/angry_agent/48/4030_2.png" class="avatar"> Angry_Agent:</div>
<blockquote>
<p>Payload пришлось подбирать специфичный, сетевой движок на клиенте может крашнутся, если он получит какой-либо пакет, который не связан с игрой, стандартный payload в виде нулей в этом случае не подойдёт.</p>
</blockquote>
</aside>
<p>Не замечал ни в одной игре никаких проблем при отправке стандартных фейков (нулей) запретом со стороны клиента (именно SCP не проверял, но в других сетевых играх такой проблемы нет).</p>
<aside class="quote no-group" data-username="Angry_Agent" data-post="1" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/angry_agent/48/4030_2.png" class="avatar"> Angry_Agent:</div>
<blockquote>
<p>Это заставит сервер отправить 20 фейковых пакетов единоразово в сторону клиента, клиент эти пакеты проигнорирует, а затем уже будет отправлен исходный пакет от сервера, это решает проблему с ложной блокировкой игры со стороны ТСПУ.</p>
</blockquote>
</aside>
<p>20 фейковых пакетов это по-моему перебор, для обхода любых блокировок udp на данный момент хватает 6 фейков. Хотя конечно все зависит от провадера, но чтобы больше 6 фейков надо было пока не встречал.</p></td><td>2024-04-11T14:46:44.504Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><aside class="quote no-group" data-username="wigeance" data-post="2" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/wigeance/48/3861_2.png" class="avatar"> wigeance:</div>
<blockquote>
<p>Не замечал ни в одной игре никаких проблем при отправке стандартных фейков (нулей) запретом со стороны клиента (именно SCP не проверял, но в других сетевых играх такой проблемы нет).</p>
</blockquote>
</aside>
<p>Нули нельзя отправлять <strong>лишь только со стороны сервера клиенту</strong>, иначе на клиенте сетевой движок выпадет в exception и все игроки зависнут на месте лишь только визуально на клиенте, сетевой обмен перестанет работать. От клиента к серверу отправлять нули можно.</p>
<aside class="quote no-group" data-username="wigeance" data-post="2" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/wigeance/48/3861_2.png" class="avatar"> wigeance:</div>
<blockquote>
<p>20 фейковых пакетов это по-моему перебор, для обхода любых блокировок udp на данный момент хватает 6 фейков. Хотя конечно все зависит от провадера, но чтобы больше 6 фейков надо было пока не встречал.</p>
</blockquote>
</aside>
<p>Да, согласен, но я перестраховался на всякий случай.</p></td><td>2024-04-11T14:49:35.276Z</td></tr><tr><td>haste</td><td><p>Чтобы такого не происходило впредь - посоветуйте разработчикам игры шифровать трафик <img src="https://ntc.party/images/emoji/twitter/innocent.png?v=12" title=":innocent:" class="emoji" alt=":innocent:" loading="lazy" width="20" height="20"></p></td><td>2024-04-11T16:50:30.184Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><p>Не думаю, что в этом есть какой-то смысл, к тому же ничего не исключает вероятность случайной блокировки и зашифрованного трафика. Шифрование трафика может сломать готовые правила для защиты от DDoS-атак на эту игру, особенно у Stormwall.</p>
<p>Когда-то обсуждал с разработчиком про шифрование голосового чата в игре, он написал что смысла от этого нет.</p></td><td>2024-04-11T17:12:44.612Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><aside class="quote no-group" data-username="Angry_Agent" data-post="1" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/angry_agent/48/4030_2.png" class="avatar"> Angry_Agent:</div>
<blockquote>
<p>В поисках паттерна, обнаружил, что самым главным условием является то, чтобы ответ от сервера был именно путь до загружаемой сцены <code>Assets/_Scenes/Facility.unity</code> и какой-то определённый ответ от клиента(который мне не удалось выявить), однако блокировка будет срабатывать, даже если ответ от сервера будет например <code>Assets/Zfjdsjf/Sfjsdfij</code> (вероятней всего используется какое-то регулярное выражение на основе regexp).</p>
</blockquote>
</aside>
<p>Заметил новое: если сервер будет возвращать просто набор букв <code>Djasdjcxa/Jdhdashc/Jcxnduas</code>, то соединение так же будет блокироваться.</p>
<p>Сервер:</p>
<pre data-code-wrap="bash"><code class="lang-bash">ncat -klu 7777 -v --sh-exec "echo -n 'Djasdjcxa/Jdhdashc/Jcxnduas'"
</code></pre>
<p>Клиент:</p>
<pre data-code-wrap="bash"><code class="lang-bash">nping --udp --data "0c0d0002000002010000000000000000200001000002755f29266a7071400fcba206000003000500070009001000039f8f00140000755f29266a7071400a7f81755f29266a707140" -c 5 -g 25599 -p 7777 X.X.X.X
</code></pre>
<p>А если сервер например будет возвращать <code>fsdfdsff</code>, то никакая блокировка и не будет происходить.</p></td><td>2024-04-11T17:15:36.579Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><aside class="quote no-group" data-username="Angry_Agent" data-post="1" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/angry_agent/48/4030_2.png" class="avatar"> Angry_Agent:</div>
<blockquote>
<p>Со стороны клиента отправляем 5 пакетов с определённым содержимым с помощью nping:</p>
<p><code>nping --udp --data "0c0d0002000002010000000000000000200001000002755f29266a7071400fcba206000003000500070009001000039f8f00140000755f29266a7071400a7f81755f29266a707140" -c 5 -g 25591 -p 7777 X.X.X.X</code></p>
</blockquote>
</aside>
<p>Соединение на ТСПУ может заблокироваться даже вот с таким отправленным пакетом со стороны клиента лол:</p>
<pre data-code-wrap="bash"><code class="lang-bash">nping --udp --data "0c0d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" -c 5 -g 23700 -p 7777 X.X.X.X
</code></pre>
<p>Главное чтобы при этом ответ от сервера был схожим на <code>Assets/_Scenes/Facility.unity</code>, например <code>Djasdjcxa/Jdhdashc/Jcxnduas</code></p></td><td>2024-04-11T17:40:12.072Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><aside class="quote no-group" data-username="Angry_Agent" data-post="7" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/angry_agent/48/4030_2.png" class="avatar"> Angry_Agent:</div>
<blockquote>
<p>Соединение на ТСПУ может заблокироваться даже вот с таким отправленным пакетом со стороны клиента лол:</p>
<p><code>nping --udp --data "0c0d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" -c 5 -g 23700 -p 7777 X.X.X.X</code></p>
</blockquote>
</aside>
<p>Ещё схожее обнаружил, точно так же блокируется на ТСПУ:</p>
<pre data-code-wrap="bash"><code class="lang-bash">nping --udp --data "0d000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" -c 5 -g 23709 -p 7777 X.X.X.X
</code></pre></td><td>2024-04-11T17:45:48.636Z</td></tr><tr><td>haste</td><td><p>Имелось в виду - если не будет сигнатур - по сигнатурам, случайно, уже не заблокируют.</p></td><td>2024-04-11T18:22:46.064Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><p>Ну судя по тому, что я обнаружил выше, как-то сложно соотнести блокировку к какой-то сигнатуре в виде кучи нулей и рандомных английских букв.</p></td><td>2024-04-11T18:25:05.693Z</td></tr><tr><td>haste</td><td><p>Посмотрите последние сообщения в теме <a href="https://ntc.party/t/%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0-%D1%88%D0%B8%D1%84%D1%80%D0%B0-%D0%B2-%D1%81%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D1%83-cloudflare-%D0%BD%D0%B0-%D1%82%D1%81%D0%BF%D1%83/7618/32" class="inline-onebox">Блокировка шифра в сторону Cloudflare на ТСПУ - #32 by 0ka</a><br>
Тоже ловили сигнатурой одно, а поймали другое…</p></td><td>2024-04-12T11:30:13.337Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><p>В той теме блокировка происходила хотя бы на основе каких-то полезных данных в пакете, а тут соединение блокируется даже без какой либо смысловой и полезной нагрузки.<br>
На сервере:</p>
<pre data-code-wrap="bash"><code class="lang-bash">ncat -klu 7777 -v --sh-exec "echo -n 'Aaaaaaaaaa/aaaaaaaaa/aaaaaaaaa'"
</code></pre>
<p>На клиенте:</p>
<pre data-code-wrap="bash"><code class="lang-bash"> nping --udp --data "0a0d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" -c 5 -g 23712 -p 7777 X.X.X.X
</code></pre>
<p>2-3 пакета и ТСПУ блокирует соединение.</p></td><td>2024-04-16T08:13:37.596Z</td></tr><tr><td>haste</td><td><p>Я не настоящий сварщик, но уверен, что ТСПУ “все равно”, есть в пакете полезная нагрузка или нет. Оно срабатыает либо по спискам адресов, либо по сигнатурам. В вашем случае, видимо, срабатывает сигнатура. Делать сложный анализ пакетов в массовом пордке - дорого, в терминах нагрузки на процессор, поэтому делают анализ максимально простым. В вашем слуае - сделали правило типа “если в запросе первые байты 0x0a0d, а в ответе 7 и 17 байты - буквы ‘а’ - заблокировать”. И в 99.9% случаев это срабатывает - блокируется только вредный, преступый, террористический трафик.</p>
<p>Выходов два - писать в Спортлото, чтобы поправили сигнатуру, или поправить протокол.<br>
Если переделывать протокол - я бы предложил его зашифровать, без фанатизма - просто ради того, чтобы не было повторяющихся частей, за которые может зацепиться это или какое-то следующее правило.</p>
<p>(Пишу это в основном для того, чтобы, если неправ, меня поправили настоящие сварщики.)</p></td><td>2024-04-16T12:42:02.895Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><aside class="quote no-group" data-username="haste" data-post="13" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/h/e0b2c6/48.png" class="avatar"> haste:</div>
<blockquote>
<p>а в ответе 7 и 17 байты - буквы ‘а’ - заблокировать</p>
</blockquote>
</aside>
<p>Там срабатывает на любые буквы вообще, возможно используется регулярка, не дорого ли для процессора делать регулярку в этом случае?</p>
<aside class="quote no-group" data-username="haste" data-post="13" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/h/e0b2c6/48.png" class="avatar"> haste:</div>
<blockquote>
<p>Если переделывать протокол - я бы предложил его зашифровать, без фанатизма - просто ради того, чтобы не было повторяющихся частей, за которые может зацепиться это или какое-то следующее правило.</p>
</blockquote>
</aside>
<p>Ну зная, как “работают” разработчики этой игры, не думаю что они возьмут и на “ура” сделают это самое шифрование.</p></td><td>2024-04-16T12:52:15.886Z</td></tr><tr><td>anonymous136(anonymous136)</td><td><p>Возможно, содержимое не учитывают совсем или всё чуть сложнее. Блокировка воспроизводится для небольших датаграмм с рандомной нагрузкой. Исходящие размером 55-74 байт, входящие 20-100 байт. Схема: запрос-ответ. После 2-3 ответов следует блокировка.</p></td><td>2024-04-17T11:59:41.343Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><p>Если отправлять только нули с размерами 55-74 байт со стороны клиента, 20-100 байт со стороны сервера, то блокировка не происходит.</p>
<aside class="quote no-group" data-username="anonymous136" data-post="15" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/a/8797f3/48.png" class="avatar"> anonymous136:</div>
<blockquote>
<p>совсем или всё чуть сложнее</p>
</blockquote>
</aside>
<p>Тут скорее всего всё в разы сложнее.</p></td><td>2024-04-17T12:32:03.357Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><aside class="quote no-group" data-username="anonymous136" data-post="15" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/a/8797f3/48.png" class="avatar"> anonymous136:</div>
<blockquote>
<p>Блокировка воспроизводится для небольших датаграмм с рандомной нагрузкой</p>
</blockquote>
</aside>
<p>Блокировка воспроизводится даже вот так, без рандомных данных:<br>
Сервер:</p>
<pre data-code-wrap="bash"><code class="lang-bash">ncat -klu 7777 -v --sh-exec "echo -n '1110000000000000000000000000000000000000' | xxd -r -p"
</code></pre>
<p>Клиент:</p>
<pre data-code-wrap="bash"><code class="lang-bash">nping --udp --data "11100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" -c 5 -g 23742 -p 7777 X.X.X.X
</code></pre></td><td>2024-04-17T12:36:07.105Z</td></tr><tr><td>anonymous136(anonymous136)</td><td><p>Наблюдение: Множество ТСПУ где <a href="https://ntc.party/t/%D0%BE%D0%B1%D1%81%D1%83%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0-jabberxmpp-%D0%B2-%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B8/5984">сейчас блокируют (блокировали) XMPP</a> пересекается с множеством ТСПУ блокирующих UDP пакеты из этой темы. Притом обе блокировки встречаются достаточно редко, примерно как ТСПУ в байпасе.</p></td><td>2024-04-17T17:23:11.865Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><aside class="quote quote-modified" data-post="34" data-topic="5984">
  <div class="title">
    <div class="quote-controls"></div>
    <img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/valdikss/48/2_2.png" class="avatar">
    <a href="https://ntc.party/t/%D0%BE%D0%B1%D1%81%D1%83%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0-jabberxmpp-%D0%B2-%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B8/5984/34">Обсуждение: Блокировка Jabber/XMPP в России</a> <a class="badge-category__wrapper " href="/c/internet-censorship-all-around-the-world/russia/12"><span data-category-id="12" style="--category-badge-color: #BF1E2E; --category-badge-text-color: #FFFFFF; --parent-category-badge-color: #0088CC;" data-parent-category-id="10" data-drop-close="true" class="badge-category --has-parent" title="Информация и обсуждение блокировок ресурсов в Российской Федерации"><span class="badge-category__name">Russia</span></span></a>
  </div>
  <blockquote>
    Да, похоже на блокировку, вероятно, по какому-то особому признаку. Предполагаю, что по ответу сервера, т.к. изменение домена и параметров в ClientHello не помогает. 
openssl s_client -starttls xmpp-server -host xmpp.quicksy.im -port 5269 -xmpphost quicksy.im -servername quicksy.im &lt;/dev/null &amp;&gt;/dev/null &amp;&amp; echo ok || echo fail 




Node
ISP
AS
City
test 9 Apr
test 10 Apr




RU-001
ТТК
AS8427
Magnitogorsk
ok
ok


RU-002
Интерсвязь is74
AS8369
Yemanzhelinsk
ok
ok


RU-003
МТС
AS28832
Chelyabinsk
…
  </blockquote>
</aside>

<p>Из этого сообщения у меня команда <code>openssl s_client -starttls xmpp-server -host xmpp.quicksy.im -port 5269 -xmpphost quicksy.im -servername quicksy.im &lt;/dev/null &amp;&gt;/dev/null &amp;&amp; echo ok || echo fail</code> выдаёт <code>fail</code></p></td><td>2024-04-18T09:36:02.842Z</td></tr><tr><td>Anyuta1166</td><td><p>EDIT: Прошу прощения, допустила ошибку при тестировании. Подтверждаю - у меня наблюдается и блокировка VPN, и блокировка XMPP, и блокировка по примерам из данной темы.</p>
<p>Еще, мне кажется что дело не в каком-то “множество ТСПУ”. У меня есть наблюдения, позволяющие полагать, что дело не в конкретных ТСПУ, а в неких черных списках. Предполагаю, что есть некие черные списки, в которые заносятся IP-адреса как источника (пользователей интернета), так и назначения (серверов в интернете). Заносятся они туда видимо по выявлении некой запрещенной активности, и по факту занесения туда коннекты от/к ним подвергаются более глубокому анализу.</p>
<p>Например, у меня сейчас наблюдается блокировка XMPP в сторону вышеупомянутого quicksy.im. Но в сторону моего личного сервера, коннекты к которому я некоторое время назад завернула в VPN и ТСПУ их не видит, блокировки сейчас нет, даже если выключить VPN.</p>
<p>При этом quicksy.im блочится с моего проводного провайдера, но работает через мобильную связь. Тут важно, что у меня статический IP у провайдера уже несколько лет.</p>
<p>Еще пример, я несколько лет активно пользуюсь OpenVPN, и с прошлой осени постоянно попадаю на блокировки. Сейчас наблюдаю блокировку перманентно уже на протяжении месяца. В то время как условно мои соседи с тем же провайдером - у них все работает, и они удивляются и утверждают, что никаких блокировок нет. Тут тоже важно, что у меня статический IP у провайдера уже несколько лет.</p>
<p>Мой коллега по работе попал под блокировку корпоративного (!) OpenVPN внутри (!) РФ , долго мучался, но стоило ему сменить IP у провайдера - все стало ок.</p></td><td>2024-04-18T12:02:27.525Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><aside class="quote no-group" data-username="Anyuta1166" data-post="20" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/a/5fc32e/48.png" class="avatar"> Anyuta1166:</div>
<blockquote>
<p>у меня наблюдается и блокировка VPN</p>
</blockquote>
</aside>
<p>У меня не блокируется OpenVPN и WireGuard.</p>
<aside class="quote no-group" data-username="Anyuta1166" data-post="20" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/a/5fc32e/48.png" class="avatar"> Anyuta1166:</div>
<blockquote>
<p>Предполагаю, что есть некие черные списки, в которые заносятся IP-адреса как источника (пользователей интернета), так и назначения (серверов в интернете)</p>
</blockquote>
</aside>
<p>Я взял абсолютно случайную VDS в аренду из рандомной локации, на ней так же воспроизводятся блокировки по UDP из данной темы.</p></td><td>2024-04-18T12:29:17.357Z</td></tr><tr><td>anon57137390</td><td><p>Смена BRAS или адреса может изменить маршрут и как следствие ТСПУ, зависит от топологии сети оператора. Обойти черные списки сменой адреса, не меняя сетевого поведения, можно было бы лишь кратковременно. В противном случае это лишает их смысла, там же не ручная работа. Существование кратковременных списков адресов-источников для отдельных правил <a href="https://ntc.party/t/%D0%B8%D0%BD%D0%B4%D0%B8%D0%B2%D0%B8%D0%B4%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D0%B4%D0%B8%D0%BD%D0%B0%D0%BC%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8-%D0%BF%D0%BE-%D1%82%D1%80%D0%B8%D0%B3%D0%B3%D0%B5%D1%80%D0%B0%D0%BC-%D0%BD%D0%B0-%D1%82%D1%81%D0%BF%D1%83/7318">задокументировано</a>.</p></td><td>2024-04-18T12:43:00.859Z</td></tr><tr><td>Anyuta1166</td><td><p>Ну я просто не знаю, как еще объяснить то, что у меня наблюдаются ВСЕ возможные блокировки, кроме того, что мой IP “взяли на карандаш”. Причем, у меня два разных проводных провайдера в Dual WAN конфигурации, на обоих статический IP, и на обоих идентичное поведение в плане блокировок</p></td><td>2024-04-18T12:56:23.255Z</td></tr><tr><td>Anyuta1166</td><td><p>Да, еще хочу отметить, про тестирование блокировки игры. Есть некий временной лаг до начала блокировки. Сначала я сделала 2 теста отправкой по 25 пакетов - и все успешно прошло, никаких блокировок (из чего я первоначально сделала неверный вывод что у меня этой блокировки нет). Через некоторое время я повторила тесты, и тут уже все последующие соединения начали блокироваться после 2-3 пакета.</p></td><td>2024-04-18T13:41:01.837Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><p>Такого не замечал, я замечал лишь только другой лаг, что соединение может заблокироваться после 3-4 пакетов на первый раз, а последующие разы будут 2-3 пакета.</p></td><td>2024-04-18T13:50:37.091Z</td></tr><tr><td>CIA_agent</td><td><p>По описанию прям похоже на “липкие блокировки” из Китая начиная с 2018 эдак года. Там на примере SS и мимикрии под HTTPS решили, что блекхолить трафик глупо и опасно(сервер меняется за пару минут при готовых скриптах автоматизации, а сетевая связанность остаётся поломанной) начав привязывать блок к источнику трафика и экспоненциально увеличивать время блока. Тот же SS при обнаружении для юзера блокировался сначала на пару минут, потом десятков, потом часов и тд. При этом другой юзер того же провайдера с тем же маршрутом трафика мог спокойно подключаться(первое время конечно, потом та же схема с детектом и баном на время)</p></td><td>2024-04-18T14:56:15.553Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><p>Если кому-то будет интересно проверить работу блокировки непосредственно прямо в игре:</p>
<ol>
<li>Скачиваем игру из Steam - <a href="https://store.steampowered.com/app/700330/SCP_Secret_Laboratory/" class="inline-onebox" rel="noopener nofollow ugc">SCP: Secret Laboratory on Steam</a>, она бесплатная</li>
<li>В списке серверов находим сервер Runic Library ENIGMA и подключаемся к нему, или же по прямому подключению - <code>185.9.145.157:7780</code><br>
<div class="lightbox-wrapper"><a class="lightbox" href="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/13b188151156859f360b4719c8ca2c8bffd630ea.png" data-download-href="https://ntc.party/uploads/default/13b188151156859f360b4719c8ca2c8bffd630ea" title="изображение"><img src="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/13b188151156859f360b4719c8ca2c8bffd630ea_2_690x94.png" alt="изображение" data-base62-sha1="2OdqKYGYuqj3qZu84mpeaWUci9k" width="690" height="94" srcset="случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/13b188151156859f360b4719c8ca2c8bffd630ea_2_690x94.png, случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/13b188151156859f360b4719c8ca2c8bffd630ea.png 1.5x, случайная-блокировка-игры-scp-secret-laboratory-на-тспу-по-udp-протоколу/13b188151156859f360b4719c8ca2c8bffd630ea.png 2x" data-dominant-color="56524E"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">изображение</span><span class="informations">1001×137 21.4 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></li>
</ol>
<p>Остальные сервера Runic Library идут с применением nfqws, для Enigm’ы я сделал исключение.</p>
<p>P.S. Некоторые крупные проекты уже применили nfqws.</p></td><td>2024-04-18T15:45:30.852Z</td></tr><tr><td>ValdikSS</td><td><p>Чуть поисследовал фильтр. Он, прежде всего, заточен на обнаружение пакетов определённых размеров. От клиента ожидается от 51 до 90 байт (цифры не точные), а от сервера — от 20 до 30 (тоже не точные).</p>
<p>Также во внимание принимается pacing пакетов. Первые два байта, судя по всему, должны быть без первого бита у двух первых байт, чтобы блокировка срабатывала.</p></td><td>2024-04-26T22:53:31.447Z</td></tr><tr><td>Angry_Agent(Angry Agent)</td><td><p>У себя в регионе заметил, что фильтр будто бы смягчили, перестало блокироваться бессмысленное содержимое, теперь блокировка воспроизводится только вот этим:</p>
<aside class="quote no-group" data-username="Angry_Agent" data-post="1" data-topic="7681">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/angry_agent/48/4030_2.png" class="avatar"> Angry_Agent:</div>
<blockquote>
<p>Запускаем на сервере netcat:</p>
<pre><code class="lang-auto">ncat -klu 7777 -v --sh-exec "echo -n 'Assets/_Scenes/Facility.unity'"
</code></pre>
<p>Со стороны клиента отправляем 5 пакетов с определённым содержимым с помощью nping:</p>
<p><code>nping --udp --data "0c0d0002000002010000000000000000200001000002755f29266a7071400fcba206000003000500070009001000039f8f00140000755f29266a7071400a7f81755f29266a707140" -c 5 -g 25591 -p 7777 X.X.X.X</code></p>
</blockquote>
</aside>
<p>На сервера в игре теперь нормально впускает.</p></td><td>2024-04-28T11:57:21.464Z</td></tr>
    </table>
      </body>
    </html>