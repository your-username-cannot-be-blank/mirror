
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>отключение-интернета-в-мары-туркменистан-апрель-май-2020</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>ValdikSS</td><td><p>Вечером 27 апреля 2020 года в Лебапской и Марыйской областях Туркменистана прошел сильный ураган с ливнем, поваливший деревья, снесший крыши домов и затопивший различные постройки. За прошедшую неделю власти Туркменистана умалчивали инцидент, не сообщая о нём в официальных СМИ.<br>
<strong>Жилетям Марыйской, Чарджовской, Дашовуской областей отключили доступ в интернет 28 апреля 2020 года</strong>, на следующий день после урагана, после появления фото- и видеокадров с мест событий.</p>
<p>Сайт <a href="https://www.hronikatm.com/2020/05/hrw-on-hurricane/">hronikatm.com</a> сообщает следующее:</p>
<blockquote>
<p>Организация напоминает, что в стране нет свободы СМИ – государственные СМИ доминируют, а власти блокируют большинство независимых и западных масс-медиа.</p>
<p>Власти пытались помешать жителям обнародовать визуальные документы, документирующие разрушение урагана. Базирующейся в Праге правозащитной группе «Права и свободы туркменских граждан» удалось поговорить с женщиной, которую МНБ задерживали в течение двух дней вместе с 29 другими, обвинив их в отправке видео «за границу». По этой же причине МНБ задержали еще 19 женщин в Туркменабате, освободив их 3 мая. «Туркменская инициатива по правам человека» (ТИПЧ) заявила, что полиция наблюдает за людьми в автомобилях, снимающими повреждения на свои мобильные телефоны.</p>
<p>Цензура и усилия туркменских властей по предотвращению обнародования информации о нанесенном ущербе затрудняют его точную оценку. Радио «Свобода» заявило о 30 погибших. Turkmen news говорили с медицинским чиновником, который рассказал о 300 погибших в Туркменабате. Большинство зданий в городе повреждены. Небольшие города также сильно повреждены ветрами и наводнениями. Распространяется видео с домами без крыш и серьезными повреждениями внутри.</p>
</blockquote>
<p><strong>Мне довелось получить интернет-канал с доступом извне Туркменистана, и протестировать доступность в условиях интернет-шатдауна в г. Мары.</strong> Провайдер — КЭ “Туркментелеком” (TMTelecom), домашнее проводное подключение через ADSL.<br>
Туркменистанец, предоставивший интернет-канал, сообщает, что недоступность сайтов наблюдается в 3 регионах страны, на проводном и мобильном интернете, из чего я делаю вывод о намеренном отключении интернета правительством. Мне не удалось обнаружить никаких публичных заметок об этом где-либо в интернете, в т.ч. на сайтах, специализирующихся на новостях из Туркменистана.</p>
<p>Кратко: техническая IP-связность с другими странами сохраняется, но доступ до фактически всех интернет-сайтов и сервисов заблокирован с помощью системы DPI. Сайты не открываются, приложения не работают.</p>
<h3><a name="dns-1" class="anchor" href="#dns-1"></a>DNS</h3>
<p>Работа DNS, по сравнению с обычной ситуацией в Туркменистане, не изменилась: популярные сторонние публичные DNS-резолверы частично недоступны, из-за блокировки диапазонов крупных хостинг-провайдеров в интернет-компаний по IP-диапазонам (типичная ситуация для Туркменистана, а не особенность этой недели).</p>
<p>Не работают: 1.1.1.1, 8.8.8.8, 9.9.9.9<br>
Работают: 77.88.8.8, 193.17.47.1, 185.43.135.1</p>
<p>Запросы IP-адресов некоторых доменов подвергаются DNS-спуфингу, причем на любом IP-адресе и UDP-порту.<br>
Например, запрос <a href="http://rutracker.org">rutracker.org</a> через 77.88.8.8 возвращает 127.0.0.1:</p>
<pre><code class="lang-auto"># host rutracker.org 77.88.8.8
Using domain server:
Name: 77.88.8.8
Address: 77.88.8.8#53
Aliases: 

rutracker.org has address 127.0.0.1
rutracker.org has address 127.0.0.1
rutracker.org has address 127.0.0.1
</code></pre>
<p>Аналогичная ситуация происходит при попытке запроса этого домена через порт 1253 — малоизвестный недокументированный порт, на котором работает Яндекс.DNS 77.88.8.8</p>
<h3><a name="http-https-2" class="anchor" href="#http-https-2"></a>HTTP и HTTPS</h3>
<p>В условиях интернет-шатдауна сайт может быть более-менее доступен по HTTP, но не по HTTPS, и наоборот (!).<br>
При попытке открыть сайт, соединение либо не принимается (словно нет сетевой связности, не приходит ответ на TCP SYN), либо принимается, но разрывается или «застывает» (перестают приходить ответные TCP ACK и любые другие пакеты).<br>
Задержка между приёмом соединения и началом передачи данных может достигать 10-12 секунд. Вероятно, это вызвано проверками соединения системой DPI.<br>
Порты 55, 88, 89, 1080, 3128 заблокированы (это типичная ситуация), соединение к ним всегда сбрасывается (TCP RST), независимо от IP-адреса назначения. Некоторые (высокие) порты временами перестают работать, закономерность не выявлена.</p>
<p><strong>Не работают</strong> (могут периодически хоть как-то отвечать, в частности, по нешифрованному HTTP, но до конца точно никогда не открываются):</p>
<ul>
<li><a href="http://mail.ru">mail.ru</a></li>
<li><a href="http://yandex.ru">yandex.ru</a></li>
<li><a href="http://microsoft.com">microsoft.com</a></li>
<li><a href="http://habr.com">habr.com</a></li>
<li><a href="http://gmail.com">gmail.com</a></li>
<li><a href="http://github.com">github.com</a></li>
<li><a href="http://mozilla.org">mozilla.org</a></li>
<li><a href="http://wikipedia.org">wikipedia.org</a></li>
<li><a href="http://bing.com">bing.com</a></li>
<li><a href="http://rambler.ru">rambler.ru</a></li>
<li><a href="http://yahoo.com">yahoo.com</a></li>
<li><a href="http://icanhazip.com">icanhazip.com</a></li>
<li><a href="http://icloud.com">icloud.com</a></li>
<li><a href="http://apple.com">apple.com</a></li>
<li><a href="http://rambler.ru">rambler.ru</a></li>
<li><a href="http://click.alfabank.ru">click.alfabank.ru</a></li>
<li><a href="http://online.vtb.ru">online.vtb.ru</a></li>
<li><a href="http://msftncsi.com">msftncsi.com</a> (домен для проверки доступности интернет-соединения в Windows)</li>
<li><a href="http://connectivitycheck.gstatic.com">connectivitycheck.gstatic.com</a> (домен для проверки доступности интернет-соединения в Android)</li>
</ul>
<p><strong>Работают</strong>:</p>
<ul>
<li><a href="http://google.com">google.com</a> (фактически единственный <em>домен</em>, более-менее нормально работающий по HTTPS, который удалось обнаружить, при этом поддомены и другие сервисы вроде gmail не работают)</li>
<li>online.tm и telecom.tm (сайты провайдера)</li>
</ul>
<p>Пример неработающего сайта gismeteo. Запрос по HTTP принимается, но соединение разрывается:</p>
<pre><code class="lang-auto">* Connected to www.gismeteo.ru (185.134.203.108) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: www.gismeteo.ru
&gt; User-Agent: curl/7.64.0
&gt; Accept: */*
&gt; 
* Empty reply from server
* Connection #0 to host www.gismeteo.ru left intact
curl: (52) Empty reply from server
</code></pre>
<p>По HTTPS:</p>
<pre><code class="lang-auto">*   Trying 185.134.202.21...
* TCP_NODELAY set
* Connected to www.gismeteo.ru (185.134.202.21) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: none
  CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
</code></pre>
<p>И так до бесконечности, пакеты перестают ходить.</p>
<p>Пример соединения с yandex. Соединение по HTTP принимается, но ответа не поступает, и соединение «зависает». Я подделал заголовки на браузерные, чтобы исключить фильтрацию curl:</p>
<pre><code class="lang-auto">* Connected to yandex.ru (77.88.55.55) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: yandex.ru
&gt; Accept-Encoding: deflate, gzip
&gt; User-Agent: Mozilla/5.0 (X11; Fedora; Linux x86_64; rv:75.0) Gecko/20100101 Firefox/75.0
&gt; Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
&gt; Accept-Language: ru,en;q=0.7,en-US;q=0.3
&gt; DNT: 1
&gt; Connection: keep-alive
&gt; Upgrade-Insecure-Requests: 1
&gt; Pragma: no-cache
&gt; Cache-Control: no-cache
&gt;
</code></pre>
<p>Попытка открыть <a href="http://mail.yandex.ru">mail.yandex.ru</a> по HTTPS:</p>
<pre><code class="lang-auto">*   Trying 77.88.21.37...
* TCP_NODELAY set
* Connected to mail.yandex.ru (77.88.21.37) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: none
  CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
</code></pre>
<p>Аналогично, последующих ответов от сервера не поступает.</p>
<h3><a name="h-3" class="anchor" href="#h-3"></a>Другие протоколы</h3>
<p>Ситуация с другими протоколами в целом аналогична HTTP/HTTPS. Хост может хоть как-то быть доступен по HTTP (TCP port 80), но по SSH к нему подключиться не получится: произойдет либо разрыв соединения, либо «зависание».</p>
<pre><code class="lang-auto">root@debian-tm:~# ssh example.com -vvv
OpenSSH_7.9p1 Debian-10+deb10u2, OpenSSL 1.1.1d  10 Sep 2019
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: /etc/ssh/ssh_config line 19: Applying options for *
debug2: resolve_canonicalize: hostname example.com is address
debug2: ssh_connect_direct
debug1: Connecting to example.com [1.2.3.4] port 22.
debug1: connect to address 1.2.3.4 port 22: Connection refused
ssh: connect to host 1.2.3.4 port 22: Connection refused
</code></pre>
<p><strong>UDP</strong> позволяет передавать трафик от 7 до 10 секунд, после чего пакеты перестают отправляться в обе стороны на этой связке клиентского и серверного UDP-портов. За 10 секунд можно успеть передать около 200 КБ данных. Предположительно, блокировка сделана именно так, чтобы оставить работоспособными DNS, NTP и другой важный UDP-трафик.</p>
<p><strong>ICMP-пакеты</strong> заблокированы в целом для хостов вне страны, доставляется только (условно) первый запрос и ответ (любого ICMP-типа), вероятно, чтобы не применяли ICMP-туннели. Из-за этого ICMP Echo Request/Echo Reply (более известен как ping) удается получить максимум один в несколько десятков секунд (когда система «забудет» о первом отправленном пакете). Сайт провайдера при этом «пингуется» нормально.</p>
<p>По <strong>TCP</strong> в общем чаще всего соединение устанавливается нормально, но передаётся или принимается только первый килобайт трафика после установки соединения, после чего пакеты перестают ходить в обе стороны (что и вызывает «зависание» соединения на разных протоколах). Проблема не вызывана MTU: я уменьшал TCP MSS до низких значений, и удостоверивался, что даже маленькие пакеты (&lt;400 байт) перестают передаваться.<br>
Предполагаю, что так работает DPI: происходит анализ до 1 КБ ответного трафика от сервера, из которого система принимает решение о разрешении или блокировании запроса.<br>
Для подтверждения этого предположения я сделал перенаправление трафика с моего сервера в интернете на <a href="http://www.google.com">www.google.com</a> на порту 443, и подключился к IP сервера так, словно это Google, по HTTPS — это сработало, трафик нормально ходил в обе стороны, соединение не переставало работать после 1 КБ переданных или полученных данных. По всей видимости, DPI в этом килобайте ожидает X.509 (HTTPS)-сертификат доверенного сайта (<a href="http://www.google.com">www.google.com</a> в данном случае).<br>
Я пробовал подделывать сертификат Google путём создания его точной копии (с такими же полями), но, похоже, проверяется всё тело сертификата целиком, а не только заголовки.</p>
<h3><a name="h-4" class="anchor" href="#h-4"></a>Способы получения интернета в условиях его отключения</h3>
<p>Несмотря на отключения интернета правительством и неработоспособность сайтов, в регионе всё ещё технически сохраняется IP-связность с внешним интернетом.</p>
<p>Есть, по меньшей мере, два рабочих способа получения интернета на предоставленном мне канале:</p>
<ul>
<li>Так как сохраняется доступ по крайней мере на один сайт (<a href="http://www.google.com">www.google.com</a>), а проверка сайта осуществляется по домену и сертификату, но не IP-адресу, то можно воспользоваться программой <a href="https://ntc.party/t/about-the-cloak-category/76">Cloak</a> от <a class="mention" href="/u/antikythera">@antikythera</a>, для создания туннеля, замаскированного под сайт Google.</li>
<li>Из-за сохранения стабильной работы DNS, можно, в качестве крайней меры, организовать DNS-туннель программой <a href="https://code.kryo.se/iodine/">iodine</a> или <a href="https://www.bamsoftware.com/software/dnstt/">dnstt</a>: он медленный и не самый стабильный в силу своей специфики, но для соединения к серверу по SSH достаточен.</li>
<li>TCP-пакеты SYN и SYN-ACK (начало соединения и ответ на начало соединения) продолжают доставляться в целом стабильно, можно организовать туннель на их основе. Готовые программы мне для этого неизвестны, но, вероятно, можно адаптировать <a href="https://github.com/wangyu-/udp2raw-tunnel">udp2raw</a>.</li>
</ul>
<h3><a name="h-5" class="anchor" href="#h-5"></a>Выводы</h3>
<p>В условиях интернет-шатдауна, вызванного действиями внутри страны, а не неисправностями транзитных каналов, всё равно можно найти способы получения доступа в интернет, но для этого нужно обладать глубокими знаниями в сетевых технологиях, набором программ и пониманием принципов их работы, а также заранее заготовленным сервером вне страны.</p>
<p>Самым надёжным <em>резервным</em> способом связи с зарубежным сервером остаётся, по моему мнению, DNS-туннель — работоспособность DNS, с большой вероятностью, будет поддерживаться провайдерами дольше всего, а значит, можно воспользоваться заранее настроенным DNS-туннелем для дальнейшей настройки зарубежного сервера в условиях отсутствия полноценной сетевой связности.</p></td><td>2020-05-05T21:02:20.652Z</td></tr><tr><td>tango</td><td><p><a class="mention" href="/u/valdikss">@ValdikSS</a>’s post was too long for the forum’s auto-translation. Here is the text translated using <a href="https://www.deepl.com/translator" class="inline-onebox">DeepL Translate: The world's most accurate translator</a>.</p>
<hr>
<h1><a name="internet-blackout-in-mary-turkmenistan-april-may-2020-1" class="anchor" href="#internet-blackout-in-mary-turkmenistan-april-may-2020-1"></a>Internet blackout in Mary, Turkmenistan, April-May 2020</h1>
<p>In the evening of April 27, 2020, a strong hurricane with heavy downpours took place in Lebap and Mary regions of Turkmenistan, which fell trees, demolished roofs of houses and flooded various buildings. Over the past week, the authorities of Turkmenistan kept silent about the incident without reporting it to the official media.<br>
<strong>Residents of Mary, Chardzhou, and Daşoguz Oblasts were disconnected from the Internet on April 28, 2020</strong>, the day after the storm, after photos and video footage from the scene appeared.</p>
<p>The website <a href="https://www.hronikatm.com/2020/05/hrw-on-hurricane/">hronikatm.com</a> reports the following:</p>
<blockquote>
<p>The organization reminds that there is no freedom of media in the country - state media are dominant, while the authorities block most independent and Western media.</p>
<p>The authorities have tried to prevent residents from publishing visual documents documenting the destruction of the hurricane. Prague-based human rights group “Rights and Freedoms of Turkmen Citizens” managed to talk to a woman who was detained by MNB for two days along with 29 others, accusing them of sending the video “abroad”. For the same reason, DHS detained 19 other women in Turkmenabat, releasing them May 3. "The Turkmen Human Rights Initiative (TIHR) said police are watching people in cars taking pictures of injuries on their mobile phones.</p>
<p>Censorship and efforts by the Turkmen authorities to prevent the damage from being made public make it difficult to accurately assess the damage. Radio Liberty reported 30 deaths. Turkmen news talked to a medical official who reported 300 deaths in Turkmenabat. Most buildings in the city have been damaged. Small towns are also heavily damaged by winds and floods. A video of houses without roofs and severely damaged inside is being distributed.</p>
</blockquote>
<p><strong>I had the opportunity to get an Internet channel with access from outside Turkmenistan, and to test availability in the conditions of an Internet shutdown in Mary.</strong> The provider is TMTelecom, a home wired connection via ADSL.<br>
The Turkmen, who provided the Internet channel, reports that the inaccessibility of sites is observed in 3 regions of the country, on wired and mobile Internet, from which I conclude that the government deliberately shut down the Internet. I have not been able to find any public notes about it anywhere on the Internet, including sites specializing in news from Turkmenistan.</p>
<p>Briefly: technical IP connection with other countries is preserved, but access to virtually all Internet sites and services is blocked using DPI system. Sites are not opened, applications do not work.</p>
<h3><a name="dns-2" class="anchor" href="#dns-2"></a>DNS</h3>
<p>The operation of DNS, compared to the usual situation in Turkmenistan, has not changed: popular third-party public DNS resellers are partially unavailable due to blocking the ranges of large hosting providers to Internet companies over IP ranges (a typical situation for Turkmenistan, not a feature of this week).</p>
<p>Not working: 1.1.1.1, 8.8.8.8, 9.9.9.<br>
Working: 77.88.8.8, 193.17.47.1, 185.43.135.1</p>
<p>Requests for IP addresses for some domains are subject to DNS spoofing, at any IP address and UDP port.<br>
For example, the <a href="http://rutracker.org">rutracker.org</a> request returns 127.0.0.1 after 77.88.8.8:</p>
<pre><code class="lang-auto"># host rutracker.org 77.88.8.8
Using domain server:
Name: 77.88.8.8
Address: 77.88.8.8#53
Aliases: 

rutracker.org has address 127.0.0.1
rutracker.org has address 127.0.0.1
rutracker.org has address 127.0.0.1
</code></pre>
<p>A similar situation occurs when attempting to query this domain on port 1253, a little-known undocumented port on which Yandex.DNS 77.88.8.8 is running.</p>
<h3><a name="http-and-https-3" class="anchor" href="#http-and-https-3"></a>HTTP and HTTPS</h3>
<p>In Internet Shutdown conditions the site can be more or less accessible via HTTP, but not via HTTPS, and vice versa (!).<br>
At attempt to open a site, connection either is not accepted (as if there is no network connection, the answer to TCP SYN does not come), or is accepted, but breaks off or “freezes” (stops coming reply TCP ACK and any other packets).<br>
There can be a delay of 10-12 seconds between receiving a connection and starting data transfer. This is probably due to the DPI connection checks.<br>
Ports 55, 88, 89, 1080, 3128 are blocked (this is a typical situation) and the connection to them is always reset (TCP RST), regardless of the destination IP address. Some (high) ports stop working at times, the pattern is not detected.</p>
<p><strong>These do not work</strong> (they may occasionally respond in some way, particularly with unencrypted HTTP, but they never open until the end):</p>
<ul>
<li><a href="http://mail.ru">mail.ru</a></li>
<li><a href="http://yandex.ru">yandex.ru</a></li>
<li><a href="http://microsoft.com">microsoft.com</a></li>
<li><a href="http://habr.com">habr.com</a></li>
<li><a href="http://gmail.com">gmail.com</a></li>
<li><a href="http://github.com">github.com</a></li>
<li><a href="http://mozilla.org">mozilla.org</a></li>
<li><a href="http://wikipedia.org">wikipedia.org</a></li>
<li><a href="http://bing.com">bing.com</a></li>
<li><a href="http://rambler.ru">rambler.ru</a></li>
<li><a href="http://yahoo.com">yahoo.com</a></li>
<li><a href="http://icanhazip.com">icanhazip.com</a></li>
<li><a href="http://icloud.com">icloud.com</a></li>
<li><a href="http://apple.com">apple.com</a></li>
<li><a href="http://rambler.ru">rambler.ru</a></li>
<li><a href="http://click.alfabank.ru">click.alfabank.ru</a></li>
<li><a href="http://online.vtb.ru">online.vtb.ru</a></li>
<li><a href="http://msftncsi.com">msftncsi.com</a> (domain to verify the availability of an Internet connection in Windows)</li>
<li><a href="http://connectivitycheck.gstatic.com">connectivitycheck.gstatic.com</a> (domain for checking the availability of an Internet connection in Android)</li>
</ul>
<p><strong>These work</strong>:</p>
<ul>
<li><a href="http://google.com">google.com</a> (actually the only domain more or less normally operating over HTTPS that has been detected, with subdomains and other services like gmail not working)</li>
<li>online.tm and telecom.tm (provider sites)</li>
</ul>
<p>An example of a gismeteo site not working. An HTTP request is accepted, but the connection is broken:</p>
<pre><code class="lang-auto">* Connected to www.gismeteo.ru (185.134.203.108) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: www.gismeteo.ru
&gt; User-Agent: curl/7.64.0
&gt; Accept: */*
&gt;
* Empty reply from server
* Connection #0 to host www.gismeteo.ru left intact
curl: (52) Empty reply from server
</code></pre>
<p>Over HTTPS:</p>
<pre><code class="lang-auto">*   Trying 185.134.202.21...
* TCP_NODELAY set
* Connected to www.gismeteo.ru (185.134.202.21) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: none
  CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
</code></pre>
<p>And so to infinity, the packets stop moving.</p>
<p>Example of a yandex connection. An HTTP connection is accepted, but no response is received, and the connection “hangs”. I forged the headers on the browser to exclude curl filtering:</p>
<pre><code class="lang-auto">* Connected to yandex.ru (77.88.55.55) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: yandex.ru
&gt; Accept-Encoding: deflate, gzip
&gt; User-Agent: Mozilla/5.0 (X11; Fedora; Linux x86_64; rv:75.0) Gecko/20100101 Firefox/75.0
&gt; Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
&gt; Accept-Language: ru,en;q=0.7,en-US;q=0.3
&gt; DNT: 1
&gt; Connection: keep-alive
&gt; Upgrade-Insecure-Requests: 1
&gt; Pragma: no-cache
&gt; Cache-Control: no-cache
&gt;
</code></pre>
<p>Attempt to open <a href="http://mail.yandex.ru">mail.yandex.ru</a> via HTTPS:</p>
<pre><code class="lang-auto">*   Trying 77.88.21.37...
* TCP_NODELAY set
* Connected to mail.yandex.ru (77.88.21.37) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: none
  CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
</code></pre>
<p>Similarly, no further responses are received from the server.</p>
<h3><a name="other-protocols-4" class="anchor" href="#other-protocols-4"></a>Other protocols</h3>
<p>The situation with other protocols is generally similar to HTTP/HTTPS. The host can somehow be accessed via HTTP (TCP port 80), but it will not be possible to connect to it via SSH: either the connection will be broken or “hanging”.</p>
<pre><code class="lang-auto">root@debian-tm:~# ssh example.com -vvv
OpenSSH_7.9p1 Debian-10+deb10u2, OpenSSL 1.1.1d  10 Sep 2019
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: /etc/ssh/ssh_config line 19: Applying options for *
debug2: resolve_canonicalize: hostname example.com is address
debug2: ssh_connect_direct
debug1: Connecting to example.com [1.2.3.4] port 22.
debug1: connect to address 1.2.3.4 port 22: Connection refused
ssh: connect to host 1.2.3.4 port 22: Connection refused
</code></pre>
<p><strong>UDP</strong> allows traffic from 7 to 10 seconds, after which the packets are no longer sent both ways on this bundle of client and server UDP ports. About 200 KB of data can be transmitted in 10 seconds. Presumably, the blocking is designed to leave DNS, NTP and other important UDP traffic running.</p>
<p><strong>ICMP packets</strong> are generally blocked for hosts outside the country, only the (conditionally) first request and response (of any ICMP type) is delivered, probably to avoid ICMP tunnels. Because of this, ICMP Echo Request/Echo Reply (better known as ping) manages to get a maximum of one in a few tens of seconds (when the system “forgets” the first packet sent). The provider’s site is normally “pinged” in this case.</p>
<p>On <strong>TCP</strong> in general most often connection is established normally, but only the first kilobyte of the traffic after connection establishment is transferred or accepted, then packets stop to go in both parties (that causes “hanging” of connection on different protocols). The problem is not caused by MTU: I reduced TCP MSS to low values and made sure that even small packets (&lt;400 bytes) stop transmitting.<br>
I assume that this is how DPI works: up to 1 KB of response traffic from the server is analyzed and the system decides whether to allow or block the request.<br>
To confirm this assumption, I redirected traffic from my server on the Internet to <a href="http://www.google.com">www.google.com</a> on port 443, and connected to the IP server as if it were Google, over HTTPS - it worked, the traffic went both ways normally, the connection did not stop working after 1 KB of transmitted or received data. Apparently, the DPI in this kilobyte expects an X.509 (HTTPS) certificate from a trusted site (<a href="http://www.google.com">www.google.com</a> in this case).<br>
I tried to tamper with the Google certificate by making an exact copy of it (with the same fields), but it looks like the entire body of the certificate is being checked, not just the headers.</p>
<h3><a name="how-to-get-the-internet-when-its-turned-off-5" class="anchor" href="#how-to-get-the-internet-when-its-turned-off-5"></a>How to get the Internet when it’s turned off</h3>
<p>Despite the government’s disconnection of the Internet and the inoperability of sites, the region still technically maintains IP connectivity to the external Internet.</p>
<p>There are at least two working ways to get the Internet on the channel provided to me:</p>
<ul>
<li>Since at least one site (<a href="http://www.google.com">www.google.com</a>) is still accessible and the site is checked by domain and certificate, but not IP address, you can use <a href="https://ntc.party/t/about-the-cloak-category/76">Cloak</a> from <a class="mention" href="/u/antikythera">@antikythera</a> to create a tunnel disguised as a Google site.</li>
<li>Due to the stability of DNS, you can, as a last resort, organize a DNS-tunnel program <a href="https://code.kryo.se/iodine/">iodine</a>: it is slow and unstable due to its specifics, but enough to connect to the server via SSH.</li>
<li>TCP packets SYN and SYN-ACK (start of connection and start response) continue to be delivered generally stable, you can organize a tunnel based on them. I don’t know the ready-made programs for this, but it is probably possible to adapt <a href="https://github.com/wangyu-/udp2raw-tunnel">udp2raw</a>.</li>
</ul>
<h3><a name="conclusions-6" class="anchor" href="#conclusions-6"></a>Conclusions</h3>
<p>In conditions of the Internet shutdown caused by actions inside the country, instead of malfunctions of transit channels, it is still possible to find ways of access to the Internet, but for this purpose it is necessary to possess profound knowledge in network technologies, a set of programs and understanding of principles of their work, and also in advance prepared server out of the country.</p>
<p>The most reliable backup method of communication with a foreign server is, in my opinion, the DNS-tunnel - the performance of DNS, with a high probability, will be supported by providers for the longest time, and therefore, you can use a pre-configured DNS-tunnel for further configuration of the foreign server in the absence of full network connectivity.</p></td><td>2020-05-05T21:44:06.966Z</td></tr><tr><td>tango</td><td><aside class="quote no-group quote-modified" data-username="ValdikSS" data-post="1" data-topic="475">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/valdikss/48/2_2.png" class="avatar"> ValdikSS:</div>
<blockquote>
<ul>
<li>Из-за сохранения стабильной работы DNS, можно, в качестве крайней меры, организовать DNS-туннель программой <a href="https://code.kryo.se/iodine/">iodine</a>: он медленный и нестабильный в силу своей специфики, но для соединения к серверу по SSH достаточен.</li>
</ul>
<hr>
<ul>
<li>Due to the stability of DNS, you can, as a last resort, organize a DNS-tunnel program <a href="https://code.kryo.se/iodine/">iodine</a>: it is slow and unstable due to its specifics, but enough to connect to the server via SSH.</li>
</ul>
</blockquote>
</aside>
<p><a href="https://www.bamsoftware.com/software/dnstt/" class="onebox" target="_blank" rel="noopener">https://www.bamsoftware.com/software/dnstt/</a><br>
<a href="https://github.com/net4people/bbs/issues/30">https://github.com/net4people/bbs/issues/30</a></p>
<p>Recently I published this new DNS tunnel. It has not had much testing yet, but I believe it can have <a href="https://www.bamsoftware.com/software/dnstt/performance.html">better performance</a> than iodine. I wrote the tunnel to take advantage of the possibilities of DNS over HTTP and DNS over TLS, but it can also run in plaintext UDP mode. (Obviously it is in principle easily detectable in UDP mode.)</p>
<p>Unfortunately it’s still a new project and you have to be somewhat technical to use it. It doesn’t provide a TUN interface like iodine does, nor even SOCKS; you have to run your own SOCKS proxy on the server if you want the tunnel to work as a proxy. The code is public domain so you are free to adapt it according to requirements, and I’m open to suggestions and willing to help.</p></td><td>2020-05-05T22:00:10.634Z</td></tr><tr><td>ValdikSS</td><td><p>By the readme, I assume dnstt could use only DoH, DoT or direct UDP mode, and not a regular DNS? If this is the case, it won’t work in Turkmenistan shutdown conditions because UDP traffic is also blocked after several seconds. It would probably work only for several seconds and then hang, requiring to reconnect/change client’s UDP port.</p></td><td>2020-05-05T22:25:30.486Z</td></tr><tr><td>tango</td><td><p>I don’t know what you mean by regular DNS. dnstt uses normal DNS messages and ordinary public DNS recursive resolvers. The recursive resolver can be DoH, DoT, or classical UDP DNS. There’s also a mode where the tunnel client communicates directly with the tunnel server, but that mode is only for debugging and performance comparisons. If all UDP associations are blocked after a few seconds, then it seems iodine would not work either, because it relies on repeated UDP packets to the same resolver address as well.</p>
<p>For some resolvers you may have to reduce the DNS response size on the server with <code>-mtu 512</code>, but other than that it should work with any recursive resolver, whether an ISP resolver or a public one like Google DNS. However it has not been tested in many environments and it’s possible there are compatibility bugs.</p></td><td>2020-05-05T22:37:24.411Z</td></tr><tr><td>ValdikSS</td><td><aside class="quote no-group" data-username="tango" data-post="5" data-topic="475">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/t/e36b37/48.png" class="avatar"> tango:</div>
<blockquote>
<p>dnstt uses normal DNS messages and ordinary public DNS recursive resolvers. The recursive resolver can be DoH, DoT, or classical UDP DNS.</p>
</blockquote>
</aside>
<p>I see, that wasn’t clear from the readme. I assumed that it works only over DoH, DoT and using custom protocol over UDP with direct connection to the server (without using DNS at all).</p>
<aside class="quote no-group" data-username="tango" data-post="5" data-topic="475">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/t/e36b37/48.png" class="avatar"> tango:</div>
<blockquote>
<p>If all UDP associations are blocked after a few seconds, then it seems iodine would not work either, because it relies on repeated UDP packets to the same resolver address as well.</p>
</blockquote>
</aside>
<p>It would, but not in direct mode. Iodine has two modes of operation: DNS requests/replies over any available DNS resolver, and direct mode with direct UDP connection to the server. I assume only the former would work in this conditions.</p></td><td>2020-05-05T22:46:17.279Z</td></tr><tr><td>tango</td><td><aside class="quote no-group" data-username="ValdikSS" data-post="6" data-topic="475">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/valdikss/48/2_2.png" class="avatar"> ValdikSS:</div>
<blockquote>
<p>I see, that wasn’t clear from the readme. I assumed that it works only over DoH, DoT and using custom protocol over UDP with direct connection to the server (without using DNS at all).</p>
</blockquote>
</aside>
<p>I see. Thank you for the comment. I will look at the documentation and perhaps make some changes. I wanted to de-emphasize the UDP DNS support because it’s not covert like DoH and DoT are; classical DNS tunnels are easy to detect and block (including iodine). But I mention it in this case because the situation sounds extreme and there may be some short-term usefulness even in the UDP mode. Anyway I apologize, I did not mean to hijack the topic.</p></td><td>2020-05-05T23:18:45.794Z</td></tr><tr><td>thebadgateway</td><td><p>Спасибо за статью, очень познавательно, особенно когда дал на днях знакомому в Туркменистане свой сервер V2ray и ему хватило им пользоваться пару минут в лучшем случае.</p></td><td>2020-05-06T03:24:39.777Z</td></tr><tr><td>ValdikSS</td><td><p>Протестировал dnstt от <a class="mention" href="/u/tango">@tango</a> в Туркменистане — работает стабильно и быстро при прямом UDP-соединении с сервером. UDP-соединение не «зависает» — видимо, блокировки DPI не применяются для DNS-трафика.</p></td><td>2020-05-06T15:13:43.664Z</td></tr><tr><td>thebadgateway</td><td><p>Глянул мельком на страницу про dnstt. Я так понимаю клиент там только один и под смартфоны не кто не писал его?</p></td><td>2020-05-07T02:28:28.411Z</td></tr><tr><td>ValdikSS</td><td><p>Забыл написать, что доступ к <a href="http://www.google.com">www.google.com</a> перестал работать через несколько часов после публикации первого сообщения, хотя до этого работал двое суток без перебоев.</p>
<p>Когда начал анализировать ситуацию, вспомнил, что при соединении к <a href="http://www.google.com">www.google.com</a> используется TLS v1.3, в котором шифруется серверный сертификат, поэтому DPI не мог анализировать именно сертификат в ответе сервера. Почему и как это работало раньше — непонятно, вероятно, в DPI были сделаны какие-то исключения для определенных размеров ответных пакетов (?).</p></td><td>2020-05-07T10:46:00.096Z</td></tr><tr><td>bolvan</td><td><p>Не пробовал нестандартные IP протоколы ?</p></td><td>2020-05-09T18:52:44.980Z</td></tr><tr><td>ValdikSS</td><td><p>Пробовал отправлять пустые пакеты со всеми возможными идентификаторами протоколов — ничего не доходило (но это могло быть из-за NAT роутера и из-за Virtualbox, но в Virtualbox был bridge).</p></td><td>2020-05-09T19:03:59.229Z</td></tr><tr><td>0ka(0ka)</td><td><p>Кажется, блокировки стали менее жесткими в этом году?</p></td><td>2021-05-26T07:38:14.538Z</td></tr><tr><td>VasilyGrigoriev378(Василий Григорьев)</td><td><p>Как обойти блокировки в Туркменистане просто все впн сдохли не пашут блочат их. Типа Goodbye DPI есть такой же инструмент для Туркменов?</p></td><td>2021-06-10T19:19:31.492Z</td></tr><tr><td>0ka(0ka)</td><td><p>Да заглохли щас блоки, глянь <a href="https://4pda.to/forum/index.php?showtopic=1009120&amp;view=findpost&amp;p=106794738" rel="noopener nofollow ugc">https://4pda.to/forum/index.php?showtopic=1009120&amp;view=findpost&amp;p=106794738</a><br>
Твой ник немного напугал меня т.к. в whois айпишников ТМ написан Alex Grigoriev)</p></td><td>2021-06-11T00:47:28.562Z</td></tr>
    </table>
      </body>
    </html>