
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>antizapret-pihole-1652</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>kamlipoltu</td><td><p>Привет. Поднял сервер антизапрета на VPS сервере все работает на ура. Захотел прикрутить к нему PiHole для блокировки рекламы. Да, звучит эпично. Прикрутить к средству обходящему блокировки новый блокировщик. В общем идея такая:</p>
<p>На микротике создается соединение до своего сервера антизапрета и используется DNS сервер от антизапрета. Результаты запроса кешируются на микротике. Все DNS запросы клиентов идут на микротик, а от микротика идет DNS запрос серверу антизапрета. Тут уже два варианта ответа от антизапрета:<br>
a) если сайт из списка заблокированных то возвращается внутренний адрес антизапрета по которому блокировка обходится<br>
б) если сайт не заблокирован, шлется DNS запрос на pihole и ответ который вернул pihole возвращается клиенту, т.е микротику.</p>
<p>Цель всей этой затеи обходить блокировку и блокировать рекламу. Чую что такое можно реализовать, только так и не разобрался куда антизапрет шлет dns запросы и где это прописано. Если я правильно понимаю, мне будет достаточно указать в контейнере антизапрета в качестве DNS сервера адрес pihole. Но если указать адрес pihole в /etc/resolv.conf в файле контейнера то это ничего не дает. Антизапрет возвращает не ответ от pihole, а настоящий адрес ресурса.</p>
<p>Подскажите пожалуйста, в каком файле контейнера нужно указать адрес pihole чтоб контейнер обращался исключительно к pihole и возможно ли вообще реализовать вышеописанное?</p></td><td>2022-01-23T02:36:30.646Z</td></tr><tr><td>nzkhammatov(Ainur Khammatov)</td><td><aside class="quote" data-post="40" data-topic="129">
  <div class="title">
    <div class="quote-controls"></div>
    <img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/valdikss/48/2_2.png" class="avatar">
    <a href="https://ntc.party/t/vpn/129/40">Контейнер VPN АнтиЗапрета для установки на собственный сервер</a> <a class="badge-category__wrapper " href="/c/antizapret-prostovpn-org/az-self-hosted/38"><span data-category-id="38" style="--category-badge-color: #0088CC; --category-badge-text-color: #FFFFFF; --parent-category-badge-color: #8C6238;" data-parent-category-id="5" data-drop-close="true" class="badge-category --has-parent" title="Вопросы и особенности работы контейнера VPN АнтиЗапрета на своих серверах"><span class="badge-category__name">АнтиЗапрет на собственном сервере (self-hosted)</span></span></a>
  </div>
  <blockquote>
    Полагаю, что можно. В файл /etc/knot-resolver/kresd.conf, в самый конец добавьте следующую строку: 
policy.add(policy.all(policy.FORWARD({'192.0.2.1'})))

Где 192.0.2.1 — IP-адрес DNS-сервера AdGuard. Контейнер с VPN антизапрета должен иметь доступ до этого IP-адреса.
  </blockquote>
</aside>
</td><td>2022-01-23T06:24:45.894Z</td></tr><tr><td>kamlipoltu</td><td><p>Спасибо большое за помощь! Все работает!</p></td><td>2022-01-23T10:37:25.118Z</td></tr><tr><td>Gumko</td><td><p>Подскажите по объединению Antizapret (openwrt (openvpn)) + PiHole. Сейчас роутер openwrt подключается к Антизапрету через openvpn на роутере. Чтобы работал Антизапрет в конфигурации OVPN добавлены строки DNS серверов.<br>
route 8.8.8.8 255.255.255.255<br>
route 77.88.8.8 255.255.255.255<br>
Имеется домашний сервер с поднятым PiHole. На роутере openwrt указываю DNS сервером PiHole, чтобы пошла блокировка рекламы, в конфигурации OVPN указываю адрес route Сервера PiHole, соответственно Антизапрет работает, а PiHole больше ничего не блокирует.<br>
Как сделать чтобы и Антизапрет работал и PiHole блокировал?</p></td><td>2023-09-06T17:15:48.876Z</td></tr><tr><td>dartraiden(Alexander Gavrilov)</td><td><p>Логично, вы сами же указали в конфиге OVPN создавать маршрут до Pi-hole через туннель. Клиенты пытаются использовать Pi-hole, трафик вместо того, чтобы идти к Pi-hole в локалке, улетает в туннель, там его перехватывает DNS Antizapret, а Pi-hole остаётся не у дел.</p>
<p>C Pi-hole не сталкивался, но по аналогии с AdGuard Home:</p>
<ul>
<li>на роутере в качестве DNS указываете локальный адрес Pi-hole</li>
<li>в Pi-hole в качестве апстрима указываете 8.8.8.8 и 77.88.8.8</li>
<li>в конфиге OVPN соответственно эти же адреса</li>
</ul>
<p>Таким образом, клиенты обращаются с DNS-запросами к роутеру, тот к Pi-hole, Pi-hole в качестве апстрима обращается к 8.8.8.8 и 77.88.8.8, трафик до которых (благодаря созданным с помощью конфига маршрутам) улетает в туннель, где его перехватывает DNS Antizapret.</p>
<p>Просто нужно себе представить, как идёт трафик, и сразу станет понятно, кто на каком месте в этой цепочке (клиенты → роутер → Pi-hole → Antizapret) должен стоять.</p></td><td>2023-09-08T22:45:46.666Z</td></tr><tr><td>Grib(Алекс)</td><td><p>Как в шапке этой темы про <a href="https://ntc.party/t/%D0%BE%D0%B1%D1%85%D0%BE%D0%B4-%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8-%D0%BD%D0%B0-mikrotik/666?page=7">Обход блокировки на mikrotik</a> настроил микротик на антизапрет.<br>
Всё хорошо, громадное спасибо.</p>
<p>Но далее возникла мысль ещё улучшить и поставить на микротик ADGuard Home, что собственно и было сделано.<br>
Установил контейнер с ADG и он как бы даже заработал. Но и не заработал. Получается либо доступ к нужным сайтам либо блокировка рекламы.</p>
<p>В теме про антизапрет явно указано, что<br>
IP - DNS settings должно быть только с Dynamics Servers полученным при OVPN. Так и есть.<br>
далее IP - DHCP Server - Networks - DNS Servers поле пустое.</p>
<p>Антизапрет работает и логично, что весь трафик идёт минуя ADG.<br>
И как только в IP - DHCP Server - Networks - DNS Servers прописываешь 172.17.0.2 (это адрес ADG)<br>
то счётчики ADG начинают работать, но пропадает доступ к нужным сайтам.</p>
<p>Собственно подскажите, что и где правильно прописать в микротике, чтобы всё работало в связке. ADG+антизапрет.</p>
<p>Я читал читал, но так и не понял. Понял, что вроде как надо в IP - Firewall - NAT как-то что-то прописать…<br>
Микрот с прошивкой 7.15.1</p></td><td>2024-07-03T19:35:04.731Z</td></tr>
    </table>
      </body>
    </html>