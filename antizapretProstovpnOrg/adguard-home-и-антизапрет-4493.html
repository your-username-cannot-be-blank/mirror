
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>adguard-home-и-антизапрет-4493</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>Mr.Alex</td><td><p>Установил на собственный сервер АнтиЗапрет и Adguard Home и когда прописываю в upstream dns адресс сервера или выбираю из списка провайдеров, то реклама так и не блокируется</p></td><td>2023-05-11T16:28:04.519Z</td></tr><tr><td>nzkhammatov(Ainur Khammatov)</td><td><aside class="quote" data-post="40" data-topic="129">
  <div class="title">
    <div class="quote-controls"></div>
    <img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/valdikss/48/2_2.png" class="avatar">
    <a href="https://ntc.party/t/vpn/129/40">Контейнер VPN АнтиЗапрета для установки на собственный сервер</a> <a class="badge-category__wrapper " href="/c/antizapret-prostovpn-org/az-self-hosted/38"><span data-category-id="38" style="--category-badge-color: #0088CC; --category-badge-text-color: #FFFFFF; --parent-category-badge-color: #8C6238;" data-parent-category-id="5" data-drop-close="true" class="badge-category --has-parent" title="Вопросы и особенности работы контейнера VPN АнтиЗапрета на своих серверах"><span class="badge-category__name">АнтиЗапрет на собственном сервере (self-hosted)</span></span></a>
  </div>
  <blockquote>
    Полагаю, что можно. В файл /etc/knot-resolver/kresd.conf, в самый конец добавьте следующую строку: 
policy.add(policy.all(policy.FORWARD({'192.0.2.1'})))

Где 192.0.2.1 — IP-адрес DNS-сервера AdGuard. Контейнер с VPN антизапрета должен иметь доступ до этого IP-адреса.
  </blockquote>
</aside>
</td><td>2023-05-11T17:53:38.687Z</td></tr><tr><td>Mr.Alex</td><td><p><div class="lightbox-wrapper"><a class="lightbox" href="adguard-home-и-антизапрет-4493/985cf0d3e4b84942e62d03cbe1c9fc51285cbb7c.png" data-download-href="https://ntc.party/uploads/default/985cf0d3e4b84942e62d03cbe1c9fc51285cbb7c" title="Без имени"><img src="adguard-home-и-антизапрет-4493/985cf0d3e4b84942e62d03cbe1c9fc51285cbb7c_2_690x388.png" alt="Без имени" data-base62-sha1="lJRHpe1mAWuYDu5UJ96R3l6Evdq" width="690" height="388" srcset="adguard-home-и-антизапрет-4493/985cf0d3e4b84942e62d03cbe1c9fc51285cbb7c_2_690x388.png, adguard-home-и-антизапрет-4493/985cf0d3e4b84942e62d03cbe1c9fc51285cbb7c_2_1035x582.png 1.5x, adguard-home-и-антизапрет-4493/985cf0d3e4b84942e62d03cbe1c9fc51285cbb7c_2_1380x776.png 2x" data-dominant-color="131111"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Без имени</span><span class="informations">1920×1080 143 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p></td><td>2023-05-11T18:12:32.963Z</td></tr><tr><td>nzkhammatov(Ainur Khammatov)</td><td><p><em><strong>В зависимости от ситуации используйте команды для входа в контейнер</strong></em></p>
<p><strong>lxd:</strong><br>
<code>lxc exec antizapret-vpn bash</code></p>
<p><strong>systemd-machined:</strong><br>
<code>machinectl shell antizapret-vpn /bin/bash</code></p>
<p><strong>Начинайте работу попав сюда:</strong> <code>root@antizapret-vpn:~#</code></p>
<p><code>nano /etc/knot-resolver/kresd.conf</code></p></td><td>2023-05-11T20:51:03.767Z</td></tr><tr><td>Mr.Alex</td><td><p>Спасибо, не знал что нужно заходить в контейнер</p></td><td>2023-05-12T21:09:32.763Z</td></tr><tr><td>Grib(Алекс)</td><td><p>Сразу оченно извиняюсь, не сильно шарю в сетях и микротах, поэтому пишу как знаю.</p>
<p>Как в шапке этой темы про <a href="https://ntc.party/t/%D0%BE%D0%B1%D1%85%D0%BE%D0%B4-%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8-%D0%BD%D0%B0-mikrotik/666?page=7">Обход блокировки на mikrotik</a> настроил микротик на антизапрет.<br>
Всё хорошо, громадное спасибо.</p>
<p>Но далее возникла мысль ещё улучшить и поставить на микротик ADGuard Home, что собственно и было сделано.<br>
Установил контейнер с ADG и он как бы даже заработал. Но и не заработал. Получается либо доступ к нужным сайтам либо блокировка рекламы.</p>
<p>В теме про антизапрет явно указано, что<br>
IP - DNS settings должно быть только с Dynamics Servers полученным при OVPN. Так и есть.<br>
далее IP - DHCP Server - Networks - DNS Servers поле пустое.</p>
<p>Антизапрет работает и логично, что весь трафик идёт минуя ADG.<br>
И как только в  IP - DHCP Server - Networks - DNS Servers прописываешь 172.17.0.2 (это адрес ADG)<br>
то счётчики ADG начинают работать, но пропадает доступ к нужным сайтам.</p>
<p>Собственно подскажите, что и где правильно прописать в микротике, чтобы всё работало в связке. ADG+антизапрет.</p>
<p>Я читал читал, но так и не понял. Понял, что вроде как надо в IP - Firewall - NAT как-то что-то прописать…<br>
Микрот с прошивкой 7.15.1<br>
Хелп ми!</p>
<p>PS. После написания выше, возникла мысль, таки прописать в IP - DHCP Server - Networks - DNS Servers 172.17.0.2<br>
а в настройках DNS в ADG прописать DNS полученный при OVPN. <strong>И это как не странно сработало!</strong><br>
я прописал<br>
адрес от OVPN<br>
8.8.8.8<br>
94.140.14.14<br>
94.140.15.15</p>
<p>И следом ессно вопрос, а насколько постоянен адрес в от OVPN и чего будет если он поменяется? И вообще я правильно это сделал или есть более качественные варианты?</p>
<p>PS2. Блин! Рано радовался. Вначале заработало и опять перестали сайты открываться. А DNS Leak Test показывает вместо одного условно французского IP ещё и кучу финских. Таки вышеуказанная проблема не отменятся <img src="https://ntc.party/images/emoji/twitter/frowning.png?v=12" title=":frowning:" class="emoji" alt=":frowning:" loading="lazy" width="20" height="20"></p></td><td>2024-07-03T17:27:02.885Z</td></tr><tr><td>nzkhammatov(Ainur Khammatov)</td><td><aside class="quote no-group" data-username="Grib" data-post="7" data-topic="4493">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/g/dbc845/48.png" class="avatar"> Grib:</div>
<blockquote>
<p>подскажите, что и где правильно прописать в микротике, чтобы всё работало в связке. ADG+антизапрет</p>
</blockquote>
</aside>
<hr>
<p><strong>Mikrotik:</strong><br>
<em><strong>Interfaces - AntiZapret - Dial Out - Use Peer DNS -</strong></em> <code>no</code><br>
<em><strong>IP - DNS - Servers -</strong></em> <code>172.17.0.2</code></p>
<hr>
<p><strong>AdGuard Home:</strong><br>
<em><strong>Settings - DNS settings - Upstream DNS servers -</strong></em> <code>192.168.104.1</code><br>
<em><strong>Settings - DNS settings - Fallback DNS servers -</strong></em> <code>none</code></p>
<p><strong>Apply</strong><br>
<strong>Test upstreams</strong></p>
<hr>
<p><code>https://browserleaks.com/dns</code></p></td><td>2024-07-04T09:19:45.489Z</td></tr><tr><td>Grib(Алекс)</td><td><p>Спасибо. Практически сработало. Чуть допилить пришлось. Но всё в итоге получилось.<br>
При перезагрузке роутера всё колом вставало, так как в профиле антизапрета было<br>
/ip dns set servers=“”;<br>
/ip dns cache flush<br>
поменял на<br>
/ip dns set servers=“172.17.0.2”;</p>
<p>и вроде как всё норм.<br>
Ещё раз, спасибо.</p>
<p>Теперь вот буду разбираться с ADGuard, потому как даже не смотря на тучу фильтров, чистит баннеры криво, какие-то убираются, какие-то остаются. Логика не понятна.<br>
Да, и ещё подскажите, в логах теперь постоянно пишет “2024/07/05 23:46:40.204698 [error] dnsforward: invalid msg type HTTPS for custom IP blocking mode” это чего такое и как лечить?<br>
И ещё, пожалуй самое главное, теперь почему-то никак не хочет коннетиться back to home. Вроде всё так же включено, ничего не менял, но с андроид телефона “VPN connection failed” , не сталкивались? пробовал по QR коду подключение делать. На телефоне создаётся, но не подключается. Не понимаю, в какую сторону теперь копать.</p></td><td>2024-07-05T23:23:30.275Z</td></tr><tr><td>dartraiden(Alexander Gavrilov)</td><td><aside class="quote no-group" data-username="Grib" data-post="9" data-topic="4493">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/g/dbc845/48.png" class="avatar"> Grib:</div>
<blockquote>
<p>какие-то убираются, какие-то остаются. Логика не понятна</p>
</blockquote>
</aside>
<p>Которые грузятся с того же (под)домена, что и полезный контент - те, разумеется, остаются, поскольку AGH знает лишь то, с какого домена загрузилось “что-то”, но не знает, что именно, т.к. оно внутри HTTPS.</p>
<p>Именно поэтому блокировка рекламы средствами DNS всегда будет уступать расширению в браузере, которое имеет возможность применять косметические фильтры, скрывая то, загрузку чего заблокировать невозможно.</p></td><td>2024-07-06T15:32:24.050Z</td></tr><tr><td>Grib(Алекс)</td><td><p>Как бы понятно. Но тогда разъясните плиз такой момент.<br>
На андроид телефон можно скачать и прекрасно пользовать приложение ADGuard v.4.5<br>
Оно не привязано к какому-либо браузеру и не является его расширением.<br>
Конечно схема иная, так как при запуске приложения создаётся VPN и в любом браузере и приложении телефона реклама и всякие всплывающие окна режутся на 99%<br>
Каким образом эта схема работает? Ведь на том конце VPN стоит сервак с аля ADGuard home и так же блочит рекламу в трафике.</p>
<p>Собственно, затея с установкой Антизапрета + ADGHome на микрот была в том, чтобы я или кто-нить из родных не находясь в зоне вайфай сети микрота, а точнее находясь где угодно, мог спокойно с телефона подключаться по VPN к микроту и</p>
<ol>
<li>был доступ к ресурсам домашней сети</li>
<li>на телефоне была бы тишь и гладь в плане доступа к заблоченым ресурсам.</li>
<li>при открытии страниц не лезла бы со всех щелей безумная реклама и баннеры (и для каждого пользователя сети можно было регулировать доступ к ресурсам)</li>
</ol>
<p>на сегодня</p>
<ol>
<li>реализовано</li>
<li>реализовано</li>
<li>частично и криво. <img src="https://ntc.party/images/emoji/twitter/frowning.png?v=12" title=":frowning:" class="emoji" alt=":frowning:" loading="lazy" width="20" height="20"></li>
</ol>
<p>Я честно говоря надеялся на хотя бы приближенно по блоку рекламы как в случае с приложением на телефоне.<br>
Вся проблема приложения ADGuard в том, что оно VPN. А на телефоне два VPN одновременно не сделаешь.</p>
<p>И ессно получается, либо VPN1 и блочится реклама, либо VPN2 и есть доступ к заблокированным в стране ресурсам, либо VPN3 и доступ к домашней сети.<br>
Внятных решений для условного микрота и порядка 10 юзеров я не нашел.</p></td><td>2024-07-08T22:07:16.434Z</td></tr><tr><td>dartraiden(Alexander Gavrilov)</td><td><aside class="quote no-group" data-username="Grib" data-post="11" data-topic="4493">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/g/dbc845/48.png" class="avatar"> Grib:</div>
<blockquote>
<p>всякие всплывающие окна режутся на 99%</p>
</blockquote>
</aside>
<p>В приложении есть опция вскрытия HTTPS-трафика (выключена по умолчанию), вот с ней, конечно, блокируется гораздо больше, поскольку, вскрыв HTTPS, можно видеть полный URL и отличать, допустим, запрос к <a href="http://example.org/cat.jpg">example.org/cat.jpg</a> от запроса к <a href="http://example.org/ad.jpg">example.org/ad.jpg</a>, блокируя последний.</p>
<p>По сути, это устраивание <a href="https://ru.wikipedia.org/wiki/%D0%90%D1%82%D0%B0%D0%BA%D0%B0_%D0%BF%D0%BE%D1%81%D1%80%D0%B5%D0%B4%D0%BD%D0%B8%D0%BA%D0%B0">MitM</a> самому себе. Что, в общем-то, порочная практика. Просто иногда другого варианта нет, если, например, реклама не в браузере, а в игре или в приложении каком-то.</p>
<p>Но Adguard Home так не сможет, потому что он простой DNS-сервер.</p>
<p>Могу посоветовать связку АнтиЗапрет + Adguard Home (чтобы избавить хотя бы от части рекламы приложения, которые не являются браузером) + расширение uBlock в браузеры, чтобы там рекламы не было вовсе. В Android, вроде, только Firefox поддерживает расширения.</p>
<p>Кроме того, Adguard поддерживает работу через прокси. То есть, сначала он блокирует запросы на загрузку рекламы, а затем весь трафик пускает через прокси (<strong>Настройки</strong> → <strong>Фильтрация</strong> → <strong>Сеть</strong> → <strong>Прокси</strong>). Так что, если у вас есть свой сервер за пределами России, вы можете там поднять SOCKS5-прокси (допустим, Dante), указать его адрес в AdGuard и все ваши устройства будут ходить в интернет через этот зарубежный прокси. Конечно, при этом ВЕСЬ трафик со всех этих устройств будет идти через ваш зарубежный сервер, так что всякие Госуслуги и прочая российская госуха вас к себе не пустят, они от зарубежного трафика огородились.</p>
<p>Идеальное решение тут, увы, только одно - добиваться упразднения блокировок в России, но это уже выходит за рамки тематики ресурса…</p></td><td>2024-07-12T22:24:28.446Z</td></tr><tr><td>Xunlei</td><td><aside class="quote no-group" data-username="dartraiden" data-post="12" data-topic="4493">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/dartraiden/48/15299_2.png" class="avatar"> dartraiden:</div>
<blockquote>
<p>В Android, вроде, только Firefox поддерживает расширения.</p>
</blockquote>
</aside>
<p>Файрфокс у меня не запускается без GAPS. С расширениями работают Iceraven и Kiwi Browser.</p></td><td>2024-07-12T23:17:15.763Z</td></tr><tr><td>Twister(Twisterndfhm)</td><td><p>Столкнулся с проблемой. Микротик Hap АС^2. Установил Флешку отформатировал ext4. Флэшка на 4г. Накатил на флешку контейнер Adguard Home. В браузере Home настраивается. Но не работает. В DNS ввожу настройки. Но Adgard Home не работает. Стоит еще Тунель  6to4 Tunnel. На компьютере запускаю Adgard Home работает. На микротике не вкакую не хочет.</p></td><td>2024-09-22T07:16:44.566Z</td></tr><tr><td>Grib(Алекс)</td><td><p>В смысле счётчики в ADG не идут?<br>
Скорее всего с DNS не так чего-то.<br>
Если так, то скорее всего<br>
В микроте  IP - DHCP Server - Networks - DNS Servers 172.17.0.2<br>
А в ADG условно апстрим днс 94.140.14.14<br>
94.140.15.15</p>
<p>И когда блэклисты будете в адг прикручивать, почитайте мои посты, чтобы роутер не повесить.</p>
<p>На компе в винде  ipconfig /all  должно показать dns 172.17.0.2</p></td><td>2024-09-22T07:36:28.209Z</td></tr><tr><td>Twister(Twisterndfhm)</td><td><aside class="quote no-group" data-username="Grib" data-post="15" data-topic="4493">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/g/dbc845/48.png" class="avatar"> Grib:</div>
<blockquote>
<p>94.140.15.15</p>
</blockquote>
</aside>
<p>В микроте IP - DHCP Server - Networks - DNS Servers 172.17.0.2 прописан.<br>
На компе в винде ipconfig /all должно показать dns 172.17.0.2   показывает.<br>
А счетчик не идет. Upstream DNS-серверы что бы не подставлял нечего не работает.</p></td><td>2024-09-22T07:55:38.958Z</td></tr><tr><td>Twister(Twisterndfhm)</td><td><p>Лог всю дорогу пишет:<br>
2024/08/25 20:11:27.300926 [error] dnsproxy: upstream 1.1.1.1:53 failed to exchange ;1.0.17.172.in-addr.arpa.	IN	 PTR in 2.007128539s: exchanging with 1.1.1.1:53 over udp: read udp 172.17.0.3:43165-&gt;1.1.1.1:53: i/o timeout</p></td><td>2024-09-22T07:59:33.855Z</td></tr><tr><td>Grib(Алекс)</td><td><p>так в ADG апстрим серверы тестятся?</p></td><td>2024-09-22T08:24:41.925Z</td></tr><tr><td>Twister(Twisterndfhm)</td><td><p>нет</p></td><td>2024-09-22T08:25:11.226Z</td></tr><tr><td>Grib(Алекс)</td><td><p>хм. мож у вас провайдер блочит dns. Я не особо шарю в этих вещах.<br>
у меня сейчас так<br>
DNS<br>
1.1.1.1<br>
9.9.9.10</p>
<p>инет РТ по ppoe.<br>
в interface ppoe-out1 галка peer dns снята, т.е. dns беру не от провайдера, а те которые указал выше.</p>
<p>ipv6 работает нормально?<br>
<a href="http://test-ipv6.com/" rel="noopener nofollow ugc">http://test-ipv6.com/</a> тест проходит?</p></td><td>2024-09-22T08:37:36.055Z</td></tr><tr><td>Twister(Twisterndfhm)</td><td><p>ipv6 работает. Тест проходит. в interface ppoe-out1 галка peer dns снята. Да снята.</p></td><td>2024-09-22T09:01:17.922Z</td></tr><tr><td>Dhohbr</td><td><p>Контейнер у вас в отдельнойсети находится или в локальной? Маскарадинг для него есть?</p>
<p>Зайдите в контейнер и попингуйте что-нибудь<br>
/container/shell 0</p></td><td>2024-09-22T09:13:02.134Z</td></tr>
    </table>
      </body>
    </html>