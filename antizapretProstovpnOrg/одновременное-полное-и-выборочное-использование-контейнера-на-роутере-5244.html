
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>одновременное-полное-и-выборочное-использование-контейнера-на-роутере-5244</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>Llloooggg</td><td><p>Добрый день!</p>
<p>Развернут контейнер LXD. Все сделал по инструкции <a href="https://ntc.party/t/vpn-vpn/2040/2">отсюда</a>, чтобы один инстанс мог работать и как антизапрет, и как полный впн. Теперь пытаюсь подключить оба конфига на роутере Keenetic Peak(прошивка 4.0.2), но одновременно работать они отказываются. Первый включенный(порядок роли не играет) отрабатывает нормально, но второй всегда выдает “Конфликт IP-адреса с интерфейсом «название-другого-конфига» (192.168.104.2/22)”. В логах роутера это отображается как “Network::Interface::Ip: “OpenVPN1”: network 192.168.104.0/22 conflicts with interface “OpenVPN0”.”.</p>
<p>Весь этот колхоз нужен для того, чтобы по политикам часть устройств за роутером всегда ходила только как через полный впн, а часть как через антизапрет. Подскажите, пожалуйста, возможно ли так вообще настроить, не поднимая другой инстанс OpenVPN’a и если да, то как</p></td><td>2023-08-09T16:05:36.882Z</td></tr><tr><td>ValdikSS</td><td><p>Вам необходимо поднять одно VPN-соединение и настроить разные policy-based routing (разные таблицы маршрутизации) для разных клиентов: одни не маршрутизируют весь трафик в VPN, а другие маршрутизируют.</p></td><td>2023-08-10T05:42:43.762Z</td></tr><tr><td>Llloooggg</td><td><p>Так ведь чтобы антизапрет работал нужно в него по-любому весь трафик заворачивать, а дальше он уже сам решает. И, как я понимаю, после той дополнительной настройки будет ли антизапрет отрабатывать “штатно” или заворачивать в себя все подряд зависит только от клиентского конфига и я не очень понимаю как это в рамках одного подключения должно уживаться</p></td><td>2023-08-10T07:50:23.085Z</td></tr><tr><td>ValdikSS</td><td><aside class="quote no-group" data-username="Llloooggg" data-post="3" data-topic="5244">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/llloooggg/48/2946_2.png" class="avatar"> Llloooggg:</div>
<blockquote>
<p>Так ведь чтобы антизапрет работал нужно в него по-любому весь трафик заворачивать, а дальше он уже сам решает.</p>
</blockquote>
</aside>
<p>При обычной конфигурации клиенту сообщается большой внутренний маршрут, а DNS-сервер отдаёт IP-адреса из этого диапазона, если домен нужно проксировать. Если клиент попробует смаршрутизировать какой-то другой IP-адрес или диапазон, серверный фильтр отсеет такое подключение.</p>
<p>Вы убрали серверный фильтр, теперь любой клиент может маршрутизировать любой диапазон. Нужно настроить роутер так, чтобы маршрутизировал необходимый вам трафик в VPN. DNS там, где нужно маршрутизировать произвольный трафик, можно использовать любой, не обязательно антизапретовский (но и с ним будет работать).</p></td><td>2023-08-10T09:30:28.194Z</td></tr><tr><td>Llloooggg</td><td><p>На столько в вопросе не разбираюсь <img src="https://ntc.party/images/emoji/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"><br>
Можно, пожалуйста, пример какой-нибудь как это должно выглядеть?</p></td><td>2023-08-10T09:44:47.329Z</td></tr><tr><td>ValdikSS</td><td><p>Нужно настроить роутер так, чтобы одни клиенты (которым не нужно проксировать весь трафик) не использовали маршрут по умолчанию через VPN, а другие использовали. В Linux это осуществляется двумя таблицами маршрутизации (<code>ip route ... table ...</code>) и правилами маршрутизации (<code>ip rule</code>). Как это сделать в рамках интерфейса Keenetic не подскажу, см. документацию.</p></td><td>2023-08-10T10:11:21.462Z</td></tr><tr><td>Llloooggg</td><td><p>Буду пробовать, спасибо!</p></td><td>2023-08-10T10:24:03.613Z</td></tr>
    </table>
      </body>
    </html>