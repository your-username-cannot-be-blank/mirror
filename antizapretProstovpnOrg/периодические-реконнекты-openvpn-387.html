
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>периодические-реконнекты-openvpn-387</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>RIP</td><td><p>Доброго времени суток.</p>
<p>На роутере (openwrt) настроено соединение с антизапретом через openvpn. Проблема в том, что какое-то время назад начались периодические реконнекты с сервером. Началось это +/- после обновления прошивки, но смущает то, что время слишком уж одинаковое - вечером в 18+ часов по МСК и где-то в районе 11 или 14 днём.</p>
<p>В логах имеем лишь сброс соединения (со стороны сервера?)</p>
<blockquote>
<p>Mon Mar  2 18:18:55 2020 daemon.err openvpn(antizapret)[2191]: Connection reset, restarting [-1]<br>
Mon Mar  2 18:18:55 2020 daemon.notice openvpn(antizapret)[2191]: SIGUSR1[soft,connection-reset] received, process restarting</p>
</blockquote>
<p>и последующий реконнект.</p>
<p>Это действительно на стороне сервера или это всё-таки из-за клиента? Откатить прошивку пока не могу.<br>
Проблема вроде не критичная, т.к. реконнект происходит в течении 10 секунд, но вечерний попадает как раз на сеанс связи скайпа, который в этот момент рвётся.</p></td><td>2020-03-02T15:56:14.098Z</td></tr><tr><td>ValdikSS</td><td><p>На данный момент к серверу подключено 9 клиентов с января и 393 с февраля, которые не переподключались с этого периода. Проблем на сервере не вижу. Вероятнее всего, дело в вашем маршрутизаторе или провайдере.</p>
<p>Если вести сеанс связи по Skype без VPN АнтиЗапрета, соединение не рвется?</p></td><td>2020-03-03T16:26:16.431Z</td></tr><tr><td>RIP</td><td><p>Нет, сам по себе скайп работает нормально, как собс-но и интернет в целом (l2tp Билайн). Реконнектится только openvpn, причём на ровном месте, т.к. даже в его подробных логах нет никаких предпосылок, просто Connection reset. Сам же скайп, как я понимаю, рвётся из-за рестарта фаервола, сопровождающего рестарт впна.<br>
Откатился таки на предыдущую прошивку (вернулся с 19.07.x на 18.06.8) и… ничего не изменилось. Будет время попробую откатиться ещё дальше, но думаю не поможет. Чёткие временные рамки намекают на то, что соединение рвётся из-за выполнения какого-то задания. Ну а раз на сервере я один с такой проблемой, значит дело в провайдере.</p></td><td>2020-03-03T17:26:56.767Z</td></tr><tr><td>ValdikSS</td><td><p>Я тут подумал: не связаны ли переподключения со временем жизни (lease time) IP-адреса через DHCP?</p></td><td>2020-03-13T18:54:08.789Z</td></tr><tr><td>RIP</td><td><p>В смысле раздаваемые роутером айпишники? Они бессрочные (infinite).<br>
Пытался поймать момент дисконнекта в  verb 11 логах openvpn’а, но слишком уж они много весят, даже +/- зная момент дисконнекта. Причём дисконнекты действительно в одно время - за 3 дня они были в 18:15, 18:19, 18:14 (от аптайма роутера/интернета не зависит вообще никак), что несколько странно, но в некоторые дни их просто нет, что ещё страннее.<br>
Если в логах действительно может быть что-то, что подскажет проблему, заморочусь с записью на внешний диск.<br>
Пока решил проблему так - убрал рестарт файрвола при рестарте интерфейса openvpn’а. Так оно хотя бы интернет на устройствах не рвёт.</p></td><td>2020-03-13T19:28:06.904Z</td></tr><tr><td>ValdikSS</td><td><aside class="quote no-group" data-username="RIP" data-post="5" data-topic="387">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/r/e99b99/48.png" class="avatar"> RIP:</div>
<blockquote>
<p>В смысле раздаваемые роутером айпишники? Они бессрочные (infinite).</p>
</blockquote>
</aside>
<p>Нет, раздаваемые провайдером адреса.</p>
<aside class="quote no-group" data-username="RIP" data-post="5" data-topic="387">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/letter_avatar_proxy/v4/letter/r/e99b99/48.png" class="avatar"> RIP:</div>
<blockquote>
<p>Пытался поймать момент дисконнекта в verb 11 логах openvpn’а, но слишком уж они много весят,</p>
</blockquote>
</aside>
<p>Это не нужно: сигнал на переподключение OpenVPN’у присылает внешний скрипт или программа (сигнал SIGUSR1), это видно из вашего первого сообщения. Я предполагаю, что это происходит в момент истечения срока аренды IP-адреса через DHCP.</p></td><td>2020-03-13T20:22:36.034Z</td></tr>
    </table>
      </body>
    </html>