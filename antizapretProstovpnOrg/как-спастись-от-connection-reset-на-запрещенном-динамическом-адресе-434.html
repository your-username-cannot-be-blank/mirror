
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>как-спастись-от-connection-reset-на-запрещенном-динамическом-адресе-434</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>nnseva(Vsevolod Novikov)</td><td><p>При доступе из Firefox с настроенным списком antizapret к <a href="https://help.figma.com" rel="nofollow noopener">https://help.figma.com</a> возникает connection reset. Это эффект цензуры (через прокси friGate в Chromium достп нормальный). antizapret в браузере настроен и работает, например доступ к <a href="http://www.profinance.ru" rel="nofollow noopener">http://www.profinance.ru</a> нормальный, несмотря на блокировку.</p>
<p>Я понимаю так, что проблема в том, что имя DNS разрешается в адрес, попавший в списки блокировки и блокируемый с помощью connection reset.</p>
<p>Решается ли такая проблема с помощью antizapret?</p></td><td>2020-04-09T18:49:57.251Z</td></tr><tr><td>ValdikSS</td><td><p>В какие адреса у вас резолвится этот домен? У меня он не проксируется.</p></td><td>2020-04-09T20:07:03.277Z</td></tr><tr><td>nnseva(Vsevolod Novikov)</td><td><p>seva@SEVA-WORK:~$ nslookup <a href="http://help.figma.com" rel="nofollow noopener">help.figma.com</a><br>
Server:         127.0.0.53<br>
Address:        127.0.0.53#53</p>
<p>Non-authoritative answer:<br>
help.figma. com  canonical name = figma.zendesk. com.<br>
Name:   figma. zendesk. com<br>
Address: 104.16.52.111<br>
Name:   figma. zendesk. com<br>
Address: 104.16.51.111<br>
Name:   figma. zendesk. com<br>
Address: 104.16.54.111<br>
Name:   figma. zendesk. com<br>
Address: 104.16.53.111<br>
Name:   figma. zendesk. com<br>
Address: 104.16.55.111</p></td><td>2020-04-10T19:53:14.205Z</td></tr><tr><td>ValdikSS</td><td><p>Эти адреса не должны проксироваться. У меня открывается сайт со включённым Антизапретом.<br>
Следуйте инструкции по диагностике, описанные в <a href="https://antizapret.prostovpn.org/help.html">https://antizapret.prostovpn.org/help.html</a>.</p></td><td>2020-04-10T20:56:44.281Z</td></tr><tr><td>nnseva(Vsevolod Novikov)</td><td><p>Вот сессия curl при попытке соединения из России:</p>
<pre><code class="lang-auto">seva@SEVA-WORK:~$ curl https://help.figma.com/ -vvv &gt;/dev/null 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying 104.16.54.111:443...
* TCP_NODELAY set
* connect to 104.16.54.111 port 443 failed: В соединении отказано
*   Trying 104.16.52.111:443...
* TCP_NODELAY set
* connect to 104.16.52.111 port 443 failed: В соединении отказано
*   Trying 104.16.51.111:443...
* TCP_NODELAY set
* connect to 104.16.51.111 port 443 failed: В соединении отказано
*   Trying 104.16.53.111:443...
* TCP_NODELAY set
* connect to 104.16.53.111 port 443 failed: В соединении отказано
*   Trying 104.16.55.111:443...
* TCP_NODELAY set
* connect to 104.16.55.111 port 443 failed: В соединении отказано
* Failed to connect to help.figma.com port 443: В соединении отказано
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
* Closing connection 0
curl: (7) Failed to connect to help.figma.com port 443: В соединении отказано
</code></pre>
<p>Вот сессия соединения curl (начало) с сервера из Германии:</p>
<pre><code class="lang-auto">seva@*****_com_de:~$ curl https://help.figma.com/ -vvv &gt;/dev/null
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying 104.16.54.111...
* TCP_NODELAY set
* Connected to help.figma.com (104.16.54.111) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
} [5 bytes data]
* TLSv1.2 (OUT), TLS handshake, Client hello (1):
} [212 bytes data]
* TLSv1.2 (IN), TLS handshake, Server hello (2):
{ [104 bytes data]
* TLSv1.2 (IN), TLS handshake, Certificate (11):
{ [2811 bytes data]
...
</code></pre>
<p>И наконец, вот подтверждение от оригинального источника, что искомый адрес действительно заблокирован</p>
<p><img src="как-спастись-от-connection-reset-на-запрещенном-динамическом-адресе-434/1f7037e4e4ed96875f995f2943206e05323d86db.png" alt="image" data-base62-sha1="4u7e9qWzdPgWn6YxqNG5lOMqjR9" width="313" height="242"></p>
<p>Вывод: antizapret у меня на firefox включен и работает нормально. К сожалению, antizapret ориентируется на списки запрещенных сайтов, в которых нет help. figma. com.<br>
Тем временем, где-то в списках запрещенных находится адрес IP, который был динамически распределен указанному сайту, поэтому несмотря на формальное отсутствие самого сайта, соединение не устанавливается из за цензуры (способом отправки ложного пакета отказа от соединения).</p>
<p>Вопрос 1. может быть, можно как-то настроить автоматическую настройку прокси, чтобы учитывались не только доменные адреса, но и адреса IP?<br>
Вопрос 2. Если это невозможно, нельзя ли расширить алгоритм формирования списка сайтов antizapet так, чтобы в него как-то попадали и сайты, которым - временно или постоянно - достался адрес IP из заблокированных диапазонов?</p></td><td>2020-04-11T08:27:31.351Z</td></tr><tr><td>ValdikSS</td><td><p>Теперь понятен ваш вопрос. Я думал, что вы получаете connection reset от прокси-сервера, а не от провайдера.<br>
В реестре запрещенных сайтов нет блокировки IP-адресов домена <a href="http://help.figma.com">help.figma.com</a>, есть только блокировка конкретной ссылки на домене <a href="http://bikhir.zendesk.com">bikhir.zendesk.com</a>: <a href="https://reestr.rublacklist.net/record/1274095/">https://reestr.rublacklist.net/record/1274095/</a><br>
Почему сервис от Роскомнадзора что-то находит по IP-адресу — непонятно, видимо, ввели недавно, раньше такого не было. Видно, что в результате написано об ограничении к странице (имеется в виду страница на домене <a href="http://bikhir.zendesk.com">bikhir.zendesk.com</a>), а не к IP-адресу.<br>
Ваш провайдер блокирует то, что не должен блокировать. Обращайтесь к вашему провайдеру.</p></td><td>2020-04-11T09:16:39.725Z</td></tr><tr><td>nnseva(Vsevolod Novikov)</td><td><p>Сервис от РКН, сколько он существовал, всегда находил блокировки по адресу IP. Что касается того, почему провайдер блокирует по IP - ответ прост, потому что соединение по HTTPS в общем случае, не фильтруется по доменному имени, а тем более - по URL, так как и то, и другое находится внутри защищенной сессии SSL, на то он и HTTPS.</p>
<p>Как легко заметить по информации whois, адреса в диапазоне 104.16.0.0 - 104.31.255.255, в том числе те, в которые сейчас разрешается рассматриваемый домен, принадлежат сервису Cloudflare. Это означает, что они распределяются динамически. На момент создания указанной в реестре записи, в них по всей видимости, разрешался другой домен, также обслуживаемый в Cloudflare, который и занесен в черный список.</p>
<p>Проблема в том, что на момент установления соединения, согласно протоколу TCP, доменное имя не указывается, а используется адрес IP. Поскольку этот адрес содержится в реестре, провайдер его блокирует.</p>
<p>Конечно, при выполнении более тщательного анализа трафика на стороне провайдера, ему можно было бы отложить блокировку до начала процедуры установления сессии TLS, в рамках которой с некоторой вероятностью, в расширении SNI могло бы появиться имя домена, к которому выполняется запрос.</p>
<p>Однако, такая процедура требует значительно бОльших затрат на обслуживание и строго говоря, нарушает принцип сетевой нейтральности. Кроме того, такой анализ может оказаться бесполезным, если сервер или клиент не поддерживают опциональную процедуру SNI.</p>
<p>Фактом является то, что многие провайдеры не выполняют глубокий анализ трафика, требуемый для блокировки по SNI, а полностью блокируют адрес IP, оказавшийся в списке блокировок. Это реальность, с которой приходится сталкиваться. В этих обстоятельствах, сервис antizapret к сожалению, в настоящий момент не помогает полностью разрешить проблемы, вызванные блокировками и в этом смысле, становится гораздо менее полезен, чем мог бы быть.</p>
<p>Тем не менее, я высказываю Вам глубокую благодарность за вашу деятельность и надеюсь, что наше обсуждение было полезным для обеих сторон.</p>
<p>Для разрешения своей проблемы, я использовал плагин browsec, позволяющий добавлять произвольные серверы в список проксируемых, что видимо, и следует рекомендовать всем, кто столкнулся с проблемой, аналогичной моей.</p>
<p>С уважением,<br>
Всеволод Новиков</p></td><td>2020-04-11T12:11:55.980Z</td></tr><tr><td>ValdikSS</td><td><aside class="quote no-group" data-username="nnseva" data-post="7" data-topic="434">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/nnseva/48/278_2.png" class="avatar"> nnseva:</div>
<blockquote>
<p>Проблема в том, что на момент установления соединения, согласно протоколу TCP, доменное имя не указывается, а используется адрес IP. Поскольку этот адрес содержится в реестре, провайдер его блокирует.</p>
</blockquote>
</aside>
<p>Эти IP-адреса НЕ заблокированы реестром запрещенных сайтов.<br>
Выгрузка реестра сайтов представлена в виде XML-файла, с множеством полей для каждого заблокированного элемента. Элемент может быть заблокирован по ссылке, по домену, либо же по IP-адресу, но у каждого заблокированного домена или адреса также есть список IP-адресов. Они представлены для информации провайдеру, и не должны блокироваться, по рекомандательным документам провайдерам от Роскомнадзора.</p>
<p>XML-файл содержит следующую запись:</p>
<pre><code class="lang-auto">  &lt;content id="1274095" includeTime="2020-03-25T16:54:08" entryType="1" hash="C0D89404E023C9486E87E3A867DB3B55"&gt;
    &lt;decision date="2018-05-14" number="2-6-20/2017-12-25-1473-АИ" org="ФНС"/&gt;
    &lt;url&gt;&lt;![CDATA[https://bikhir.zendesk.com/hc/fr/community/posts/209112709-%d0%a1%d1%83%d0%bf%d0%b5%d1%80-%d0%bb%d1%8f%d0%b3%d1%83%d1%88%d0%ba%d0%b0-%d0%bd%d0%b0-%d0%b0%d0%bd%d0%b4%d1%80%d0%be%d0%b8%d0%b4-%d1%81%d1%83%d0%bf%d0%b5%d1%80-%d0%bb%d1%8f%d0%b3%d1%83%d1%88%d0%ba%d0%b0-%d0%b4%d0%bb%d1%8f-%d0%bc%d0%be%d0%b7%d0%b8%d0%bb%d1%8b]]&gt;&lt;/url&gt;
    &lt;domain&gt;&lt;![CDATA[bikhir.zendesk.com]]&gt;&lt;/domain&gt;
    &lt;ip&gt;104.16.54.111&lt;/ip&gt;
    &lt;ip&gt;104.16.52.111&lt;/ip&gt;
    &lt;ip&gt;104.16.55.111&lt;/ip&gt;
    &lt;ip&gt;104.16.53.111&lt;/ip&gt;
    &lt;ip&gt;104.16.51.111&lt;/ip&gt;
  &lt;/content&gt;
</code></pre>
<p><a href="https://vigruzki.rkn.gov.ru/docs/description_for_operators_actual.pdf">Описание формата</a> говорит следующее:</p>
<pre><code class="lang-auto">Атрибут content.blockType

Код типа блокировки реестровой записи:
default – блокировка по стандартным правилам
domain – блокировка по доменному имени
ip – блокировка по сетевому адресу
domain-mask – блокировка по маске доменного имени

Если данный атрибут отсутствует либо указано значение «default», то блокировка осуществляется по стандартным правилам. Если указано значение «domain», то указатели страниц сайтов (URL) для данной реестровой записи будут отсутствовать, необходимо ограничить доступ к домену целиком.
Если указано значение «ip», то указатели страниц сайтов (URL) и доменное имя для данной реестровой записи будут отсутствовать, необходимо ограничить доступ по сетевому адресу.
Если указано значение «domain-mask», то указатели страниц сайтов (URL) для данной реестровой записи будут отсутствовать, значение доменного имени будет указано с маской в виде «*.domain.com». При этом необходимо ограничить доступ к основному доменному имени, а также ко всем доменным именам, подпадающим под маску.
</code></pre>
<p>Как видим, атрибут blockType у этого элемента отсутствует, значит блокировка осуществялется по «стандартным правилам».<br>
Подавляющее большинство провайдеров не блокируют IP-адреса у подобных записей просто так, однако, как вы заметили, это — Cloudflare, а для Cloudflare часто действует другая логика, по какой-то невыясненной причине.</p>
<p>Во-первых, если у вас включён ESNI и DNS over HTTPS — отключите их (см. <a href="https://ntc.party/t/esni-encrypted-sni/68" class="inline-onebox">Использование ESNI (Encrypted SNI) в России</a>)</p>
<aside class="quote no-group" data-username="nnseva" data-post="7" data-topic="434">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/nnseva/48/278_2.png" class="avatar"> nnseva:</div>
<blockquote>
<p>Конечно, при выполнении более тщательного анализа трафика на стороне провайдера, ему можно было бы отложить блокировку до начала процедуры установления сессии TLS, в рамках которой с некоторой вероятностью, в расширении SNI могло бы появиться имя домена, к которому выполняется запрос.</p>
<p>Однако, такая процедура требует значительно бОльших затрат на обслуживание и строго говоря, нарушает принцип сетевой нейтральности. Кроме того, такой анализ может оказаться бесполезным, если сервер или клиент не поддерживают опциональную процедуру SNI.</p>
</blockquote>
</aside>
<p>Провайдеров в РФ, так или иначе не применяющих системы DPI — не более нескольких десятков. У подавляющего большинства провайдеров установлены системы DPI, которые блокируют только конкретные ссылки (для HTTP) или домены (для HTTPS). Многие провайдеры, не имеющие своего DPI, пользуются системой вышестоящего провайдера.<br>
Для вашей информации, даже транзитный многогигабитный трафик проходит через DPI, а то и через несколько (разных провайдеров).<br>
Устройства без поддержки SNI — ничтожно малая часть интернета.</p>
<aside class="quote no-group" data-username="nnseva" data-post="7" data-topic="434">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://ntc.party/user_avatar/ntc.party/nnseva/48/278_2.png" class="avatar"> nnseva:</div>
<blockquote>
<p>Фактом является то, что многие провайдеры не выполняют глубокий анализ трафика, требуемый для блокировки по SNI, а полностью блокируют адрес IP, оказавшийся в списке блокировок. Это реальность, с которой приходится сталкиваться. В этих обстоятельствах, сервис antizapret к сожалению, в настоящий момент не помогает полностью разрешить проблемы, вызванные блокировками и в этом смысле, становится гораздо менее полезен, чем мог бы быть.</p>
</blockquote>
</aside>
<p>Я намеренно отказался от поддержки этих провайдеров несколько лет назад, т.к. с этими провайдерами приходится проксировать значительную часть интернета.<br>
Если даже у провайдеров с DPI периодически бывают проблемы с доступностью тех или иных незаблокированных сайтов, то у вашего, полагаю, половина интернета не работоспособна.<br>
В вашем случае разумно использовать полноценный VPN в другую страну, либо же сменить провайдера.</p>
<p>Возможно, ваш провайдер применяет особые правила блокировки адресов только для Cloudflare, а для обычных сайтов не применяет блокировки по IP-адресам — я встречал таких. В таком случае, можете сделать VPN для <a href="https://www.cloudflare.com/ips/">всех диапазонов Cloudflare</a>, и проблема будет решена.</p></td><td>2020-04-11T13:05:12.169Z</td></tr>
    </table>
      </body>
    </html>