
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
    th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      word-wrap: break-word;
      padding: 5px;
    }
    table {
      width: 100%;
      max-width: 100%;
      border: 1px solid black;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word
    }
    code {
      word-wrap: break-word;
    }
    pre {
        white-space: pre-wrap;
    }
    </style>
        <title>ios-macos-и-антизапрет-openvpn-на-роутере-не-работает-почта-icloud-4521</title>
      </head>
      <body>
        <table border="1" width="100%" cellpadding="5">
          <tr>
            <th style="width: 10%;">Ник</th>
            <th>Пост</th>
            <th style="width: 10%;">Дата</th>
          </tr>
    <tr><td>ptath</td><td><ul>
<li>Тип настройки: VPN</li>
<li>Тип проблемы: не работает НЕзаблокированный сайт (иное)</li>
<li>Что с сайтом: ошибка в браузере (иное)</li>
<li>Используемый браузер: иное</li>
</ul>
<h4><a name="p-13813-h-1" class="anchor" href="#p-13813-h-1"></a>Описание проблемы</h4>
<p>Сетап — keenetic 3.7 с установленным VPN, используются обычные dns 1.1.1.1 и 1.0.0.1 как в настройках роутера, так и ovpn. Конфиг:</p>
<pre><code class="lang-auto">nobind
client

remote vpn.antizapret.prostovpn.org

remote-cert-tls server

dev tun
proto tcp
cipher AES-128-CBC

resolv-retry infinite
persist-key
persist-tun

setenv FRIENDLY_NAME "AntiZapret VPN TCP"

pull-filter ignore block-outside-dns
route 1.1.1.1
route 1.0.0.1
</code></pre>
<p>Всё отлично работает, кроме одного — почты iCloud. Ошибка присутствует на всех устройствах с яблоком, подключенных к рутеру и исчезает при отключении VPN.</p>
<p>Родной почтовый клиент ругается на подключение к imap-серверу apple. Сам сервер пингуется, куда дальше копать — не знаю. К smtp-серверу подключается без проблем, письма отправляются.</p>
<p>На айфоне/айпаде аналогичные ошибки.</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="ios-macos-и-антизапрет-openvpn-на-роутере-не-работает-почта-icloud-4521/b7ebfb823b7a84644eec5c99bfbe1991add44019.png" data-download-href="https://ntc.party/uploads/default/b7ebfb823b7a84644eec5c99bfbe1991add44019" title="Снимок экрана 2023-05-17 в 20.28.49"><img src="ios-macos-и-антизапрет-openvpn-на-роутере-не-работает-почта-icloud-4521/b7ebfb823b7a84644eec5c99bfbe1991add44019.png" alt="Снимок экрана 2023-05-17 в 20.28.49" data-base62-sha1="qf2XXOenWkWcYItkiO7TXaXXBjj" width="565" height="500" data-dominant-color="D2D1D6"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Снимок экрана 2023-05-17 в 20.28.49</span><span class="informations">586×518 40.7 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>Разумеется, вместо <a href="http://p71-imap.mail.me.com" rel="noopener nofollow ugc">p71-imap.mail.me.com</a> может быть любой сервер, цифры периодически меняются. Это касается только почты icloud (которая <span class="mention">@icloud.com</span>). Рядышком без проблем работает gmail и Яндекс. В логах почты такое:</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="ios-macos-и-антизапрет-openvpn-на-роутере-не-работает-почта-icloud-4521/4f520544d6027cbc8dc4a118468bf8bd6f8ebdf2.png" data-download-href="https://ntc.party/uploads/default/4f520544d6027cbc8dc4a118468bf8bd6f8ebdf2" title="Снимок экрана 2023-05-17 в 20.29.04"><img src="ios-macos-и-антизапрет-openvpn-на-роутере-не-работает-почта-icloud-4521/4f520544d6027cbc8dc4a118468bf8bd6f8ebdf2_2_690x98.png" alt="Снимок экрана 2023-05-17 в 20.29.04" data-base62-sha1="bjHrNQsi97tU1Vn7qJX0Dsfh1OG" width="690" height="98" srcset="ios-macos-и-антизапрет-openvpn-на-роутере-не-работает-почта-icloud-4521/4f520544d6027cbc8dc4a118468bf8bd6f8ebdf2_2_690x98.png, ios-macos-и-антизапрет-openvpn-на-роутере-не-работает-почта-icloud-4521/4f520544d6027cbc8dc4a118468bf8bd6f8ebdf2_2_1035x147.png 1.5x, ios-macos-и-антизапрет-openvpn-на-роутере-не-работает-почта-icloud-4521/4f520544d6027cbc8dc4a118468bf8bd6f8ebdf2_2_1380x196.png 2x" data-dominant-color="6F94E3"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Снимок экрана 2023-05-17 в 20.29.04</span><span class="informations">1428×204 50.2 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>Всё что написано выше про флажок — неприменимо, потому что настроек для почты icloud в почтовом клиенте попросту нет, только для неродных сервисов. Опять же это проблему не решит, потому что не работают любые почтовые клиенты на любых устройствах за vpn, хочу разобраться в причине.</p>
<p>Может как-то связано с этим: <a href="https://ntc.party/t/ios-macos-openvpn/4468" class="inline-onebox">iOS, macOS и антизапрет OpenVPN на роутере, есть проблемы</a> ? Но у меня сайты открываются, проблема именно с SSL на imap-порту 993 и только с <a href="http://mail.me.com" rel="noopener nofollow ugc">mail.me.com</a>.</p></td><td>2023-05-17T22:34:34.776Z</td></tr><tr><td>ValdikSS</td><td><p>Проверяйте, в какой адрес резолвится <code>p71-imap.mail.me.com</code>. Проблем на стороне сервера не вижу, подключение из России на моих точках устанавливается.</p></td><td>2023-05-18T14:45:52.574Z</td></tr><tr><td>ptath</td><td><p>Спасибо за участие. Я проверяю, но толку? Неизвестно же что там должно быть ) Подключение устанавливается, но что-то либо с портом, либо с сертификатом. Порт вроде такой же как у любого imap (google/yandex почты работают), сертификаты для почты для меня темный лес.</p>
<p>С включенным vpn:</p>
<pre><code class="lang-auto">Server:		192.168.2.1
Address:	192.168.2.1#53

Non-authoritative answer:
p71-imap.mail.me.com	canonical name = p71-imap.mail.me.com.akadns.net.
p71-imap.mail.me.com.akadns.net	canonical name = imap.mail.me.com.akadns.net.
Name:	imap.mail.me.com.akadns.net
Address: 17.57.155.26
</code></pre>
<p>Без него: то же самое абсолютно =)</p>
<p>Стоит отметить, что если я (при живом OVPN на рутере) включаю на ноуте впн до своего сервера (в тех же Нидерландах), все <em>мгновенно</em> начинает работать. Там используется 8.8.8.8, резолвится так же, только днс-сервер другой</p>
<pre><code class="lang-auto">Server:		8.8.8.8
Address:	8.8.8.8#53

Non-authoritative answer:
p71-imap.mail.me.com	canonical name = p71-imap.mail.me.com.akadns.net.
p71-imap.mail.me.com.akadns.net	canonical name = imap.mail.me.com.akadns.net.
Name:	imap.mail.me.com.akadns.net
Address: 17.57.155.26
</code></pre>
<p>Это мистика какая-то =) Повторюсь, так на всех apple устройствах и с разными аккаунтами, то есть у кого-то не p71- например, а другой.</p>
<p>Нырнул в темный лес:</p>
<details>
<summary>
Вот что показывает при выключенном OVPN:</summary>
<pre><code class="lang-auto">ptath@MacBook-Air-ptath ~ % openssl s_client -showcerts -connect p71-imap.mail.me.com.akadns.net:993

CONNECTED(00000005)
depth=2 C = GB, ST = Greater Manchester, L = Salford, O = Comodo CA Limited, CN = AAA Certificate Services
verify return:1
depth=1 CN = Apple Public Server RSA CA 12 - G1, O = Apple Inc., ST = California, C = US
verify return:1
depth=0 CN = imap.mail.me.com, O = Apple Inc., ST = California, C = US
verify return:1
write W BLOCK
---
Certificate chain
0 s:/CN=imap.mail.me.com/O=Apple Inc./ST=California/C=US
i:/CN=Apple Public Server RSA CA 12 - G1/O=Apple Inc./ST=California/C=US
-----BEGIN CERTIFICATE-----
MIIP+TCCDuGgAwIBAgIQAe775REUTGIp6nO1d0sjwjANBgkqhkiG9w0BAQsFADBk
...
6UkGy13BreTiCUCTMg==
-----END CERTIFICATE-----
1 s:/CN=Apple Public Server RSA CA 12 - G1/O=Apple Inc./ST=California/C=US
i:/C=GB/ST=Greater Manchester/L=Salford/O=Comodo CA Limited/CN=AAA Certificate Services
-----BEGIN CERTIFICATE-----
MIIEkDCCA3igAwIBAgIQCuSPIwEwZEGSWeHCmumNGDANBgkqhkiG9w0BAQsFADB7
...
6IoOvOR7UaKo39qnYwA6Fs0F0to=
-----END CERTIFICATE-----
2 s:/C=GB/ST=Greater Manchester/L=Salford/O=Comodo CA Limited/CN=AAA Certificate Services
i:/C=GB/ST=Greater Manchester/L=Salford/O=Comodo CA Limited/CN=AAA Certificate Services
-----BEGIN CERTIFICATE-----
MIIEMjCCAxqgAwIBAgIBATANBgkqhkiG9w0BAQUFADB7MQswCQYDVQQGEwJHQjEb
...
smPi9WIsgtRqAEFQ8TmDn5XpNpaYbg==
-----END CERTIFICATE-----
---
Server certificate
subject=/CN=imap.mail.me.com/O=Apple Inc./ST=California/C=US
issuer=/CN=Apple Public Server RSA CA 12 - G1/O=Apple Inc./ST=California/C=US
---
No client certificate CA names sent
Server Temp Key: ECDH, X25519, 253 bits
---
SSL handshake has read 6909 bytes and written 367 bytes
---
New, TLSv1/SSLv3, Cipher is AEAD-AES256-GCM-SHA384
Server public key is 2048 bit
Secure Renegotiation IS NOT supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
Protocol : TLSv1.3
Cipher : AEAD-AES256-GCM-SHA384
Session-ID:
Session-ID-ctx:
Master-Key:
Start Time: 1684424832
Timeout : 7200 (sec)
Verify return code: 0 (ok)
---
read R BLOCK
read R BLOCK
* OK [CAPABILITY XAPPLEPUSHSERVICE IMAP4 IMAP4rev1 SASL-IR AUTH=ATOKEN AUTH=PLAIN] (23-SKIPPED-ab) qs-SKIPPED-1.me.com
</code></pre>
<p>и тут консоль от меня что-то ждет, но я умею только ctrl+c</p>
</details>
<details>
<summary>
При включенном:</summary>
<pre><code class="lang-auto">ptath@MacBook-Air-ptath ~ % openssl s_client -showcerts -connect p71-imap.mail.me.com.akadns.net:993
CONNECTED(00000005)
depth=2 C = GB, ST = Greater Manchester, L = Salford, O = Comodo CA Limited, CN = AAA Certificate Services
verify return:1
depth=1 CN = Apple Public Server RSA CA 12 - G1, O = Apple Inc., ST = California, C = US
verify return:1
depth=0 CN = imap.mail.me.com, O = Apple Inc., ST = California, C = US
verify return:1
write W BLOCK
---
Certificate chain
 0 s:/CN=imap.mail.me.com/O=Apple Inc./ST=California/C=US
   i:/CN=Apple Public Server RSA CA 12 - G1/O=Apple Inc./ST=California/C=US
-----BEGIN CERTIFICATE-----
MIIP+TCCDuGgAwIBAgIQAe775REUTGIp6nO1d0sjwjANBgkqhkiG9w0BAQsFADBk
...
qi8l+ZiTWs7PWJxYQo8c2IlFMbLeS6fa+qlrJaQyrlByzMfHnMNXh0lMZrj/F0IJ
6UkGy13BreTiCUCTMg==
-----END CERTIFICATE-----
 1 s:/CN=Apple Public Server RSA CA 12 - G1/O=Apple Inc./ST=California/C=US
   i:/C=GB/ST=Greater Manchester/L=Salford/O=Comodo CA Limited/CN=AAA Certificate Services
-----BEGIN CERTIFICATE-----
MIIEkDCCA3igAwIBAgIQCuSPIwEwZEGSWeHCmumNGDANBgkqhkiG9w0BAQsFADB7
...
6IoOvOR7UaKo39qnYwA6Fs0F0to=
-----END CERTIFICATE-----
 2 s:/C=GB/ST=Greater Manchester/L=Salford/O=Comodo CA Limited/CN=AAA Certificate Services
   i:/C=GB/ST=Greater Manchester/L=Salford/O=Comodo CA Limited/CN=AAA Certificate Services
-----BEGIN CERTIFICATE-----
MIIEMjCCAxqgAwIBAgIBATANBgkqhkiG9w0BAQUFADB7MQswCQYDVQQGEwJHQjEb
...
smPi9WIsgtRqAEFQ8TmDn5XpNpaYbg==
-----END CERTIFICATE-----
---
Server certificate
subject=/CN=imap.mail.me.com/O=Apple Inc./ST=California/C=US
issuer=/CN=Apple Public Server RSA CA 12 - G1/O=Apple Inc./ST=California/C=US
---
No client certificate CA names sent
Server Temp Key: ECDH, X25519, 253 bits
---
SSL handshake has read 6909 bytes and written 367 bytes
---
New, TLSv1/SSLv3, Cipher is AEAD-AES256-GCM-SHA384
Server public key is 2048 bit
Secure Renegotiation IS NOT supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : AEAD-AES256-GCM-SHA384
    Session-ID: 
    Session-ID-ctx: 
    Master-Key: 
    Start Time: 1684425091
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
---
read:errno=54
</code></pre>
<p>И выполнение завершается</p>
</details>
<p>Как это интерпретировать я не знаю, почему оно так — тоже. Разница исключительно в последнем сегменте.</p></td><td>2023-05-18T16:03:50.181Z</td></tr><tr><td>ValdikSS</td><td><p>Попробуйте</p>
<p><code>openssl s_client -showcerts -connect 17.57.155.26:993 -servername imap.mail.me.com.akadns.net</code></p>
<p>С VPN и без.</p></td><td>2023-05-18T16:23:52.187Z</td></tr>
    </table>
      </body>
    </html>